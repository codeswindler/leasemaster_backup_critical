import{b as ee,d as x,u as se,f as ae,j as e,C as b,z as y,A as v,x as d,E as S,G as w,av as te,aw as ne,ax as le,y as h,K as M,S as ie,r as ce,s as de,v as re,w as P,a6 as E,a2 as F,a7 as me,I as oe,a4 as ue,az as xe,aF as L,a0 as r,q as U}from"./index-BtknkMaH.js";import{r as T}from"./vendor-Dl_IvdXv.js";import{T as z,a as K,b as k,c as C}from"./tabs-_ak9GdYN.js";function fe(){const[c,m]=T.useState([]),[p,_]=T.useState("email"),[R,I]=T.useState(""),[j,A]=T.useState(""),{selectedPropertyId:n,selectedLandlordId:l}=ee(),{data:O=[]}=x({queryKey:["/api/tenants",n,l],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),l&&s.append("landlordId",l);const a=`/api/tenants${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),{data:G=[]}=x({queryKey:["/api/units",n,l],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),l&&s.append("landlordId",l);const a=`/api/units${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),{data:B=[]}=x({queryKey:["/api/leases",n,l],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),l&&s.append("landlordId",l);const a=`/api/leases${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),o=O.map(s=>{const a=B.find(i=>i.tenantId===s.id&&i.status==="active"),t=G.find(i=>i.id===a?.unitId);return{id:s.id,name:s.fullName,email:s.email,phone:s.phone,unit:t?.unitNumber||"No unit"}}).filter(s=>s.name&&s.email),{data:q=[]}=x({queryKey:["/api/bulk-messages",n,l],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),l&&s.append("landlordId",l);const a=`/api/bulk-messages${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),{data:g=[]}=x({queryKey:["/api/message-recipients"]}),[,D]=se(),Q=[{id:"rent-reminder",name:"Rent Payment Reminder",subject:"Monthly Rent Payment Due",message:`Dear {tenant_name},

This is a friendly reminder that your monthly rent payment of {amount} for unit {unit} is due on {due_date}.

Please make your payment via M-Pesa Paybill: 123456
Account Number: {account_number}

Thank you.`},{id:"maintenance",name:"Maintenance Notice",subject:"Scheduled Maintenance - {property_name}",message:`Dear {tenant_name},

We will be conducting scheduled maintenance on {date} from {time}.

Please expect temporary disruption to:
- Water supply
- Electricity

We apologize for any inconvenience.

Management`}],V=(s,a)=>{m(a?[...c,s]:c.filter(t=>t!==s))},W=()=>{m(o.map(s=>s.id))},H=()=>{m([])},J=ae({mutationFn:async s=>{const t=await(await r("POST","/api/bulk-messages",{messageType:s.type,subject:s.subject,content:s.message,totalRecipients:s.recipients.length})).json(),i=s.recipients.map(u=>{const f=o.find(N=>N.id===u);return f?(s.type==="both"?["email","sms"]:[s.type]).map(N=>{const Z=N==="email"?f.email:f.phone;return r("POST","/api/message-recipients",{bulkMessageId:t.id,tenantId:f.id,channel:N,recipientContact:Z,status:"sent"})}):null}).flat().filter(Boolean);return await Promise.all(i),t},onSuccess:()=>{U.invalidateQueries({queryKey:["/api/bulk-messages"]}),U.invalidateQueries({queryKey:["/api/message-recipients"]}),m([]),I(""),A(""),alert("Message sent successfully!")},onError:s=>{console.error("Failed to send message:",s),alert("Failed to send message. Please try again.")}}),X=()=>{c.length===0||!j.trim()||J.mutate({recipients:c,type:p,subject:R,message:j})},Y=s=>{I(s.subject),A(s.message)},$=s=>{switch(s){case"delivered":return e.jsx(h,{variant:"default",className:"bg-green-100 text-green-800",children:"Delivered"});case"pending":return e.jsx(h,{variant:"secondary",children:"Pending"});case"failed":return e.jsx(h,{variant:"destructive",children:"Failed"});default:return e.jsx(h,{variant:"outline",children:"Unknown"})}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"messaging-title",children:"Messaging"}),e.jsx("p",{className:"text-muted-foreground",children:"Communicate with your tenants via email and SMS"})]}),e.jsxs(z,{defaultValue:"compose",className:"space-y-6",children:[e.jsxs(K,{className:"grid w-full grid-cols-2",children:[e.jsx(k,{value:"compose","data-testid":"tab-compose",children:"Compose Message"}),e.jsx(k,{value:"outbox","data-testid":"tab-outbox",children:"Outbox"})]}),e.jsx(C,{value:"compose",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(b,{children:[e.jsxs(y,{children:[e.jsxs(v,{className:"flex items-center justify-between",children:["Recipients",e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:W,"data-testid":"button-select-all",children:"All"}),e.jsx(d,{variant:"outline",size:"sm",onClick:H,"data-testid":"button-select-none",children:"None"})]})]}),e.jsx(S,{children:"Select tenants to send message to"})]}),e.jsxs(w,{className:"space-y-3",children:[o.map(s=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(te,{id:s.id,checked:c.includes(s.id),onCheckedChange:a=>V(s.id,!!a),"data-testid":`checkbox-tenant-${s.id}`}),e.jsx(ne,{className:"h-8 w-8",children:e.jsx(le,{className:"text-xs",children:s.name.split(" ").map(a=>a[0]).join("")})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.unit})]})]},s.id)),c.length>0&&e.jsx("div",{className:"pt-3 border-t",children:e.jsxs(h,{variant:"secondary",children:[c.length," selected"]})})]})]}),e.jsxs(b,{className:"lg:col-span-2",children:[e.jsxs(y,{children:[e.jsx(v,{children:"Message Details"}),e.jsx(S,{children:"Compose your message"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Message Type"}),e.jsxs(ie,{value:p,onValueChange:s=>_(s),children:[e.jsx(ce,{"data-testid":"select-message-type",children:e.jsx(de,{})}),e.jsxs(re,{children:[e.jsx(P,{value:"email",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4"}),"Email Only"]})}),e.jsx(P,{value:"sms",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"SMS Only"]})}),e.jsx(P,{value:"both",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),"Email & SMS"]})})]})]})]}),(p==="email"||p==="both")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"subject",children:"Subject"}),e.jsx(oe,{id:"subject",placeholder:"Enter email subject",value:R,onChange:s=>I(s.target.value),"data-testid":"input-subject"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"message",children:"Message"}),e.jsx(ue,{id:"message",placeholder:"Type your message here...",value:j,onChange:s=>A(s.target.value),rows:8,"data-testid":"textarea-message"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Use placeholders: ","{tenant_name}",", ","{unit}",", ","{amount}",", ","{due_date}",", ","{account_number}"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Quick Templates"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:Q.map(s=>e.jsx(d,{variant:"outline",size:"sm",onClick:()=>Y(s),"data-testid":`button-template-${s.id}`,children:s.name},s.id))})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(d,{variant:"outline",children:"Save Draft"}),e.jsxs(d,{onClick:X,disabled:c.length===0||!j.trim(),"data-testid":"button-send-message",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Send Message"]})]})]})]})]})}),e.jsx(C,{value:"outbox",className:"space-y-6",children:e.jsxs(z,{defaultValue:"sms",className:"space-y-4",children:[e.jsxs(K,{className:"grid w-full grid-cols-2",children:[e.jsx(k,{value:"sms","data-testid":"tab-sms-outbox",children:"SMS Outbox"}),e.jsx(k,{value:"email","data-testid":"tab-email-outbox",children:"Email Outbox"})]}),e.jsx(C,{value:"sms",children:e.jsxs(b,{children:[e.jsxs(y,{children:[e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5"}),"SMS Messages"]}),e.jsx(S,{children:"Track SMS delivery status and timing"})]}),e.jsx(w,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2 font-medium",children:"ID"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Contact"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Message"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Time Sent"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Status"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"TAT"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Actions"})]})}),e.jsxs("tbody",{children:[g.filter(s=>s.channel==="sms").map(s=>{const a=q.find(u=>u.id===s.bulkMessageId),t=o.find(u=>u.id===s.tenantId),i=s.deliveredAt&&s.sentAt?`${Math.round((new Date(s.deliveredAt).getTime()-new Date(s.sentAt).getTime())/1e3)}s`:"-";return e.jsxs("tr",{className:"border-b hover-elevate",children:[e.jsx("td",{className:"p-2 text-sm font-mono",children:s.id.substring(0,8)}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:t?.name||"Unknown"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.recipientContact})]})}),e.jsx("td",{className:"p-2 max-w-xs",children:e.jsx("p",{className:"text-sm truncate",title:a?.content,children:a?.content||"N/A"})}),e.jsx("td",{className:"p-2 text-sm",children:s.sentAt?new Date(s.sentAt).toLocaleString():"Pending"}),e.jsx("td",{className:"p-2",children:$(s.status)}),e.jsx("td",{className:"p-2 text-sm font-mono",children:i}),e.jsx("td",{className:"p-2",children:e.jsx(d,{variant:"outline",size:"sm",onClick:()=>D(`/message-details/${s.id}`),"data-testid":`button-view-sms-${s.id}`,children:e.jsx(L,{className:"h-3 w-3"})})})]},s.id)}),g.filter(s=>s.channel==="sms").length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-8 text-center text-muted-foreground",children:"No SMS messages sent yet"})})]})]})})})]})}),e.jsx(C,{value:"email",children:e.jsxs(b,{children:[e.jsxs(y,{children:[e.jsxs(v,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-5 w-5"}),"Email Messages"]}),e.jsx(S,{children:"Track email delivery status"})]}),e.jsx(w,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2 font-medium",children:"ID"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Sender"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Recipient"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Subject"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Time Sent"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Status"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Actions"})]})}),e.jsxs("tbody",{children:[g.filter(s=>s.channel==="email").map(s=>{const a=q.find(i=>i.id===s.bulkMessageId),t=o.find(i=>i.id===s.tenantId);return e.jsxs("tr",{className:"border-b hover-elevate",children:[e.jsx("td",{className:"p-2 text-sm font-mono",children:s.id.substring(0,8)}),e.jsx("td",{className:"p-2 text-sm",children:"system@rentflow.app"}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:t?.name||"Unknown"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.recipientContact})]})}),e.jsx("td",{className:"p-2 max-w-xs",children:e.jsx("p",{className:"text-sm truncate",title:a?.subject,children:a?.subject||"No Subject"})}),e.jsx("td",{className:"p-2 text-sm",children:s.sentAt?new Date(s.sentAt).toLocaleString():"Pending"}),e.jsx("td",{className:"p-2",children:$(s.status)}),e.jsx("td",{className:"p-2",children:e.jsx(d,{variant:"outline",size:"sm",onClick:()=>D(`/message-details/${s.id}`),"data-testid":`button-view-email-${s.id}`,children:e.jsx(L,{className:"h-3 w-3"})})})]},s.id)}),g.filter(s=>s.channel==="email").length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-8 text-center text-muted-foreground",children:"No email messages sent yet"})})]})]})})})]})})]})})]})]})}export{fe as Messaging};
