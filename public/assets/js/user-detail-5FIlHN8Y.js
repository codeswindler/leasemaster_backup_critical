import{av as X,u as Y,a as Z,d as L,f as g,j as e,x as m,a1 as ee,C as E,z as N,A as _,E as C,G as P,y as S,a6 as se,b0 as ie,a4 as O,K as U,aS as ae,a0 as c,q as x}from"./index-D3-Phv8z.js";import{r as p}from"./vendor-BBpupLJz.js";import{S as ne}from"./switch-n8er_Na6.js";const h=[{id:"dashboard",name:"Dashboard",permissions:[{id:"dashboard.view",name:"View dashboard"}]},{id:"properties",name:"Properties",permissions:[{id:"properties.view",name:"View properties"},{id:"properties.create",name:"Create properties"},{id:"properties.edit",name:"Edit properties"},{id:"properties.enable",name:"Enable properties"},{id:"properties.disable",name:"Disable properties"},{id:"properties.delete",name:"Delete properties"}]},{id:"landlords",name:"Landlords",permissions:[{id:"landlords.view",name:"View landlords"},{id:"landlords.create",name:"Create landlords"},{id:"landlords.edit",name:"Edit landlords"},{id:"landlords.delete",name:"Delete landlords"},{id:"landlords.send_login",name:"Send login details"}]},{id:"house_types",name:"House Types",permissions:[{id:"house_types.view",name:"View house types"},{id:"house_types.create",name:"Create house types"},{id:"house_types.edit",name:"Edit house types"},{id:"house_types.delete",name:"Delete house types"}]},{id:"units",name:"Units",permissions:[{id:"units.view",name:"View units"},{id:"units.create",name:"Create units"},{id:"units.edit",name:"Edit units"},{id:"units.delete",name:"Delete units"}]},{id:"tenants",name:"Tenants",permissions:[{id:"tenants.view",name:"View tenants"},{id:"tenants.create",name:"Create tenants"},{id:"tenants.edit",name:"Edit tenants"},{id:"tenants.delete",name:"Delete tenants"}]},{id:"tenant_portal",name:"Tenant Portal Access",permissions:[{id:"tenants.send_login",name:"Send tenant login details"},{id:"tenants.bulk_send_login",name:"Bulk send tenant logins"}]},{id:"leases",name:"Leases",permissions:[{id:"leases.view",name:"View leases"},{id:"leases.create",name:"Create leases"},{id:"leases.edit",name:"Edit leases"},{id:"leases.terminate",name:"Terminate leases"},{id:"leases.delete",name:"Delete leases"},{id:"leases.view_balance",name:"View lease balances"}]},{id:"invoices",name:"Invoices",permissions:[{id:"invoices.view",name:"View invoices"},{id:"invoices.create",name:"Create invoices"},{id:"invoices.edit",name:"Edit invoices"},{id:"invoices.approve",name:"Approve invoices"},{id:"invoices.send",name:"Send invoices"},{id:"invoices.generate",name:"Generate monthly invoices"},{id:"invoices.delete",name:"Delete invoices"}]},{id:"payments",name:"Payments & Receipts",permissions:[{id:"payments.view",name:"View payments"},{id:"payments.receive",name:"Receive payments"},{id:"payments.edit",name:"Edit payments"},{id:"payments.delete",name:"Delete payments"},{id:"payments.export_receipt",name:"Export receipts"}]},{id:"water_readings",name:"Water Readings",permissions:[{id:"water_readings.view",name:"View readings"},{id:"water_readings.create",name:"Record readings"},{id:"water_readings.edit",name:"Edit readings"},{id:"water_readings.delete",name:"Delete readings"},{id:"water_readings.bulk_entry",name:"Bulk entry"}]},{id:"charge_codes",name:"Charge Codes",permissions:[{id:"charge_codes.view",name:"View charge codes"},{id:"charge_codes.create",name:"Create charge codes"},{id:"charge_codes.edit",name:"Edit charge codes"},{id:"charge_codes.delete",name:"Delete charge codes"}]},{id:"messaging",name:"Messaging",permissions:[{id:"messaging.view",name:"View messages"},{id:"messaging.create",name:"Create messages"},{id:"messaging.edit",name:"Edit messages"},{id:"messaging.delete",name:"Delete messages"},{id:"messaging.send_sms",name:"Send SMS"},{id:"messaging.send_email",name:"Send email"},{id:"messaging.bulk_send",name:"Send bulk messages"},{id:"messaging.templates_manage",name:"Manage templates"},{id:"messaging.export",name:"Export message logs"}]},{id:"reports",name:"Reports",permissions:[{id:"reports.view",name:"View reports"},{id:"reports.export",name:"Export reports"}]},{id:"activity_logs",name:"Operational Log",permissions:[{id:"activity_logs.view",name:"View activity logs"}]},{id:"users",name:"User Management",permissions:[{id:"users.view",name:"View users"},{id:"users.create",name:"Create users"},{id:"users.edit",name:"Edit users"},{id:"users.disable",name:"Disable users"},{id:"users.delete",name:"Delete users"},{id:"users.manage_permissions",name:"Manage permissions"},{id:"users.send_login",name:"Send login details"},{id:"users.reset_password",name:"Reset passwords"},{id:"users.toggle_otp",name:"Toggle OTP"}]},{id:"settings",name:"System Settings",permissions:[{id:"settings.view",name:"View settings"},{id:"settings.edit",name:"Edit settings"},{id:"settings.sms_settings",name:"Manage SMS settings"}]},{id:"data_import",name:"Data Import",permissions:[{id:"data_import.upload",name:"Upload/import data"}]}],te={properties:["properties"],tenants:["tenants"],accounting:["invoices","payments"],reports:["reports"],messaging:["messaging"],users:["users"],settings:["settings"]};function le(){const[R,q]=X("/users/:id"),t=q?.id,[,F]=Y(),{toast:o}=Z(),[v,w]=p.useState([]),[T,K]=p.useState(Object.fromEntries(h.map(s=>[s.id,!0]))),[A,f]=p.useState(!0),[u,j]=p.useState(!0),{data:i,isLoading:$}=L({queryKey:["/api/users",t],queryFn:async()=>await(await c("GET",`/api/users/${t}`)).json(),enabled:!!t}),{data:k=[]}=L({queryKey:["/api/properties"]}),z=p.useMemo(()=>{const s=i?.property_id||i?.propertyId;return k.find(n=>n.id===s)?.name||"â€”"},[k,i]);p.useEffect(()=>{if(!i)return;let s=[];if(Array.isArray(i.permissions))s=i.permissions;else if(typeof i.permissions=="string"&&i.permissions.trim().length>0)try{const n=JSON.parse(i.permissions);Array.isArray(n)&&(s=n)}catch{s=[]}const a=new Set;s.forEach(n=>{const r=te[n];if(r){r.forEach(l=>{h.find(b=>b.id===l)?.permissions.forEach(b=>a.add(b.id))});return}const d=h.find(l=>l.id===n);d?d.permissions.forEach(l=>a.add(l.id)):a.add(n)}),w(Array.from(a)),typeof i.otp_enabled=="number"?f(i.otp_enabled===1):typeof i.otpEnabled=="boolean"&&f(i.otpEnabled),typeof i.alerts_enabled=="number"?j(i.alerts_enabled===1):typeof i.alertsEnabled=="boolean"&&j(i.alertsEnabled)},[i]);const D=g({mutationFn:async()=>await(await c("PUT",`/api/users/${t}`,{permissions:v})).json(),onSuccess:()=>{o({title:"Permissions updated"}),x.invalidateQueries({queryKey:["/api/users",t]})},onError:s=>{o({title:"Failed to update permissions",description:s?.message||"Unable to save permissions.",variant:"destructive"})}}),M=g({mutationFn:async()=>await(await c("POST",`/api/users/${t}/send-login-details`)).json(),onSuccess:s=>{o({title:"Login details sent",description:s?.generatedPassword?`Temporary password: ${s.generatedPassword}`:"Login details sent."}),x.invalidateQueries({queryKey:["/api/users",t]})},onError:s=>{o({title:"Failed to send login details",description:s?.message||"Unable to send login details.",variant:"destructive"})}}),V=g({mutationFn:async()=>await(await c("POST",`/api/users/${t}/reset-password`)).json(),onSuccess:s=>{o({title:"Password reset",description:s?.generatedPassword?`Temporary password: ${s.generatedPassword}`:"Password reset successfully."}),x.invalidateQueries({queryKey:["/api/users",t]})},onError:s=>{o({title:"Password reset failed",description:s?.message||"Unable to reset password.",variant:"destructive"})}}),I=g({mutationFn:async s=>await(await c("POST",`/api/users/${t}/otp`,{enabled:s})).json(),onSuccess:()=>{x.invalidateQueries({queryKey:["/api/users",t]})},onError:s=>{o({title:"OTP update failed",description:s?.message||"Unable to update OTP settings.",variant:"destructive"})}}),Q=g({mutationFn:async s=>await(await c("PUT",`/api/users/${t}`,{alertsEnabled:s})).json(),onSuccess:()=>{x.invalidateQueries({queryKey:["/api/users",t]}),o({title:"Alert preference saved",description:u?"Alerts enabled.":"Alerts disabled."})},onError:s=>{o({title:"Failed to update alerts",description:s?.message||"Unable to update alert preference.",variant:"destructive"})}}),B=s=>{w(a=>a.includes(s)?a.filter(n=>n!==s):[...a,s])},G=s=>{const a=h.find(d=>d.id===s);if(!a)return;const n=a.permissions.map(d=>d.id),r=n.every(d=>v.includes(d));w(d=>{if(r)return d.filter(y=>!n.includes(y));const l=new Set(d);return n.forEach(y=>l.add(y)),Array.from(l)})},H=s=>{K(a=>({...a,[s]:!a[s]}))},J=s=>{f(s),I.mutate(s)},W=()=>{const s=!u;j(s),Q.mutate(s)};return R?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs(m,{variant:"ghost",className:"pl-0",onClick:()=>F("/users"),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Back to users"]}),e.jsx("h1",{className:"text-3xl font-bold mt-2",children:"User Profile"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage access, permissions, and login actions"})]})}),e.jsxs(E,{children:[e.jsxs(N,{className:"flex flex-row items-start justify-between",children:[e.jsxs("div",{children:[e.jsx(_,{children:"User Overview"}),e.jsx(C,{children:"Account and property assignment"})]}),e.jsx(m,{variant:"outline",size:"sm",onClick:W,"aria-label":u?"Disable alerts":"Enable alerts",title:u?"Alerts enabled":"Alerts disabled",children:u?"ðŸ””":"ðŸ”• zzz"})]}),e.jsx(P,{children:$?e.jsx("div",{className:"text-muted-foreground",children:"Loading user..."}):i?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Name"}),e.jsx("div",{className:"text-lg font-semibold",children:i.full_name||i.fullName||i.username}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Username / Email"}),e.jsx("div",{children:i.username}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Role"}),e.jsx(S,{variant:"outline",children:i.role||"Administrator"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Property"}),e.jsx("div",{className:"text-lg font-semibold",children:z}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Status"}),e.jsx(S,{variant:"default",className:"bg-green-100 text-green-800",children:"Active"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Last Login"}),e.jsx("div",{children:i.last_login?new Date(i.last_login).toLocaleString():"â€”"})]})]}):e.jsx("div",{className:"text-muted-foreground",children:"User not found."})})]}),e.jsxs(E,{children:[e.jsxs(N,{children:[e.jsx(_,{children:"Account Actions"}),e.jsx(C,{children:"Send logins, reset password, and OTP controls"})]}),e.jsxs(P,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(m,{onClick:()=>M.mutate(),disabled:M.isPending,children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Send Logins"]}),e.jsxs(m,{variant:"outline",onClick:()=>V.mutate(),disabled:V.isPending,children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Reset Password"]})]}),e.jsxs("div",{className:"flex items-center justify-between border rounded-lg p-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium",children:"OTP"}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Toggle OTP for this user"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{variant:"outline",children:A?"Enabled":"Disabled"}),e.jsx(ne,{checked:A,onCheckedChange:J})]})]})]})]}),e.jsxs(E,{children:[e.jsxs(N,{children:[e.jsx(_,{children:"Permission Management"}),e.jsx(C,{children:"Manage access for this user"})]}),e.jsxs(P,{className:"space-y-4",children:[e.jsx("div",{className:"space-y-4",children:h.map(s=>{const n=s.permissions.map(r=>r.id).every(r=>v.includes(r));return e.jsxs("div",{className:"border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{checked:n,onCheckedChange:()=>G(s.id)}),e.jsx(U,{className:"text-sm font-medium",children:s.name})]}),e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>H(s.id),children:[T[s.id]?"Hide":"Show"," permissions"]})]}),T[s.id]&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 px-4 pb-4",children:s.permissions.map(r=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{checked:v.includes(r.id),onCheckedChange:()=>B(r.id)}),e.jsx(U,{className:"text-sm",children:r.name})]},r.id))})]},s.id)})}),e.jsx("div",{className:"flex justify-end gap-2",children:e.jsxs(m,{variant:"outline",onClick:()=>D.mutate(),disabled:D.isPending,children:[e.jsx(ae,{className:"h-4 w-4 mr-2"}),"Save Permissions"]})})]})]})]}):null}export{le as UserDetail};
