import{a as Ke,b as Oe,f as V,d as b,j as e,C as A,G as q,x as l,aa as de,a6 as le,a2 as oe,I as G,S as ce,r as he,s as ue,v as me,w as h,z as Ue,A as ze,av as xe,E as Me,ac as pe,ad as je,ae as K,af as u,ag as ve,ah as m,H as Qe,am as ge,az as fe,aj as Be,D as H,g as Y,h as W,i as Z,k as J,L as X,K as F,a4 as Re,a0 as j,q as O,y as L}from"./index-BtknkMaH.js";import{r as f,Y as Ve,Z as Ge}from"./vendor-Dl_IvdXv.js";import{D as Se}from"./download-ILkuwfnn.js";function Je(){const[$,ye]=f.useState(""),[C,_]=f.useState("all"),[o,E]=f.useState([]),[Ne,T]=f.useState(!1),[De,P]=f.useState(!1),[we,k]=f.useState(!1),[a,U]=f.useState(null),{toast:x}=Ke(),{selectedPropertyId:n,selectedLandlordId:i}=Oe(),z=V({mutationFn:async({invoiceId:s,data:t})=>await j("PUT",`/api/invoices/${s}`,t),onSuccess:()=>{O.invalidateQueries({queryKey:["/api/invoices"]}),O.invalidateQueries({queryKey:["/api/invoice-items"]}),x({title:"Invoice Updated",description:"Invoice has been successfully updated."}),P(!1)},onError:s=>{x({title:"Update Failed",description:"Failed to update invoice. Please try again.",variant:"destructive"})}}),M=V({mutationFn:async s=>await j("POST",`/api/invoices/${s}/send-email`),onSuccess:()=>{O.invalidateQueries({queryKey:["/api/invoices"]}),x({title:"Email Sent",description:`Invoice ${a?.id} has been sent via email.`}),k(!1)},onError:s=>{x({title:"Send Failed",description:"Failed to send email. Please try again.",variant:"destructive"})}}),Q=V({mutationFn:async s=>await j("POST",`/api/invoices/${s}/send-sms`),onSuccess:()=>{O.invalidateQueries({queryKey:["/api/invoices"]}),x({title:"SMS Sent",description:`Invoice ${a?.id} notification has been sent via SMS.`}),k(!1)},onError:s=>{x({title:"Send Failed",description:"Failed to send SMS. Please try again.",variant:"destructive"})}}),S=b({queryKey:["/api/invoices",n,i],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),i&&s.append("landlordId",i);const t=`/api/invoices${s.toString()?`?${s}`:""}`;return await(await j("GET",t)).json()}}),y=b({queryKey:["/api/invoice-items"]}),N=b({queryKey:["/api/tenants",n,i],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),i&&s.append("landlordId",i);const t=`/api/tenants${s.toString()?`?${s}`:""}`;return await(await j("GET",t)).json()}}),D=b({queryKey:["/api/units",n,i],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),i&&s.append("landlordId",i);const t=`/api/units${s.toString()?`?${s}`:""}`;return await(await j("GET",t)).json()}}),w=b({queryKey:["/api/properties",i,n],queryFn:async()=>{const s=new URLSearchParams;i&&s.append("landlordId",i),n&&s.append("propertyId",n);const t=`/api/properties${s.toString()?`?${s}`:""}`;return await(await j("GET",t)).json()}}),I=b({queryKey:["/api/leases",n,i],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("propertyId",n),i&&s.append("landlordId",i);const t=`/api/leases${s.toString()?`?${s}`:""}`;return await(await j("GET",t)).json()}}),ee=S.data||[],Ie=y.data||[],be=N.data||[],Le=D.data||[],Ce=w.data||[],Ee=I.data||[],se=[S.status==="success",y.status==="success",N.status==="success",D.status==="success",w.status==="success",I.status==="success"].every(Boolean),te=[S.isLoading,y.isLoading,N.isLoading,D.isLoading,w.isLoading,I.isLoading].some(Boolean);if([S.error,y.error,N.error,D.error,w.error,I.error].some(Boolean))return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"invoices-title",children:"Invoices"}),e.jsx("p",{className:"text-muted-foreground",children:"Error loading invoice data"})]})}),e.jsx(A,{children:e.jsx(q,{className:"p-6",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"text-destructive",children:"Failed to load invoice data"}),e.jsxs("div",{className:"text-sm",children:[S.error&&"â€¢ Invoices data failed",y.error&&"â€¢ Invoice items data failed",N.error&&"â€¢ Tenants data failed",D.error&&"â€¢ Units data failed",w.error&&"â€¢ Properties data failed",I.error&&"â€¢ Leases data failed"]})]})})})]});if(te||!se)return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"invoices-title",children:"Invoices"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading invoice data and related information..."})]})}),e.jsx(A,{children:e.jsx(q,{className:"p-6",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{children:"Loading invoices data..."}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[S.isLoading&&"â€¢ Loading invoices...",y.isLoading&&"â€¢ Loading invoice items...",N.isLoading&&"â€¢ Loading tenants...",D.isLoading&&"â€¢ Loading units...",w.isLoading&&"â€¢ Loading properties...",I.isLoading&&"â€¢ Loading leases...",!te&&!se&&"â€¢ Waiting for all data to be ready..."]})]})})})]});const p=Array.isArray(ee)?ee.map(s=>{const t=Ee.find(d=>d.id===s.leaseId),r=t&&t.tenantId?be.find(d=>d.id===t.tenantId):null,c=t&&t.unitId?Le.find(d=>d.id===t.unitId):null,g=c&&c.propertyId?Ce.find(d=>d.id===c.propertyId):null,R=Ie.filter(d=>d.invoiceId===s.id);return{...s,tenant:r?.fullName||"Direct Billing",unit:c?.unitNumber||"N/A",property:g?.name||"N/A",tenantData:r,unitData:c,propertyData:g,leaseData:t,charges:R.map(d=>({name:d.description,amount:parseFloat(d.amount)}))}}):[],v=p.filter(s=>{const t=$.toLowerCase(),r=!$||(s.id||"").toLowerCase().includes(t)||(s.tenant||"").toLowerCase().includes(t)||(s.unit||"").toLowerCase().includes(t)||(s.property||"").toLowerCase().includes(t),c=C==="all"||s.status===C;return r&&c}),Fe=s=>{U(s),T(!0)},ae=s=>{U(s),P(!0)},ne=s=>{U(s),k(!0)},ie=s=>{try{const t=new Ve;t.setFontSize(20),t.text("INVOICE",20,30),t.setFontSize(12),t.text(`Invoice ID: ${s.id}`,20,50),t.text(`Date: ${new Date(s.createdAt||Date.now()).toLocaleDateString()}`,20,60),t.text(`Due Date: ${new Date(s.dueDate).toLocaleDateString()}`,20,70),t.text(`Status: ${s.status.toUpperCase()}`,20,80),t.text("BILL TO:",20,100),t.text(`${s.tenant}`,20,110),s.tenantData?.email&&t.text(`${s.tenantData.email}`,20,120),s.tenantData?.phone&&t.text(`${s.tenantData.phone}`,20,130),t.text("PROPERTY:",120,100),t.text(`${s.property}`,120,110),t.text(`Unit: ${s.unit}`,120,120);const r=s.charges.map(g=>[g.name,`KSh ${g.amount.toLocaleString()}`]);Ge(t,{head:[["Description","Amount"]],body:r,startY:150,theme:"striped"});const c=t.lastAutoTable?.finalY||200;t.setFontSize(14),t.text(`TOTAL: KSh ${s.amount.toLocaleString()}`,20,c+20),t.save(`invoice-${s.id}.pdf`),x({title:"Invoice Downloaded",description:`Invoice ${s.id} has been downloaded as PDF.`})}catch(t){console.error("Error generating PDF:",t),x({title:"Download Failed",description:"Failed to generate PDF. Please try again.",variant:"destructive"})}},$e=async s=>{M.mutate(s.id)},Te=async s=>{Q.mutate(s.id)},Pe=s=>{const t=document.getElementById("edit-invoice-form");if(!t){console.error("ðŸ”§ Frontend: Form not found!");return}const r=t.querySelector('[name="description"]'),c=t.querySelector('[name="amount"]'),g=t.querySelector('[name="dueDate"]'),R=t.querySelector('[name="status"]'),d={description:r?.value||s.description,amount:String(c?.value||s.amount),dueDate:g?.value||s.dueDate,status:R?.value||s.status};console.log("ðŸ”§ Frontend: Sending update data:",d),console.log("ðŸ”§ Frontend: Invoice ID:",s.id),z.mutate({invoiceId:s.id,data:d})},ke=(s,t)=>{E(t?[...o,s]:o.filter(r=>r!==s))},Ae=()=>{o.length===v.length?E([]):E(v.map(s=>s.id))},B=s=>{switch(console.log(`Performing ${s} on invoices:`,o),s){case"approve":alert(`${o.length} invoices approved!`);break;case"send-email":alert(`Email sent for ${o.length} invoices!`);break;case"send-sms":alert(`SMS sent for ${o.length} invoices!`);break}E([])},re=s=>{switch(s){case"draft":return e.jsx(L,{variant:"secondary",children:"Draft"});case"approved":return e.jsx(L,{variant:"default",children:"Approved"});case"sent":return e.jsx(L,{variant:"outline",children:"Sent"});case"paid":return e.jsx(L,{variant:"default",className:"bg-green-100 text-green-800",children:"Paid"});case"overdue":return e.jsx(L,{variant:"destructive",children:"Overdue"});default:return e.jsx(L,{variant:"outline",children:"Unknown"})}},qe={all:p.length,draft:p.filter(s=>s.status==="draft").length,approved:p.filter(s=>s.status==="approved").length,sent:p.filter(s=>s.status==="sent").length,paid:p.filter(s=>s.status==="paid").length,overdue:p.filter(s=>s.status==="overdue").length};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"invoices-title",children:"Invoices"}),e.jsx("p",{className:"text-muted-foreground",children:"Review, approve and send invoices to tenants"})]}),o.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>B("approve"),"data-testid":"button-bulk-approve",children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Approve (",o.length,")"]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>B("send-email"),"data-testid":"button-bulk-email",children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),"Email"]}),e.jsxs(l,{variant:"outline",size:"sm",onClick:()=>B("send-sms"),"data-testid":"button-bulk-sms",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"SMS"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4",children:Object.entries(qe).map(([s,t])=>e.jsx(A,{className:`cursor-pointer hover-elevate ${C===s?"ring-2 ring-primary":""}`,onClick:()=>_(s),children:e.jsxs(q,{className:"p-4 text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:t}),e.jsx("div",{className:"text-sm text-muted-foreground capitalize",children:s==="all"?"Total":s})]})},s))}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(G,{placeholder:"Search invoices...",value:$,onChange:s=>ye(s.target.value),className:"max-w-sm","data-testid":"input-search-invoices"})}),e.jsxs(ce,{value:C,onValueChange:_,children:[e.jsx(he,{className:"w-48","data-testid":"select-status-filter",children:e.jsx(ue,{placeholder:"Filter by status"})}),e.jsxs(me,{children:[e.jsx(h,{value:"all",children:"All Statuses"}),e.jsx(h,{value:"draft",children:"Draft"}),e.jsx(h,{value:"approved",children:"Approved"}),e.jsx(h,{value:"sent",children:"Sent"}),e.jsx(h,{value:"paid",children:"Paid"}),e.jsx(h,{value:"overdue",children:"Overdue"})]})]})]}),e.jsxs(A,{children:[e.jsxs(Ue,{children:[e.jsxs(ze,{className:"flex items-center justify-between",children:["Invoices List",e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{checked:o.length===v.length&&v.length>0,onCheckedChange:Ae,"data-testid":"checkbox-select-all"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Select All"})]})]}),e.jsxs(Me,{children:["Showing ",v.length," of ",p.length," invoices"]})]}),e.jsxs(q,{children:[e.jsxs(pe,{children:[e.jsx(je,{children:e.jsxs(K,{children:[e.jsx(u,{className:"w-12"}),e.jsx(u,{children:"Invoice ID"}),e.jsx(u,{children:"Tenant"}),e.jsx(u,{children:"Unit"}),e.jsx(u,{children:"Property"}),e.jsx(u,{children:"Amount"}),e.jsx(u,{children:"Due Date"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Actions"})]})}),e.jsx(ve,{children:v.map(s=>e.jsxs(K,{className:"hover-elevate",children:[e.jsx(m,{children:e.jsx(xe,{checked:o.includes(s.id),onCheckedChange:t=>ke(s.id,!!t),"data-testid":`checkbox-${s.id}`})}),e.jsx(m,{className:"font-mono text-sm",children:s.id}),e.jsx(m,{className:"font-medium",children:s.tenant}),e.jsx(m,{children:s.unit}),e.jsx(m,{className:"text-sm text-muted-foreground",children:s.property}),e.jsxs(m,{className:"font-mono",children:["KSh ",s.amount.toLocaleString()]}),e.jsx(m,{children:new Date(s.dueDate).toLocaleDateString()}),e.jsx(m,{children:re(s.status)}),e.jsx(m,{children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>Fe(s),"data-testid":`button-view-${s.id}`,children:e.jsx(Qe,{className:"h-4 w-4"})}),s.status==="draft"&&e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>ae(s),"data-testid":`button-edit-${s.id}`,children:e.jsx(ge,{className:"h-4 w-4"})}),(s.status==="approved"||s.status==="draft")&&e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>ne(s),"data-testid":`button-send-${s.id}`,children:e.jsx(fe,{className:"h-4 w-4"})}),e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>ie(s),"data-testid":`button-download-${s.id}`,children:e.jsx(Se,{className:"h-4 w-4"})})]})})]},s.id))})]}),v.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Be,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No invoices found"}),e.jsx("p",{className:"text-muted-foreground",children:$||C!=="all"?"Try adjusting your search or filter criteria":"Create your first invoice to get started"})]})]})]}),e.jsx(H,{open:Ne,onOpenChange:T,children:e.jsxs(Y,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(W,{children:[e.jsx(Z,{children:"Invoice Details"}),e.jsxs(J,{children:["Complete details for invoice ",a?.id]})]}),a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Invoice Information"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Invoice ID:"})," ",a.id]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Date:"})," ",new Date(a.createdAt||Date.now()).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Due Date:"})," ",new Date(a.dueDate).toLocaleDateString()]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",re(a.status)]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Tenant Information"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Name:"})," ",a.tenant]}),a.tenantData?.email&&e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",a.tenantData.email]}),a.tenantData?.phone&&e.jsxs("div",{children:[e.jsx("strong",{children:"Phone:"})," ",a.tenantData.phone]})]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Property Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Property:"})," ",a.property]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Unit:"})," ",a.unit]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"Charges"}),e.jsxs(pe,{children:[e.jsx(je,{children:e.jsxs(K,{children:[e.jsx(u,{children:"Description"}),e.jsx(u,{className:"text-right",children:"Amount"})]})}),e.jsx(ve,{children:a.charges.map((s,t)=>e.jsxs(K,{children:[e.jsx(m,{children:s.name}),e.jsxs(m,{className:"text-right font-mono",children:["KSh ",s.amount.toLocaleString()]})]},t))})]}),e.jsxs("div",{className:"text-right mt-4 text-lg font-semibold",children:["Total: KSh ",a.amount.toLocaleString()]})]}),e.jsxs("div",{className:"flex gap-2 pt-4 border-t",children:[e.jsxs(l,{onClick:()=>ie(a),children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Download PDF"]}),(a.status==="approved"||a.status==="draft")&&e.jsxs(l,{variant:"outline",onClick:()=>{T(!1),ne(a)},children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Send Invoice"]}),a.status==="draft"&&e.jsxs(l,{variant:"outline",onClick:()=>{T(!1),ae(a)},children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Edit Invoice"]})]})]})]})}),e.jsx(H,{open:we,onOpenChange:k,children:e.jsxs(Y,{children:[e.jsxs(W,{children:[e.jsx(Z,{children:"Send Invoice"}),e.jsxs(J,{children:["Send invoice ",a?.id," to ",a?.tenant]})]}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Invoice will be sent to:",e.jsxs("div",{className:"mt-2 p-3 bg-muted rounded",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Tenant:"})," ",a.tenant]}),a.tenantData?.email&&e.jsxs("div",{children:[e.jsx("strong",{children:"Email:"})," ",a.tenantData.email]}),a.tenantData?.phone&&e.jsxs("div",{children:[e.jsx("strong",{children:"Phone:"})," ",a.tenantData.phone]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Amount:"})," KSh ",a.amount.toLocaleString()]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(l,{onClick:()=>$e(a),className:"flex-1",disabled:M.isPending,children:[M.isPending?e.jsx(X,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(le,{className:"h-4 w-4 mr-2"}),"Send via Email"]}),e.jsxs(l,{onClick:()=>Te(a),variant:"outline",className:"flex-1",disabled:Q.isPending,children:[Q.isPending?e.jsx(X,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Send via SMS"]})]})]})]})}),e.jsx(H,{open:De,onOpenChange:P,children:e.jsxs(Y,{className:"max-w-2xl",children:[e.jsxs(W,{children:[e.jsx(Z,{children:"Edit Invoice"}),e.jsxs(J,{children:["Edit invoice ",a?.id]})]}),a&&e.jsxs("form",{id:"edit-invoice-form",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"description",children:"Description"}),e.jsx(Re,{id:"description",name:"description",defaultValue:a.description,className:"min-h-20"})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"amount",children:"Amount (KSh)"}),e.jsx(G,{id:"amount",name:"amount",type:"number",step:"0.01",defaultValue:a.amount})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"dueDate",children:"Due Date"}),e.jsx(G,{id:"dueDate",name:"dueDate",type:"date",defaultValue:a.dueDate})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"status",children:"Status"}),e.jsxs(ce,{name:"status",defaultValue:a.status,children:[e.jsx(he,{children:e.jsx(ue,{})}),e.jsxs(me,{children:[e.jsx(h,{value:"draft",children:"Draft"}),e.jsx(h,{value:"approved",children:"Approved"}),e.jsx(h,{value:"sent",children:"Sent"}),e.jsx(h,{value:"paid",children:"Paid"}),e.jsx(h,{value:"overdue",children:"Overdue"})]})]})]})]}),e.jsxs("div",{children:[e.jsx(F,{children:"Current Charges"}),e.jsxs("div",{className:"mt-2 p-3 bg-muted rounded text-sm",children:[a.charges.map((s,t)=>e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:s.name}),e.jsxs("span",{children:["KSh ",s.amount.toLocaleString()]})]},t)),e.jsxs("div",{className:"border-t pt-2 mt-2 font-semibold flex justify-between",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["KSh ",a.amount.toLocaleString()]})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"To modify charges, use the invoice items management section."})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(l,{type:"button",onClick:()=>Pe(a),disabled:z.isPending,children:[z.isPending?e.jsx(X,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(de,{className:"h-4 w-4 mr-2"}),"Save Changes"]}),e.jsx(l,{type:"button",variant:"outline",onClick:()=>P(!1),children:"Cancel"})]})]})]})})]})}export{Je as Invoices};
