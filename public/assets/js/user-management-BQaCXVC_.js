import{c as se,a as ae,b as ie,u as ne,d as U,f as te,j as e,C as P,z,A as R,E as F,D as re,aj as de,x as g,P as oe,g as le,h as ce,i as me,k as pe,K as l,I as A,S as $,r as q,s as B,v as G,w as d,a4 as H,aR as ue,H as ge,G as he,aa as xe,ab as je,ac as b,ad as j,ae as ve,af as m,y as o,al as fe,aS as we,a0 as C,q as ye}from"./index-D3-Phv8z.js";import{r as E}from"./vendor-BBpupLJz.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=se("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]);function Ne(){const[O,S]=E.useState(!1),[v,W]=E.useState(!1),{toast:_}=ae(),{selectedPropertyId:p,selectedLandlordId:h}=ie(),[,T]=ne(),D=!!h&&h!=="all",N=!!p&&p!=="all",M=!N,[r,c]=E.useState({name:"",email:"",role:"",password:"",permissions:[],region:"Africa/Nairobi",timezone:"Africa/Nairobi"}),{data:K}=U({queryKey:["/api/auth/check"],queryFn:async()=>await(await C("GET","/api/auth/check")).json()}),f=(K?.user?.role||"").toLowerCase(),k=f==="admin"||f==="super_admin"||f==="administrator",{data:I=[],isLoading:J}=U({queryKey:["/api/users",p,h,f],queryFn:async()=>{const s=new URLSearchParams;p&&p!=="all"&&s.append("propertyId",p),h&&h!=="all"&&s.append("landlordId",h);const a=`/api/users${s.toString()?`?${s}`:""}`;return await(await C("GET",a)).json()},enabled:k||D||N}),L=I.map(s=>{let a=[];if(Array.isArray(s.permissions))a=s.permissions;else if(typeof s.permissions=="string"&&s.permissions.trim().length>0)try{const t=JSON.parse(s.permissions);Array.isArray(t)&&(a=t)}catch{a=[]}const i=s.last_login||s.lastLogin;return{id:s.id,name:s.full_name||s.fullName||s.username,email:s.email||s.username,role:s.role||"Administrator",status:s.status===0||s.status==="inactive"?"inactive":"active",lastLogin:i?new Date(i).toLocaleString():"â€”",permissions:a}}),x=[{id:"dashboard",name:"Dashboard",description:"View high-level metrics and summaries",permissions:[{id:"dashboard.view",name:"View dashboard"}]},{id:"properties",name:"Properties",description:"Create, edit, and manage properties",permissions:[{id:"properties.view",name:"View properties"},{id:"properties.create",name:"Create properties"},{id:"properties.edit",name:"Edit properties"},{id:"properties.enable",name:"Enable properties"},{id:"properties.disable",name:"Disable properties"},{id:"properties.delete",name:"Delete properties"}]},{id:"landlords",name:"Landlords",description:"Manage landlord accounts and access",permissions:[{id:"landlords.view",name:"View landlords"},{id:"landlords.create",name:"Create landlords"},{id:"landlords.edit",name:"Edit landlords"},{id:"landlords.delete",name:"Delete landlords"},{id:"landlords.send_login",name:"Send login details"}]},{id:"house_types",name:"House Types",description:"Manage unit/house categories",permissions:[{id:"house_types.view",name:"View house types"},{id:"house_types.create",name:"Create house types"},{id:"house_types.edit",name:"Edit house types"},{id:"house_types.delete",name:"Delete house types"}]},{id:"units",name:"Units",description:"Manage units across properties",permissions:[{id:"units.view",name:"View units"},{id:"units.create",name:"Create units"},{id:"units.edit",name:"Edit units"},{id:"units.delete",name:"Delete units"}]},{id:"tenants",name:"Tenants",description:"Manage tenant profiles",permissions:[{id:"tenants.view",name:"View tenants"},{id:"tenants.create",name:"Create tenants"},{id:"tenants.edit",name:"Edit tenants"},{id:"tenants.delete",name:"Delete tenants"}]},{id:"tenant_portal",name:"Tenant Portal Access",description:"Generate and send tenant portal credentials",permissions:[{id:"tenants.send_login",name:"Send tenant login details"},{id:"tenants.bulk_send_login",name:"Bulk send tenant logins"}]},{id:"leases",name:"Leases",description:"Create, update, and terminate leases",permissions:[{id:"leases.view",name:"View leases"},{id:"leases.create",name:"Create leases"},{id:"leases.edit",name:"Edit leases"},{id:"leases.terminate",name:"Terminate leases"},{id:"leases.delete",name:"Delete leases"},{id:"leases.view_balance",name:"View lease balances"}]},{id:"invoices",name:"Invoices",description:"Manage invoicing and approvals",permissions:[{id:"invoices.view",name:"View invoices"},{id:"invoices.create",name:"Create invoices"},{id:"invoices.edit",name:"Edit invoices"},{id:"invoices.approve",name:"Approve invoices"},{id:"invoices.send",name:"Send invoices"},{id:"invoices.generate",name:"Generate monthly invoices"},{id:"invoices.delete",name:"Delete invoices"}]},{id:"payments",name:"Payments & Receipts",description:"Record and manage payments",permissions:[{id:"payments.view",name:"View payments"},{id:"payments.receive",name:"Receive payments"},{id:"payments.edit",name:"Edit payments"},{id:"payments.delete",name:"Delete payments"},{id:"payments.export_receipt",name:"Export receipts"}]},{id:"water_readings",name:"Water Readings",description:"Record and analyze water readings",permissions:[{id:"water_readings.view",name:"View readings"},{id:"water_readings.create",name:"Record readings"},{id:"water_readings.edit",name:"Edit readings"},{id:"water_readings.delete",name:"Delete readings"},{id:"water_readings.bulk_entry",name:"Bulk entry"}]},{id:"charge_codes",name:"Charge Codes",description:"Manage charge codes and billing items",permissions:[{id:"charge_codes.view",name:"View charge codes"},{id:"charge_codes.create",name:"Create charge codes"},{id:"charge_codes.edit",name:"Edit charge codes"},{id:"charge_codes.delete",name:"Delete charge codes"}]},{id:"messaging",name:"Messaging",description:"Send and manage messages",permissions:[{id:"messaging.view",name:"View messages"},{id:"messaging.create",name:"Create messages"},{id:"messaging.edit",name:"Edit messages"},{id:"messaging.delete",name:"Delete messages"},{id:"messaging.send_sms",name:"Send SMS"},{id:"messaging.send_email",name:"Send email"},{id:"messaging.bulk_send",name:"Send bulk messages"},{id:"messaging.templates_manage",name:"Manage templates"},{id:"messaging.export",name:"Export message logs"}]},{id:"reports",name:"Reports",description:"Generate and export reports",permissions:[{id:"reports.view",name:"View reports"},{id:"reports.export",name:"Export reports"}]},{id:"activity_logs",name:"Operational Log",description:"Audit trail of system activity",permissions:[{id:"activity_logs.view",name:"View activity logs"}]},{id:"users",name:"User Management",description:"Manage system users and access",permissions:[{id:"users.view",name:"View users"},{id:"users.create",name:"Create users"},{id:"users.edit",name:"Edit users"},{id:"users.disable",name:"Disable users"},{id:"users.delete",name:"Delete users"},{id:"users.manage_permissions",name:"Manage permissions"},{id:"users.send_login",name:"Send login details"},{id:"users.reset_password",name:"Reset passwords"},{id:"users.toggle_otp",name:"Toggle OTP"}]},{id:"settings",name:"System Settings",description:"Configure system and SMS settings",permissions:[{id:"settings.view",name:"View settings"},{id:"settings.edit",name:"Edit settings"},{id:"settings.sms_settings",name:"Manage SMS settings"}]},{id:"data_import",name:"Data Import",description:"Upload or import data",permissions:[{id:"data_import.upload",name:"Upload/import data"}]}],w={properties:["properties"],tenants:["tenants"],accounting:["invoices","payments"],reports:["reports"],messaging:["messaging"],users:["users"],settings:["settings"]},V=te({mutationFn:async()=>{if(M)throw new Error("Select a property before adding users.");return await(await C("POST","/api/users",{username:r.email||r.name,fullName:r.name,role:r.role||"Administrator",password:r.password,permissions:r.permissions,propertyId:p,region:r.region,timezone:r.timezone})).json()},onSuccess:s=>{_({title:"User created",description:s?.generatedPassword?`Temporary password: ${s.generatedPassword}`:"User created successfully."}),ye.invalidateQueries({queryKey:["/api/users"]}),c({name:"",email:"",role:"",password:"",permissions:[],region:"Africa/Nairobi",timezone:"Africa/Nairobi"}),S(!1)},onError:s=>{_({title:"User creation failed",description:s?.message||"Unable to create user.",variant:"destructive"})}}),Q=()=>V.mutate(),Y=s=>{c(a=>({...a,permissions:a.permissions.includes(s)?a.permissions.filter(i=>i!==s):[...a.permissions,s]}))},X=s=>{const a=x.find(n=>n.id===s);if(!a)return;const i=a.permissions.map(n=>n.id),t=i.every(n=>r.permissions.includes(n));c(n=>{if(t)return{...n,permissions:n.permissions.filter(u=>!i.includes(u))};const y=new Set(n.permissions);return i.forEach(u=>y.add(u)),{...n,permissions:Array.from(y)}})},Z=s=>{switch(s){case"Administrator":return e.jsx(o,{variant:"default",className:"bg-red-100 text-red-800",children:"Administrator"});case"Manager":return e.jsx(o,{variant:"default",className:"bg-blue-100 text-blue-800",children:"Manager"});case"Accountant":return e.jsx(o,{variant:"default",className:"bg-green-100 text-green-800",children:"Accountant"});case"Support":return e.jsx(o,{variant:"outline",children:"Support"});default:return e.jsx(o,{variant:"outline",children:s})}},ee=s=>{switch(s){case"active":return e.jsx(o,{variant:"default",className:"bg-green-100 text-green-800",children:"Active"});case"inactive":return e.jsx(o,{variant:"destructive",children:"Inactive"});default:return e.jsx(o,{variant:"outline",children:s})}};return!D&&!k?e.jsx("div",{className:"p-6",children:e.jsx(P,{children:e.jsxs(z,{children:[e.jsx(R,{children:"User Management"}),e.jsx(F,{children:"Select a client to manage users."})]})})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"user-management-title",children:"User Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage system users and their permissions"}),!N&&e.jsx("p",{className:"text-xs text-amber-600 mt-1",children:"Select a property to add users."})]}),e.jsxs(re,{open:O,onOpenChange:S,children:[e.jsx(de,{asChild:!0,children:e.jsxs(g,{"data-testid":"button-add-user",disabled:M,children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Add User"]})}),e.jsxs(le,{className:"sm:max-w-[600px]",children:[e.jsxs(ce,{children:[e.jsx(me,{children:"Add New User"}),e.jsx(pe,{children:"Create a new system user and assign permissions"})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{htmlFor:"name",children:"Full Name"}),e.jsx(A,{id:"name",placeholder:"John Doe",value:r.name,onChange:s=>c(a=>({...a,name:s.target.value})),"data-testid":"input-user-name"})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"email",children:"Email Address"}),e.jsx(A,{id:"email",type:"email",placeholder:"john@example.com",value:r.email,onChange:s=>c(a=>({...a,email:s.target.value})),"data-testid":"input-user-email"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{htmlFor:"role",children:"Role"}),e.jsxs($,{value:r.role,onValueChange:s=>c(a=>({...a,role:s})),children:[e.jsx(q,{"data-testid":"select-user-role",children:e.jsx(B,{placeholder:"Select role"})}),e.jsxs(G,{children:[e.jsx(d,{value:"Administrator",children:"Administrator"}),e.jsx(d,{value:"Manager",children:"Manager"}),e.jsx(d,{value:"Accountant",children:"Accountant"}),e.jsx(d,{value:"Support",children:"Support"})]})]})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"password",children:"Password"}),e.jsx(A,{id:"password",type:"password",placeholder:"Enter password",value:r.password,onChange:s=>c(a=>({...a,password:s.target.value})),"data-testid":"input-user-password"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(l,{htmlFor:"region",children:"Region / Timezone"}),e.jsxs($,{value:r.region,onValueChange:s=>{const a={"East Africa":"Africa/Nairobi","West Africa":"Africa/Lagos","Southern Africa":"Africa/Johannesburg","North Africa":"Africa/Cairo","Central Africa":"Africa/Kinshasa",Europe:"Europe/London",Asia:"Asia/Dubai",Americas:"America/New_York"};c(i=>({...i,region:s,timezone:a[s]||"Africa/Nairobi"}))},children:[e.jsx(q,{"data-testid":"select-user-region",children:e.jsx(B,{placeholder:"Select region"})}),e.jsxs(G,{children:[e.jsx(d,{value:"East Africa",children:"East Africa (Africa/Nairobi - EAT)"}),e.jsx(d,{value:"West Africa",children:"West Africa (Africa/Lagos - WAT)"}),e.jsx(d,{value:"Southern Africa",children:"Southern Africa (Africa/Johannesburg - SAST)"}),e.jsx(d,{value:"North Africa",children:"North Africa (Africa/Cairo - EET)"}),e.jsx(d,{value:"Central Africa",children:"Central Africa (Africa/Kinshasa - WAT)"}),e.jsx(d,{value:"Europe",children:"Europe (Europe/London - GMT/BST)"}),e.jsx(d,{value:"Asia",children:"Asia (Asia/Dubai - GST)"}),e.jsx(d,{value:"Americas",children:"Americas (America/New_York - EST/EDT)"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Determines timezone for records and reports. Default: Nairobi, Kenya (EAT)"})]}),e.jsxs("div",{children:[e.jsx(l,{htmlFor:"timezone-display",children:"Selected Timezone"}),e.jsx(A,{id:"timezone-display",value:r.timezone,disabled:!0,className:"bg-muted"})]})]}),e.jsxs("div",{children:[e.jsx(l,{className:"text-base font-medium mb-3 block",children:"Permissions"}),e.jsx("div",{className:"space-y-3 max-h-64 overflow-y-auto border rounded-lg p-3",children:x.map(s=>{const i=s.permissions.map(t=>t.id).every(t=>r.permissions.includes(t));return e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{id:s.id,checked:i,onCheckedChange:()=>X(s.id),"data-testid":`checkbox-permission-${s.id}`}),e.jsx(l,{htmlFor:s.id,className:"text-sm font-medium",children:s.name})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.description}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mt-3",children:s.permissions.map(t=>e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{id:t.id,checked:r.permissions.includes(t.id),onCheckedChange:()=>Y(t.id),"data-testid":`checkbox-permission-${t.id}`}),e.jsx(l,{htmlFor:t.id,className:"text-sm",children:t.name})]},t.id))})]},s.id)})})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(g,{variant:"outline",onClick:()=>S(!1),children:"Cancel"}),e.jsx(g,{onClick:Q,"data-testid":"button-submit-user",disabled:V.isPending,children:"Add User"})]})]})]})]}),e.jsxs(P,{children:[e.jsx(z,{children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx(R,{children:"System Users"}),e.jsx(F,{children:"Manage user accounts and permissions"})]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>W(!v),"data-testid":"button-toggle-passwords",children:[v?e.jsx(ue,{className:"h-4 w-4 mr-2"}):e.jsx(ge,{className:"h-4 w-4 mr-2"}),v?"Hide":"Show"," Passwords"]})]})}),e.jsx(he,{children:e.jsxs(xe,{children:[e.jsx(je,{children:e.jsxs(b,{children:[e.jsx(j,{children:"User"}),e.jsx(j,{children:"Role"}),e.jsx(j,{children:"Status"}),e.jsx(j,{children:"Last Login"}),e.jsx(j,{children:"Permissions"}),e.jsx(j,{children:"Actions"})]})}),e.jsx(ve,{children:J?e.jsx(b,{children:e.jsx(m,{colSpan:6,className:"text-center text-muted-foreground py-6",children:"Loading users..."})}):L.length===0?e.jsx(b,{children:e.jsx(m,{colSpan:6,className:"text-center text-muted-foreground py-6",children:"No users found for the selected property."})}):L.map(s=>e.jsxs(b,{className:"hover-elevate",children:[e.jsx(m,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email}),v&&e.jsx("p",{className:"text-xs font-mono text-muted-foreground",children:"Password: ********"})]})}),e.jsx(m,{children:Z(s.role)}),e.jsx(m,{children:ee(s.status)}),e.jsx(m,{className:"text-sm",children:s.lastLogin}),e.jsx(m,{children:e.jsxs("div",{className:"flex flex-wrap gap-1",children:[(()=>{const a=new Set(s.permissions.flatMap(i=>w[i]?w[i].map(n=>x.find(u=>u.id===n)?.name||n):x.find(n=>i.startsWith(`${n.id}.`))?.name||i));return Array.from(a)})().slice(0,3).map(a=>e.jsx(o,{variant:"outline",className:"text-xs",children:a},a)),new Set(s.permissions.flatMap(i=>w[i]?w[i].map(n=>x.find(u=>u.id===n)?.name||n):x.find(n=>i.startsWith(`${n.id}.`))?.name||i)).size>3&&e.jsx(o,{variant:"outline",className:"text-xs",children:"+more"})]})}),e.jsx(m,{children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(g,{variant:"ghost",size:"sm","data-testid":`button-edit-user-${s.id}`,onClick:()=>T(`/users/${s.id}`),children:e.jsx(fe,{className:"h-4 w-4"})}),e.jsx(g,{variant:"ghost",size:"sm","data-testid":`button-permissions-${s.id}`,onClick:()=>T(`/users/${s.id}`),children:e.jsx(we,{className:"h-4 w-4"})}),s.role!=="Administrator"&&e.jsx(g,{variant:"ghost",size:"sm","data-testid":`button-delete-user-${s.id}`,children:e.jsx(Ae,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})]})}export{Ne as UserManagement};
