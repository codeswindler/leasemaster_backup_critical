import{b as se,d as x,u as ae,f as te,j as e,C as h,z as p,A as j,E as g,x as d,G as w,a4 as ne,as as le,at as ie,y as f,K as M,S as ce,r as de,s as re,v as me,w as A,a6 as F,a2 as L,aC as oe,I as ue,a3 as xe,ar as he,aI as U,a0 as r,q as K}from"./index-D3-Phv8z.js";import{r as T}from"./vendor-BBpupLJz.js";import{T as _,a as z,b as k,c as C}from"./tabs-CPhPIXkL.js";function Ne(){const[c,m]=T.useState([]),[N,O]=T.useState("email"),[R,I]=T.useState(""),[y,P]=T.useState(""),{selectedPropertyId:t,selectedLandlordId:l}=se(),$=!t||t==="all",{data:G=[]}=x({queryKey:["/api/tenants",t,l],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t),l&&s.append("landlordId",l);const a=`/api/tenants${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),{data:B=[]}=x({queryKey:["/api/units",t,l],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t),l&&s.append("landlordId",l);const a=`/api/units${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),{data:Q=[]}=x({queryKey:["/api/leases",t,l],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t),l&&s.append("landlordId",l);const a=`/api/leases${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),o=G.map(s=>{const a=Q.find(i=>i.tenantId===s.id&&i.status==="active"),n=B.find(i=>i.id===a?.unitId);return{id:s.id,name:s.fullName,email:s.email,phone:s.phone,unit:n?.unitNumber||"No unit"}}).filter(s=>s.name&&s.email),{data:q=[]}=x({queryKey:["/api/bulk-messages",t,l],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t),l&&s.append("landlordId",l);const a=`/api/bulk-messages${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()}}),{data:b=[]}=x({queryKey:["/api/message-recipients",t],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t);const a=`/api/message-recipients${s.toString()?`?${s}`:""}`;return await(await r("GET",a)).json()},enabled:!$}),[,D]=ae(),V=[{id:"rent-reminder",name:"Rent Payment Reminder",subject:"Monthly Rent Payment Due",message:`Dear {tenant_name},

This is a friendly reminder that your monthly rent payment of {amount} for unit {unit} is due on {due_date}.

Please make your payment via M-Pesa Paybill: 123456
Account Number: {account_number}

Thank you.`},{id:"maintenance",name:"Maintenance Notice",subject:"Scheduled Maintenance - {property_name}",message:`Dear {tenant_name},

We will be conducting scheduled maintenance on {date} from {time}.

Please expect temporary disruption to:
- Water supply
- Electricity

We apologize for any inconvenience.

Management`}],W=(s,a)=>{m(a?[...c,s]:c.filter(n=>n!==s))},H=()=>{m(o.map(s=>s.id))},J=()=>{m([])},X=te({mutationFn:async s=>{const n=await(await r("POST","/api/bulk-messages",{messageType:s.type,subject:s.subject,content:s.message,totalRecipients:s.recipients.length})).json(),i=s.recipients.map(u=>{const v=o.find(S=>S.id===u);return v?(s.type==="both"?["email","sms"]:[s.type]).map(S=>{const ee=S==="email"?v.email:v.phone;return r("POST","/api/message-recipients",{bulkMessageId:n.id,tenantId:v.id,channel:S,recipientContact:ee,status:"sent"})}):null}).flat().filter(Boolean);return await Promise.all(i),n},onSuccess:()=>{K.invalidateQueries({queryKey:["/api/bulk-messages"]}),K.invalidateQueries({queryKey:["/api/message-recipients"]}),m([]),I(""),P(""),alert("Message sent successfully!")},onError:s=>{console.error("Failed to send message:",s),alert("Failed to send message. Please try again.")}}),Y=()=>{c.length===0||!y.trim()||X.mutate({recipients:c,type:N,subject:R,message:y})},Z=s=>{I(s.subject),P(s.message)},E=s=>{switch(s){case"delivered":return e.jsx(f,{variant:"default",className:"bg-green-100 text-green-800",children:"Delivered"});case"pending":return e.jsx(f,{variant:"secondary",children:"Pending"});case"failed":return e.jsx(f,{variant:"destructive",children:"Failed"});default:return e.jsx(f,{variant:"outline",children:"Unknown"})}};return $?e.jsx("div",{className:"p-6",children:e.jsx(h,{children:e.jsxs(p,{children:[e.jsx(j,{children:"Messaging"}),e.jsx(g,{children:"Select a property to send and view messages."})]})})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"messaging-title",children:"Messaging"}),e.jsx("p",{className:"text-muted-foreground",children:"Communicate with your tenants via email and SMS"})]}),e.jsxs(_,{defaultValue:"compose",className:"space-y-6",children:[e.jsxs(z,{className:"grid w-full grid-cols-2",children:[e.jsx(k,{value:"compose","data-testid":"tab-compose",children:"Compose Message"}),e.jsx(k,{value:"outbox","data-testid":"tab-outbox",children:"Outbox"})]}),e.jsx(C,{value:"compose",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(h,{children:[e.jsxs(p,{children:[e.jsxs(j,{className:"flex items-center justify-between",children:["Recipients",e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:H,"data-testid":"button-select-all",children:"All"}),e.jsx(d,{variant:"outline",size:"sm",onClick:J,"data-testid":"button-select-none",children:"None"})]})]}),e.jsx(g,{children:"Select tenants to send message to"})]}),e.jsxs(w,{className:"space-y-3",children:[o.map(s=>e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(ne,{id:s.id,checked:c.includes(s.id),onCheckedChange:a=>W(s.id,!!a),"data-testid":`checkbox-tenant-${s.id}`}),e.jsx(le,{className:"h-8 w-8",children:e.jsx(ie,{className:"text-xs",children:s.name.split(" ").map(a=>a[0]).join("")})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.unit})]})]},s.id)),c.length>0&&e.jsx("div",{className:"pt-3 border-t",children:e.jsxs(f,{variant:"secondary",children:[c.length," selected"]})})]})]}),e.jsxs(h,{className:"lg:col-span-2",children:[e.jsxs(p,{children:[e.jsx(j,{children:"Message Details"}),e.jsx(g,{children:"Compose your message"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Message Type"}),e.jsxs(ce,{value:N,onValueChange:s=>O(s),children:[e.jsx(de,{"data-testid":"select-message-type",children:e.jsx(re,{})}),e.jsxs(me,{children:[e.jsx(A,{value:"email",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4"}),"Email Only"]})}),e.jsx(A,{value:"sms",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"SMS Only"]})}),e.jsx(A,{value:"both",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),"Email & SMS"]})})]})]})]}),(N==="email"||N==="both")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"subject",children:"Subject"}),e.jsx(ue,{id:"subject",placeholder:"Enter email subject",value:R,onChange:s=>I(s.target.value),"data-testid":"input-subject"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"message",children:"Message"}),e.jsx(xe,{id:"message",placeholder:"Type your message here...",value:y,onChange:s=>P(s.target.value),rows:8,"data-testid":"textarea-message"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Use placeholders: ","{tenant_name}",", ","{unit}",", ","{amount}",", ","{due_date}",", ","{account_number}"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{children:"Quick Templates"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:V.map(s=>e.jsx(d,{variant:"outline",size:"sm",onClick:()=>Z(s),"data-testid":`button-template-${s.id}`,children:s.name},s.id))})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx(d,{variant:"outline",children:"Save Draft"}),e.jsxs(d,{onClick:Y,disabled:c.length===0||!y.trim(),"data-testid":"button-send-message",children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Send Message"]})]})]})]})]})}),e.jsx(C,{value:"outbox",className:"space-y-6",children:e.jsxs(_,{defaultValue:"sms",className:"space-y-4",children:[e.jsxs(z,{className:"grid w-full grid-cols-2",children:[e.jsx(k,{value:"sms","data-testid":"tab-sms-outbox",children:"SMS Outbox"}),e.jsx(k,{value:"email","data-testid":"tab-email-outbox",children:"Email Outbox"})]}),e.jsx(C,{value:"sms",children:e.jsxs(h,{children:[e.jsxs(p,{children:[e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),"SMS Messages"]}),e.jsx(g,{children:"Track SMS delivery status and timing"})]}),e.jsx(w,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2 font-medium",children:"ID"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Contact"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Message"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Time Sent"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Status"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"TAT"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Actions"})]})}),e.jsxs("tbody",{children:[b.filter(s=>s.channel==="sms").map(s=>{const a=q.find(u=>u.id===s.bulkMessageId),n=o.find(u=>u.id===s.tenantId),i=s.deliveredAt&&s.sentAt?`${Math.round((new Date(s.deliveredAt).getTime()-new Date(s.sentAt).getTime())/1e3)}s`:"-";return e.jsxs("tr",{className:"border-b hover-elevate",children:[e.jsx("td",{className:"p-2 text-sm font-mono",children:s.id.substring(0,8)}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:n?.name||"Unknown"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.recipientContact})]})}),e.jsx("td",{className:"p-2 max-w-xs",children:e.jsx("p",{className:"text-sm truncate",title:a?.content,children:a?.content||"N/A"})}),e.jsx("td",{className:"p-2 text-sm",children:s.sentAt?new Date(s.sentAt).toLocaleString():"Pending"}),e.jsx("td",{className:"p-2",children:E(s.status)}),e.jsx("td",{className:"p-2 text-sm font-mono",children:i}),e.jsx("td",{className:"p-2",children:e.jsx(d,{variant:"outline",size:"sm",onClick:()=>D(`/message-details/${s.id}`),"data-testid":`button-view-sms-${s.id}`,children:e.jsx(U,{className:"h-3 w-3"})})})]},s.id)}),b.filter(s=>s.channel==="sms").length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-8 text-center text-muted-foreground",children:"No SMS messages sent yet"})})]})]})})})]})}),e.jsx(C,{value:"email",children:e.jsxs(h,{children:[e.jsxs(p,{children:[e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"h-5 w-5"}),"Email Messages"]}),e.jsx(g,{children:"Track email delivery status"})]}),e.jsx(w,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2 font-medium",children:"ID"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Sender"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Recipient"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Subject"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Time Sent"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Status"}),e.jsx("th",{className:"text-left p-2 font-medium",children:"Actions"})]})}),e.jsxs("tbody",{children:[b.filter(s=>s.channel==="email").map(s=>{const a=q.find(i=>i.id===s.bulkMessageId),n=o.find(i=>i.id===s.tenantId);return e.jsxs("tr",{className:"border-b hover-elevate",children:[e.jsx("td",{className:"p-2 text-sm font-mono",children:s.id.substring(0,8)}),e.jsx("td",{className:"p-2 text-sm",children:"system@rentflow.app"}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:n?.name||"Unknown"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.recipientContact})]})}),e.jsx("td",{className:"p-2 max-w-xs",children:e.jsx("p",{className:"text-sm truncate",title:a?.subject,children:a?.subject||"No Subject"})}),e.jsx("td",{className:"p-2 text-sm",children:s.sentAt?new Date(s.sentAt).toLocaleString():"Pending"}),e.jsx("td",{className:"p-2",children:E(s.status)}),e.jsx("td",{className:"p-2",children:e.jsx(d,{variant:"outline",size:"sm",onClick:()=>D(`/message-details/${s.id}`),"data-testid":`button-view-email-${s.id}`,children:e.jsx(U,{className:"h-3 w-3"})})})]},s.id)}),b.filter(s=>s.channel==="email").length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"p-8 text-center text-muted-foreground",children:"No email messages sent yet"})})]})]})})})]})})]})})]})]})}export{Ne as Messaging};
