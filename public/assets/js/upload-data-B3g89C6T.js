import{u as ce,a as de,b as me,d as W,j as e,x as q,a1 as pe,am as G,an as ue,ao as H,ap as X,C as S,z as U,A as F,B as he,E as $,G as E,K as Z,S as xe,r as fe,s as ge,v as je,w as Ne,ah as ye,T as we,I as ve,L as V,aq as be,U as De,a0 as j,q as R}from"./index-D3-Phv8z.js";import{r as N,J as y,K as Se,L as Ue}from"./vendor-BBpupLJz.js";import{P as Fe}from"./progress-RKh4RjZl.js";import{U as ee}from"./upload-f6bMxHtX.js";import{D as Ee}from"./download-BIGyNlOu.js";function Le(){const[,L]=ce(),[l,te]=N.useState(""),[m,se]=N.useState(null),[T,_]=N.useState(!1),[o,h]=N.useState(null),[i,O]=N.useState(null),{toast:c}=de(),ae=N.useRef(null),{selectedPropertyId:x,selectedLandlordId:f}=me(),{data:K=[],isLoading:ne}=W({queryKey:["/api/properties",f,x],queryFn:async()=>{const t=new URLSearchParams;f&&t.append("landlordId",f),x&&t.append("propertyId",x);const n=`/api/properties${t.toString()?`?${t}`:""}`;return await(await j("GET",n)).json()}}),{data:ie=[]}=W({queryKey:["/api/units",x,f],queryFn:async()=>{const t=new URLSearchParams;x&&t.append("propertyId",x),f&&t.append("landlordId",f);const n=`/api/units${t.toString()?`?${t}`:""}`;return await(await j("GET",n)).json()}}),z=l?ie.filter(t=>t.propertyId===l):[],P=K.find(t=>t.id===l),re=()=>{const t=[{"Full Name":"John Doe",Email:"john.doe@email.com",Phone:"+254700000000","ID Number":"12345678","Emergency Contact":"Jane Doe","Emergency Phone":"+254700000001","Unit Number":"A001","Lease Start Date":"2024-01-01","Lease End Date":"2024-12-31","Monthly Rent":"50000","Deposit Amount":"100000","Water Rate Per Unit":"15.50","Opening Balance":"-5000","Balance Type":"arrears",Notes:"2 months arrears from previous property"},{"Full Name":"Mary Smith",Email:"mary.smith@email.com",Phone:"+254700000002","ID Number":"87654321","Emergency Contact":"John Smith","Emergency Phone":"+254700000003","Unit Number":"A002","Lease Start Date":"2024-02-01","Lease End Date":"2025-01-31","Monthly Rent":"45000","Deposit Amount":"90000","Water Rate Per Unit":"15.50","Opening Balance":"2000","Balance Type":"credit",Notes:"Advance payment for next month"}],n=y.json_to_sheet(t);n["!cols"]=[{wch:20},{wch:25},{wch:15},{wch:12},{wch:20},{wch:15},{wch:12},{wch:15},{wch:15},{wch:12},{wch:15},{wch:15},{wch:15},{wch:12},{wch:30}];const d=y.book_new();y.book_append_sheet(d,n,"Tenant Upload Template");const A=[{Field:"Full Name",Required:"Yes",Description:"Complete name of the tenant",Example:"John Doe"},{Field:"Email",Required:"Yes",Description:"Valid email address",Example:"john.doe@email.com"},{Field:"Phone",Required:"Yes",Description:"Phone number with country code",Example:"+254700000000"},{Field:"ID Number",Required:"Yes",Description:"National ID or Passport number",Example:"12345678"},{Field:"Emergency Contact",Required:"No",Description:"Emergency contact person name",Example:"Jane Doe"},{Field:"Emergency Phone",Required:"No",Description:"Emergency contact phone number",Example:"+254700000001"},{Field:"Unit Number",Required:"Yes",Description:"Unit number that exists in the selected property",Example:"A001"},{Field:"Lease Start Date",Required:"Yes",Description:"Lease start date (YYYY-MM-DD)",Example:"2024-01-01"},{Field:"Lease End Date",Required:"Yes",Description:"Lease end date (YYYY-MM-DD)",Example:"2024-12-31"},{Field:"Monthly Rent",Required:"Yes",Description:"Monthly rent amount in KSH (numbers only)",Example:"50000"},{Field:"Deposit Amount",Required:"Yes",Description:"Security deposit amount in KSH",Example:"100000"},{Field:"Water Rate Per Unit",Required:"No",Description:"Water rate per unit (defaults to 15.50)",Example:"15.50"},{Field:"Opening Balance",Required:"No",Description:"Opening balance amount (positive for credit, negative for arrears)",Example:"-5000"},{Field:"Balance Type",Required:"No",Description:"Either 'arrears' for debt or 'credit' for advance payment",Example:"arrears"},{Field:"Notes",Required:"No",Description:"Additional notes about the tenant or lease",Example:"2 months arrears from previous property"}],p=y.json_to_sheet(A);p["!cols"]=[{wch:20},{wch:10},{wch:40},{wch:25}],y.book_append_sheet(d,p,"Instructions");const r=`tenant_bulk_upload_template_${P?.name||"template"}.xlsx`;Se(d,r),c({title:"Template Downloaded",description:`Template downloaded as ${r}. Fill in your tenant data following the instructions.`})},le=t=>{const n=t.target.files?.[0];if(!n)return;if(!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv"].includes(n.type)){c({title:"Invalid File Type",description:"Please upload an Excel file (.xlsx, .xls) or CSV file.",variant:"destructive"});return}if(n.size>10*1024*1024){c({title:"File Too Large",description:"File size must be less than 10MB.",variant:"destructive"});return}se(n),O(null)},oe=async()=>{if(!m||!l){c({title:"Missing Requirements",description:"Please select both a property and an Excel file.",variant:"destructive"});return}_(!0),h({total:0,processed:0,successful:0,failed:0});try{const t=await m.arrayBuffer(),n=Ue(t,{type:"array"}),d=n.SheetNames[0],A=n.Sheets[d],p=y.sheet_to_json(A);if(p.length===0)throw new Error("The uploaded file contains no data.");h({total:p.length,processed:0,successful:0,failed:0});const r={successful:[],failed:[],duplicates:[],invalidUnits:[]};for(let w=0;w<p.length;w++){const a=p[w],I=w+2;h(g=>({...g,processed:w+1,current:a["Full Name"]||`Row ${I}`}));try{const v=["Full Name","Email","Phone","ID Number","Unit Number","Lease Start Date","Lease End Date","Monthly Rent","Deposit Amount"].filter(s=>!a[s]?.toString().trim());if(v.length>0)throw new Error(`Missing required fields: ${v.join(", ")}`);const k=a["Unit Number"].toString().trim(),M=z.find(s=>s.unitNumber===k);if(!M){r.invalidUnits.push({row:I,unitNumber:k,tenant:a["Full Name"]}),h(s=>({...s,failed:s.failed+1}));continue}const Y={fullName:a["Full Name"].toString().trim(),email:a.Email.toString().trim().toLowerCase(),phone:a.Phone.toString().trim(),idNumber:a["ID Number"].toString().trim(),emergencyContact:a["Emergency Contact"]?.toString().trim()||"",emergencyPhone:a["Emergency Phone"]?.toString().trim()||""};if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(Y.email))throw new Error("Invalid email format");const b=await(await j("POST","/api/tenants",Y)).json(),C=s=>{if(!s)return"";if(s instanceof Date)return s.toISOString().split("T")[0];if(typeof s=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(s))return s;if(typeof s=="string"){const u=new Date(s);if(!isNaN(u.getTime()))return u.toISOString().split("T")[0]}return typeof s=="number"?new Date((s-25569)*86400*1e3).toISOString().split("T")[0]:s.toString()},J={unitId:M.id,tenantId:b.id,startDate:C(a["Lease Start Date"]),endDate:C(a["Lease End Date"]),rentAmount:a["Monthly Rent"].toString(),depositAmount:a["Deposit Amount"].toString(),waterRatePerUnit:a["Water Rate Per Unit"]?.toString()||"15.50",status:"active"};await j("POST","/api/leases",J);const B=a["Opening Balance"],D=a["Balance Type"]?.toString().toLowerCase(),Q=a.Notes?.toString()||"";if(B&&(D==="arrears"||D==="credit")){const s=Math.abs(parseFloat(B.toString()));if(D==="arrears"&&s>0){const u={tenantId:b.id,propertyId:l,unitId:M.id,dueDate:C(a["Lease Start Date"]),totalAmount:s.toString(),status:"overdue",description:`Opening arrears balance - ${Q}`.trim(),invoiceNumber:`ARR-${Date.now()}-${b.id.slice(-4)}`};await j("POST","/api/invoices",u)}else if(D==="credit"&&s>0){const u={tenantId:b.id,propertyId:l,amount:s.toString(),paymentDate:C(a["Lease Start Date"]),paymentMethod:"Bank Transfer",description:`Opening credit balance - ${Q}`.trim(),receiptNumber:`CR-${Date.now()}-${b.id.slice(-4)}`};await j("POST","/api/payments",u)}}r.successful.push({row:I,tenant:Y.fullName,unit:k,rent:J.rentAmount,balance:B||0,balanceType:D||"none"}),h(s=>({...s,successful:s.successful+1}))}catch(g){r.failed.push({row:I,tenant:a["Full Name"]||"Unknown",error:g.message}),h(v=>({...v,failed:v.failed+1}))}await new Promise(g=>setTimeout(g,100))}R.invalidateQueries({queryKey:["/api/tenants"]}),R.invalidateQueries({queryKey:["/api/leases"]}),R.invalidateQueries({queryKey:["/api/units"]}),R.invalidateQueries({queryKey:["/api/invoices"]}),R.invalidateQueries({queryKey:["/api/payments"]}),O(r),r.successful.length>0&&r.failed.length===0?(c({title:"Upload Successful",description:`Successfully processed ${r.successful.length} tenants with leases and balances.`}),setTimeout(()=>{L("/tenants")},3e3)):r.successful.length>0?c({title:"Partial Upload",description:`${r.successful.length} successful, ${r.failed.length} failed. Check results below.`,variant:"destructive"}):c({title:"Upload Failed",description:"No tenants were processed successfully. Check the file format and data.",variant:"destructive"})}catch(t){c({title:"Upload Failed",description:t.message||"Failed to process the uploaded file.",variant:"destructive"})}finally{_(!1)}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(q,{variant:"outline",size:"sm",onClick:()=>L("/tenants"),"data-testid":"button-back-to-tenants",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Back to Tenants"]}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2","data-testid":"upload-data-title",children:[e.jsx(ee,{className:"h-8 w-8"}),"Bulk Data Upload"]}),e.jsx("p",{className:"text-muted-foreground",children:"Upload tenant data with lease agreements and opening balances"})]})]}),e.jsxs(G,{children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsx(H,{children:"Important Instructions"}),e.jsx(X,{children:e.jsxs("ol",{className:"list-decimal list-inside space-y-1 mt-2",children:[e.jsx("li",{children:"Select the property where tenants will be assigned"}),e.jsx("li",{children:"Download the template and fill in tenant information"}),e.jsx("li",{children:"Ensure all unit numbers exist in the selected property"}),e.jsx("li",{children:"Include opening balances for tenants with arrears or credits"}),e.jsx("li",{children:"Upload the completed file to automatically create tenants, leases, and balances"})]})})]}),e.jsxs(S,{children:[e.jsxs(U,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5"}),"Step 1: Select Property"]}),e.jsx($,{children:"Choose the property where the tenants will be assigned"})]}),e.jsx(E,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"property-select",children:"Property"}),e.jsxs(xe,{value:l,onValueChange:te,disabled:ne,children:[e.jsx(fe,{className:"w-full","data-testid":"select-property",children:e.jsx(ge,{placeholder:"Select a property"})}),e.jsx(je,{children:K.map(t=>e.jsxs(Ne,{value:t.id,children:[t.name," - ",t.address," (",t.totalUnits," units)"]},t.id))})]})]}),l&&e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Selected Property Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",P?.name]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Address:"})," ",P?.address]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Units:"})," ",P?.totalUnits]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Available Units:"})," ",z.filter(t=>t.status==="vacant").length]})]})]})]})})]}),e.jsxs(S,{children:[e.jsxs(U,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5"}),"Step 2: Download Template"]}),e.jsx($,{children:"Download the Excel template and fill in your tenant data"})]}),e.jsx(E,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(G,{children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx(H,{children:"Template Requirements"}),e.jsx(X,{className:"mt-2",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Required Fields:"})," Full Name, Email, Phone, ID Number, Unit Number, Lease Start Date, Lease End Date, Monthly Rent, Deposit Amount"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Balance Types:"}),' Use "arrears" for outstanding debt or "credit" for advance payments']}),e.jsxs("p",{children:[e.jsx("strong",{children:"Unit Numbers:"})," Must match existing units in the selected property"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date Format:"})," Use YYYY-MM-DD format (e.g., 2024-01-01)"]})]})})]}),e.jsxs(q,{onClick:re,disabled:!l,"data-testid":"button-download-template",className:"w-full",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Download Excel Template"]}),!l&&e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Select a property first to download the template"})]})})]}),e.jsxs(S,{children:[e.jsxs(U,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"h-5 w-5"}),"Step 3: Upload Completed File"]}),e.jsx($,{children:"Upload your completed Excel file to create tenants and leases"})]}),e.jsx(E,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Z,{htmlFor:"file-upload",children:"Excel File"}),e.jsx(ve,{type:"file",accept:".xlsx,.xls,.csv",onChange:le,disabled:!l||T,ref:ae,"data-testid":"input-upload-file",className:"cursor-pointer"})]}),m&&e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Selected File"}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",m.name]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Size:"})," ",(m.size/1024/1024).toFixed(2)," MB"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Type:"})," ",m.type]})]})]}),e.jsxs(q,{onClick:oe,disabled:!l||!m||T,className:"w-full","data-testid":"button-process-upload",children:[T&&e.jsx(V,{className:"h-4 w-4 mr-2 animate-spin"}),T?"Processing Upload...":"Process Upload"]})]})})]}),o&&e.jsxs(S,{children:[e.jsx(U,{children:e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5 animate-spin"}),"Upload Progress"]})}),e.jsx(E,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(Fe,{value:o.processed/o.total*100,className:"w-full"}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:o.total}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:o.processed}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Processed"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:o.successful}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Successful"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:o.failed}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Failed"})]})]}),o.current&&e.jsxs("p",{className:"text-center text-sm text-muted-foreground",children:["Currently processing: ",o.current]})]})})]}),i&&e.jsxs(S,{children:[e.jsx(U,{children:e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5"}),"Upload Results"]})}),e.jsx(E,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:i.successful.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Successful"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:i.failed.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Failed"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:i.invalidUnits.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Invalid Units"})]})]}),i.successful.length>0&&e.jsx("div",{children:e.jsxs(q,{onClick:()=>L("/tenants"),className:"w-full","data-testid":"button-view-tenants",children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"View Created Tenants"]})}),i.successful.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-green-600 mb-2",children:["✓ Successfully Created (",i.successful.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:i.successful.map((t,n)=>e.jsxs("div",{className:"text-sm p-2 bg-green-50 rounded",children:[e.jsxs("strong",{children:["Row ",t.row,":"]})," ",t.tenant," → Unit ",t.unit,"(Rent: KSh ",parseFloat(t.rent).toLocaleString(),")",t.balance!==0&&e.jsxs("span",{className:"ml-2 text-xs",children:["[",t.balanceType,": KSh ",Math.abs(t.balance).toLocaleString(),"]"]})]},n))})]}),i.failed.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-red-600 mb-2",children:["✗ Failed Records (",i.failed.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:i.failed.map((t,n)=>e.jsxs("div",{className:"text-sm p-2 bg-red-50 rounded",children:[e.jsxs("strong",{children:["Row ",t.row,":"]})," ",t.tenant," - ",t.error]},n))})]}),i.invalidUnits.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-orange-600 mb-2",children:["⚠ Invalid Unit Numbers (",i.invalidUnits.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:i.invalidUnits.map((t,n)=>e.jsxs("div",{className:"text-sm p-2 bg-orange-50 rounded",children:[e.jsxs("strong",{children:["Row ",t.row,":"]})," ",t.tenant,' - Unit "',t.unitNumber,'" does not exist in selected property']},n))})]})]})})]})]})}export{Le as UploadData};
