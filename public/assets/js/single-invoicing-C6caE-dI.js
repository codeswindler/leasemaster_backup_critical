import{b as fe,a as je,d as j,f as ye,j as t,C as _,z as T,A as K,E,G as M,K as u,S as ve,r as Ne,s as Se,v as we,w as be,a4 as Ce,I as R,y as Ie,ay as De,x as Re,ax as Ae,B as Le,a0 as h,q as V}from"./index-D3-Phv8z.js";import{r}from"./vendor-BBpupLJz.js";function $e(){const[te,A]=r.useState(""),[c,y]=r.useState([]),[p,se]=r.useState(""),[v,L]=r.useState(""),[q,w]=r.useState(""),[N,ne]=r.useState(""),[b,C]=r.useState({}),{selectedPropertyId:n,selectedLandlordId:i,setSelectedPropertyId:ae}=fe(),{toast:x}=je();r.useEffect(()=>{n?A(n):(A(""),w(""),y([]))},[n]),r.useEffect(()=>{if(!p){L("");return}if(!v){const e=new Date(p);e.setMonth(e.getMonth()+1),L(e.toISOString().split("T")[0])}},[p,v]);const{data:ie=[]}=j({queryKey:["/api/properties",i,n],queryFn:async()=>{const e=new URLSearchParams;i&&e.append("landlordId",i),n&&e.append("propertyId",n);const s=`/api/properties${e.toString()?`?${e}`:""}`;return await(await h("GET",s)).json()}}),{data:k=[]}=j({queryKey:["/api/tenants",n,i],queryFn:async()=>{const e=new URLSearchParams;n&&e.append("propertyId",n),i&&e.append("landlordId",i);const s=`/api/tenants${e.toString()?`?${e}`:""}`;return await(await h("GET",s)).json()}}),{data:z=[]}=j({queryKey:["/api/units",n,i],queryFn:async()=>{const e=new URLSearchParams;n&&e.append("propertyId",n),i&&e.append("landlordId",i);const s=`/api/units${e.toString()?`?${e}`:""}`;return await(await h("GET",s)).json()}}),{data:B=[]}=j({queryKey:["/api/leases",n,i],queryFn:async()=>{const e=new URLSearchParams;n&&e.append("propertyId",n),i&&e.append("landlordId",i);const s=`/api/leases${e.toString()?`?${e}`:""}`;return await(await h("GET",s)).json()}}),{data:G=[]}=j({queryKey:["/api/charge-codes",n],queryFn:async()=>{const e=new URLSearchParams;n&&e.append("propertyId",n);const s=`/api/charge-codes${e.toString()?`?${e}`:""}`;return await(await h("GET",s)).json()},enabled:!!n}),{data:O=[]}=j({queryKey:["/api/water-readings",n,i],queryFn:async()=>{const e=new URLSearchParams;n&&e.append("propertyId",n),i&&e.append("landlordId",i);const s=`/api/water-readings${e.toString()?`?${e}`:""}`;return await(await h("GET",s)).json()},enabled:!!n}),o=e=>{const s=Number(e);return Number.isFinite(s)?s:0},re=e=>{const s=e.lastModifiedAt||e.createdAt||e.last_modified_at||e.created_at||e.readingDate||e.reading_date,a=s?new Date(s).getTime():0;return Number.isFinite(a)?a:0},oe=e=>{const s=o(e?.current_reading??e?.currentReading),a=o(e?.previous_reading??e?.previousReading);return Number.isFinite(s)&&Number.isFinite(a)?Math.max(0,s-a):o(e?.consumption)},de=e=>{if(!e||e==="null")return{};if(typeof e=="string")try{const s=JSON.parse(e);return s&&typeof s=="object"?s:{}}catch{return{}}return typeof e=="object"?e:{}},Q=ie.map(e=>({id:e.id,name:e.name,landlordId:e.landlordId??e.landlord_id})),ce=Array.isArray(z)?z.map(e=>({id:e.id,unitNumber:e.unitNumber??e.unit_number,propertyId:e.propertyId??e.property_id,chargeAmounts:de(e.chargeAmounts??e.charge_amounts),status:e.status})):[],le=Array.isArray(B)?B.map(e=>({id:e.id,unitId:e.unitId??e.unit_id,tenantId:e.tenantId??e.tenant_id,rentAmount:e.rentAmount??e.rent_amount,waterRatePerUnit:e.waterRatePerUnit??e.water_rate_per_unit,status:e.status})):[],ue=Array.isArray(k)?k.map(e=>({id:e.id,fullName:e.fullName??e.full_name})):[],me=Array.isArray(G)?G.map(e=>({id:e.id,name:e.name,description:e.description})):[],g=[{id:"rent",name:"Rent"},{id:"water",name:"Water (Metered)"},...me],F=new Set(Q.map(e=>e.landlordId).filter(Boolean)).size>1&&(!i||i==="all"),U=!n||F,pe=e=>{if(!e)return"";const s=new Date(e);if(Number.isNaN(s.getTime()))return"";const a=new Date(s.getFullYear(),s.getMonth()-1,1);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`},$=r.useMemo(()=>pe(p),[p]),he=r.useMemo(()=>{const e=new Map;return O.forEach(s=>{const a=s.unitId??s.unit_id;if(!a)return;const d=s.readingDate??s.reading_date??s.createdAt??s.created_at,m=new Date(d);if(!$||Number.isNaN(m.getTime())||`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}`!==$)return;const D=re(s),ee=e.get(a);(!ee||D>ee.dateValue)&&e.set(a,{...s,dateValue:D})}),e},[O,$]);r.useEffect(()=>{n&&c.length===0&&g.length>0&&y(g.map(e=>e.id))},[n,g.length]);const Y=ce.map(e=>{const s=le.find(d=>d.unitId===e.id&&d.status==="active"),a=s?ue.find(d=>d.id===s.tenantId):null;return{id:e.id,unit:e.unitNumber,tenant:a?a.fullName:"Vacant",rent:s?o(s.rentAmount):0,lease:s,chargeAmounts:e.chargeAmounts,status:e.status}}),W=Y.filter(e=>e.unit.toLowerCase().includes(N.toLowerCase())||e.tenant.toLowerCase().includes(N.toLowerCase())),l=Y.find(e=>e.id===q),S=l?.lease,f=l?he.get(l.id):null,I=f?oe(f):0,H=o(S?.waterRatePerUnit),J=Number.isFinite(I)&&I>0?I*H:0,xe=(e,s)=>{y(s?[...c,e]:c.filter(a=>a!==e))};r.useEffect(()=>{if(!l){C({});return}const e={};c.forEach(s=>{if(s==="rent"){e[s]=o(S?.rentAmount);return}if(s==="water"){e[s]=J;return}e[s]=o(l.chargeAmounts?.[s]??0)}),C(e)},[l?.id,c.join(","),J]);const X=()=>Object.values(b).reduce((e,s)=>e+o(s),0),Z=ye({mutationFn:async()=>{if(!S)throw new Error("Selected unit has no active lease.");const e=`INV-${new Date().getFullYear()}-${Date.now()}-${S.id.slice(0,8)}`,s=X(),d=await(await h("POST","/api/invoices",{leaseId:S.id,invoiceNumber:e,description:`Monthly charges for ${l?.unit}`,amount:s.toString(),dueDate:v,issueDate:p,status:"draft"})).json();for(const[m,P]of Object.entries(b))o(P)>0&&await h("POST","/api/invoice-items",{invoiceId:d.id,chargeCode:m,description:g.find(D=>D.id===m)?.name||m,quantity:"1",unitPrice:o(P).toString()})},onSuccess:()=>{x({title:"Invoice created",description:"The invoice was saved in draft status."}),V.invalidateQueries({queryKey:["/api/invoices"]}),V.invalidateQueries({queryKey:["/api/invoice-items"]}),V.invalidateQueries({queryKey:["/api/stats"]}),w(""),y([]),C({})},onError:e=>{x({title:"Failed to create invoice",description:e.message||"Please check the invoice details.",variant:"destructive"})}}),ge=()=>{if(F){x({title:"Landlord Required",description:"Select a landlord in the header before submitting invoices.",variant:"destructive"});return}if(U){x({title:"Property Required",description:"Select a property in the header before submitting invoices.",variant:"destructive"});return}if(!q||c.length===0){x({title:"Missing Selection",description:"Please select a unit and at least one charge code.",variant:"destructive"});return}if(!p||!v){x({title:"Missing Dates",description:"Select both invoice and due dates.",variant:"destructive"});return}Z.mutate()};return t.jsxs("div",{className:"p-6 space-y-6",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold","data-testid":"single-invoicing-title",children:"Single Invoicing"}),t.jsx("p",{className:"text-muted-foreground",children:"Create individual invoices for specific tenants"})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[t.jsxs(_,{className:"lg:col-span-1",children:[t.jsxs(T,{children:[t.jsx(K,{children:"Invoice Configuration"}),t.jsx(E,{children:"Select property, charges, and date"})]}),t.jsxs(M,{className:"space-y-4",children:[F&&t.jsx("div",{className:"text-sm text-muted-foreground",children:"Select a landlord in the header to continue."}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"property",children:"Property"}),t.jsxs(ve,{value:te,onValueChange:e=>{A(e),ae(e||null),w("")},disabled:U,children:[t.jsx(Ne,{"data-testid":"select-property",children:t.jsx(Se,{placeholder:"Select property"})}),t.jsx(we,{children:Q.map(e=>t.jsx(be,{value:e.id,children:e.name},e.id))})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{children:"Charge Codes"}),t.jsx("div",{className:"space-y-2",children:g.map(e=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Ce,{id:e.id,checked:c.includes(e.id),onCheckedChange:s=>xe(e.id,!!s),"data-testid":`checkbox-${e.id}`}),t.jsx(u,{htmlFor:e.id,className:"flex-1 cursor-pointer",children:t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{children:e.name}),e.id!=="rent"&&e.id!=="water"&&t.jsx("span",{className:"text-muted-foreground font-mono text-sm",children:"Property charge"})]})})]},e.id))})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"invoice-date",children:"Invoice Date"}),t.jsx(R,{id:"invoice-date",type:"date",value:p,onChange:e=>se(e.target.value),"data-testid":"input-invoice-date"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"due-date",children:"Due Date"}),t.jsx(R,{id:"due-date",type:"date",value:v,onChange:e=>L(e.target.value),"data-testid":"input-due-date"})]})]})]}),t.jsxs(_,{children:[t.jsxs(T,{children:[t.jsx(K,{children:"Select Unit"}),t.jsx(E,{children:"Search and select the tenant unit"})]}),t.jsxs(M,{className:"space-y-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(u,{htmlFor:"unit-search",children:"Search Units"}),t.jsx(R,{id:"unit-search",placeholder:"Type unit or tenant name...",value:N,onChange:e=>ne(e.target.value),"data-testid":"input-unit-search"})]}),t.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:W.map(e=>t.jsx("div",{className:`p-3 border rounded-lg cursor-pointer hover-elevate ${q===e.id?"ring-2 ring-primary bg-primary/5":""}`,onClick:()=>w(e.id),"data-testid":`unit-option-${e.id}`,children:t.jsxs("div",{className:"flex justify-between items-start",children:[t.jsxs("div",{children:[t.jsx("p",{className:"font-medium",children:e.unit}),t.jsx("p",{className:"text-sm text-muted-foreground",children:e.tenant})]}),t.jsxs(Ie,{variant:"outline",className:"font-mono text-xs",children:["KSh ",e.rent.toLocaleString()]})]})},e.id))}),W.length===0&&N&&t.jsxs("div",{className:"text-center py-4 text-muted-foreground",children:[t.jsx(De,{className:"h-8 w-8 mx-auto mb-2"}),t.jsxs("p",{children:['No units found matching "',N,'"']})]})]})]}),t.jsxs(_,{children:[t.jsxs(T,{children:[t.jsx(K,{children:"Invoice Details"}),t.jsx(E,{children:"Review and customize the invoice"})]}),t.jsx(M,{className:"space-y-4",children:l?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[t.jsxs("h4",{className:"font-medium",children:[l.unit," - ",l.tenant]}),t.jsx("p",{className:"text-sm text-muted-foreground",children:l.type})]}),c.includes("water")&&t.jsxs("div",{className:"grid grid-cols-2 gap-3 p-3 bg-muted/50 rounded",children:[t.jsxs("div",{children:[t.jsx(u,{className:"text-xs",children:"Units Used"}),t.jsx("p",{className:"font-mono",children:I||0})]}),t.jsxs("div",{children:[t.jsx(u,{className:"text-xs",children:"Rate (KSH)"}),t.jsx("p",{className:"font-mono",children:H.toLocaleString()})]}),t.jsxs("div",{children:[t.jsx(u,{className:"text-xs",children:"Last Reading"}),t.jsx("p",{className:"font-mono",children:f?.readingDate||f?.reading_date?new Date(f?.readingDate??f?.reading_date).toLocaleDateString():"â€”"})]}),t.jsxs("div",{children:[t.jsx(u,{className:"text-xs",children:"Water Charge"}),t.jsxs("p",{className:"font-mono",children:["KSh ",o(b.water).toLocaleString()]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("h4",{className:"font-medium",children:"Invoice Breakdown"}),t.jsx("div",{className:"grid grid-cols-1 gap-3 text-sm",children:c.map(e=>{const s=g.find(d=>d.id===e);if(!s)return null;const a=b[e]??0;return t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsx("span",{children:s.name}),t.jsx(R,{type:"number",value:a,onChange:d=>C(m=>({...m,[e]:o(d.target.value)})),className:"h-8 w-28 font-mono"})]},e)})}),c.length>0&&t.jsx("div",{className:"pt-2 border-t",children:t.jsxs("div",{className:"flex justify-between font-medium",children:[t.jsx("span",{children:"Total:"}),t.jsxs("span",{className:"font-mono",children:["KSh ",X().toLocaleString()]})]})})]}),t.jsxs(Re,{onClick:ge,className:"w-full",disabled:U||c.length===0||Z.isPending,"data-testid":"button-submit-invoice",children:[t.jsx(Ae,{className:"h-4 w-4 mr-2"}),"Submit Invoice"]})]}):t.jsxs("div",{className:"text-center py-12",children:[t.jsx(Le,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium mb-2",children:"Select a Unit"}),t.jsx("p",{className:"text-muted-foreground",children:"Search and select a unit to create an invoice"})]})})]})]})]})}export{$e as SingleInvoicing};
