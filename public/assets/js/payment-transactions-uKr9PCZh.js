import{a as se,b as ae,d as N,f as k,j as e,T as M,x as i,C as O,G as K,I as te,S as v,r as w,s as S,v as C,w as c,z as ne,A as le,aw as $,E as re,L as B,aa as ie,ab as ce,ac as G,ad as d,ae as de,af as o,aB as oe,M as me,y as m,H as xe,ax as he,ai as pe,D as H,g as U,h as V,i as z,k as Q,K as l,a0 as x,q as je,aA as ue,aq as ye}from"./index-D3-Phv8z.js";import{r as h}from"./vendor-BBpupLJz.js";import{D as ge}from"./download-BIGyNlOu.js";import{C as fe}from"./circle-x-WQ2m2kCb.js";function Ce(){const[y,X]=h.useState(""),[g,J]=h.useState("all"),[t,P]=h.useState(null),[W,D]=h.useState(!1),[Y,p]=h.useState(!1),{toast:j}=se(),{selectedPropertyId:a,selectedLandlordId:n}=ae(),b=!a,{data:A=[],isLoading:Z,error:T}=N({queryKey:["/api/payments",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const r=`/api/payments${s.toString()?`?${s}`:""}`;return await(await x("GET",r)).json()}}),{data:L=[]}=N({queryKey:["/api/tenants",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const r=`/api/tenants${s.toString()?`?${s}`:""}`;return await(await x("GET",r)).json()}}),{data:E=[]}=N({queryKey:["/api/invoices",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const r=`/api/invoices${s.toString()?`?${s}`:""}`;return await(await x("GET",r)).json()}}),F=k({mutationFn:s=>{if(b)throw new Error("Select a property in the header to generate receipts.");return x("POST",`/api/payments/${s}/receipt`)},onSuccess:()=>{j({title:"Receipt Generated",description:"Payment receipt has been generated successfully."})},onError:s=>{j({title:"Error",description:s.message||"Failed to generate receipt",variant:"destructive"})}}),f=k({mutationFn:s=>{if(b)throw new Error("Select a property in the header to allocate payments.");return x("POST",`/api/payments/${t.id}/allocate`,s)},onSuccess:()=>{je.invalidateQueries({queryKey:["/api/payments"]}),p(!1),j({title:"Payment Allocated",description:"Payment has been allocated successfully."})},onError:s=>{j({title:"Error",description:s.message||"Failed to allocate payment",variant:"destructive"})}}),I=Array.isArray(A)?A.filter(s=>{const r=s.reference?.toLowerCase().includes(y.toLowerCase())||s.notes?.toLowerCase().includes(y.toLowerCase()),u=g==="all"||s.status===g;return r&&u}):[],_=s=>{F.mutate(s)},ee=s=>{f.mutate(s)},R=s=>{switch(s){case"completed":return e.jsx(ye,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(ue,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(fe,{className:"h-4 w-4 text-red-500"});default:return e.jsx(M,{className:"h-4 w-4 text-gray-500"})}},q=s=>{switch(s){case"completed":return e.jsx(m,{variant:"default",className:"bg-green-500",children:"Completed"});case"pending":return e.jsx(m,{variant:"secondary",className:"bg-yellow-500 text-white",children:"Pending"});case"failed":return e.jsx(m,{variant:"destructive",children:"Failed"});default:return e.jsx(m,{variant:"outline",children:"Unknown"})}};return T?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-2 text-destructive",children:[e.jsx(M,{className:"h-4 w-4"}),e.jsxs("span",{children:["Error loading payments: ",T.message]})]})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"payments-title",children:"Payment Transactions"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage incoming payments and generate receipts"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(i,{variant:"outline","data-testid":"button-export-payments",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Export"]})})]}),e.jsx(O,{children:e.jsx(K,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(te,{placeholder:"Search payments by reference or notes...",value:y,onChange:s=>X(s.target.value),className:"max-w-sm"})}),e.jsxs(v,{value:g,onValueChange:J,children:[e.jsx(w,{className:"w-48",children:e.jsx(S,{placeholder:"Filter by status"})}),e.jsxs(C,{children:[e.jsx(c,{value:"all",children:"All Status"}),e.jsx(c,{value:"completed",children:"Completed"}),e.jsx(c,{value:"pending",children:"Pending"}),e.jsx(c,{value:"failed",children:"Failed"})]})]})]})})}),e.jsxs(O,{children:[e.jsxs(ne,{children:[e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),"Payment Transactions"]}),e.jsxs(re,{children:[I.length," payment(s) found"]})]}),e.jsx(K,{children:Z?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(B,{className:"h-8 w-8 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Loading payments..."})]}):e.jsxs(ie,{children:[e.jsx(ce,{children:e.jsxs(G,{children:[e.jsx(d,{children:"Date"}),e.jsx(d,{children:"Amount"}),e.jsx(d,{children:"Method"}),e.jsx(d,{children:"Reference"}),e.jsx(d,{children:"Status"}),e.jsx(d,{children:"Actions"})]})}),e.jsx(de,{children:I.map(s=>e.jsxs(G,{children:[e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),new Date(s.paymentDate).toLocaleDateString()]})}),e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-4 w-4 text-green-500"}),e.jsxs("span",{className:"font-mono font-semibold",children:["KSh ",parseFloat(s.amount).toLocaleString()]})]})}),e.jsx(o,{children:e.jsx(m,{variant:"outline",children:s.paymentMethod})}),e.jsx(o,{className:"font-mono text-sm",children:s.reference||"N/A"}),e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[R(s.status),q(s.status)]})}),e.jsx(o,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{P(s),D(!0)},children:[e.jsx(xe,{className:"h-3 w-3 mr-1"}),"View"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>_(s.id),disabled:F.isPending,children:[e.jsx(he,{className:"h-3 w-3 mr-1"}),"Receipt"]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>{P(s),p(!0)},children:[e.jsx(pe,{className:"h-3 w-3 mr-1"}),"Allocate"]})]})})]},s.id))})]})})]}),e.jsx(H,{open:W,onOpenChange:D,children:e.jsxs(U,{className:"max-w-2xl",children:[e.jsxs(V,{children:[e.jsxs(z,{className:"flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5"}),"Payment Details"]}),e.jsx(Q,{children:"Detailed information about the payment transaction"})]}),t&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Payment Date"}),e.jsx("p",{className:"text-sm",children:new Date(t.paymentDate).toLocaleDateString()})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Amount"}),e.jsxs("p",{className:"text-sm font-mono font-semibold",children:["KSh ",parseFloat(t.amount).toLocaleString()]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Payment Method"}),e.jsx("p",{className:"text-sm",children:t.paymentMethod})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Reference"}),e.jsx("p",{className:"text-sm font-mono",children:t.reference||"N/A"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Status"}),e.jsxs("div",{className:"flex items-center gap-2",children:[R(t.status),q(t.status)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Notes"}),e.jsx("p",{className:"text-sm",children:t.notes||"No notes"})]})]})})]})}),e.jsx(H,{open:Y,onOpenChange:p,children:e.jsxs(U,{className:"max-w-md",children:[e.jsxs(V,{children:[e.jsx(z,{children:"Allocate Payment"}),e.jsx(Q,{children:"Assign this payment to a specific tenant and invoice"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Select Tenant"}),e.jsxs(v,{children:[e.jsx(w,{children:e.jsx(S,{placeholder:"Choose a tenant"})}),e.jsx(C,{children:Array.isArray(L)?L.map(s=>e.jsx(c,{value:s.id,children:s.fullName},s.id)):null})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Select Invoice (Optional)"}),e.jsxs(v,{children:[e.jsx(w,{children:e.jsx(S,{placeholder:"Choose an invoice"})}),e.jsx(C,{children:Array.isArray(E)?E.map(s=>e.jsxs(c,{value:s.id,children:[s.invoiceNumber," - KSh ",parseFloat(s.amount).toLocaleString()]},s.id)):null})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(i,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsxs(i,{onClick:()=>ee({}),disabled:f.isPending,children:[f.isPending&&e.jsx(B,{className:"h-4 w-4 mr-2 animate-spin"}),"Allocate Payment"]})]})]})]})})]})}export{Ce as PaymentTransactions};
