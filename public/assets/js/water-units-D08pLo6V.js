import{a as ye,b as we,d as U,f as Q,j as e,K as C,S as _,r as J,s as X,v as Z,w as $,C as x,z as g,A as h,aD as ve,G as p,aj as Ne,aE as ee,E as T,I as q,x as Se,ac as te,ad as se,ae as A,af as d,ag as ne,ah as l,y as K,a0 as w,q as ae}from"./index-BtknkMaH.js";import{r as v}from"./vendor-Dl_IvdXv.js";import{T as Re,a as be,b as W,c as D}from"./tabs-_ak9GdYN.js";import{S as Te}from"./save-C_i1zYqs.js";function Ee(){const{toast:f}=ye(),{selectedPropertyId:c,selectedLandlordId:u}=we(),[y,re]=v.useState("all-properties"),[o,F]=v.useState({unitId:"",reading:""}),[ie,de]=v.useState({}),[B,E]=v.useState(new Set),[H,k]=v.useState(new Set),{data:N=[],isLoading:le}=U({queryKey:["/api/units",c,u],queryFn:async()=>{const t=new URLSearchParams;c&&t.append("propertyId",c),u&&t.append("landlordId",u);const s=`/api/units${t.toString()?`?${t}`:""}`;return await(await w("GET",s)).json()}}),{data:S=[],isLoading:Ie}=U({queryKey:["/api/properties",u,c],queryFn:async()=>{const t=new URLSearchParams;u&&t.append("landlordId",u),c&&t.append("propertyId",c);const s=`/api/properties${t.toString()?`?${t}`:""}`;return await(await w("GET",s)).json()}}),{data:I=[],isLoading:oe}=U({queryKey:["/api/water-readings",c,u],queryFn:async()=>{const t=new URLSearchParams;c&&t.append("propertyId",c),u&&t.append("landlordId",u);const s=`/api/water-readings${t.toString()?`?${t}`:""}`;return await(await w("GET",s)).json()}}),{data:ce=[]}=U({queryKey:["/api/leases",c,u],queryFn:async()=>{const t=new URLSearchParams;c&&t.append("propertyId",c),u&&t.append("landlordId",u);const s=`/api/leases${t.toString()?`?${t}`:""}`;return await(await w("GET",s)).json()}}),P=Q({mutationFn:async t=>await w("POST","/api/water-readings",t),onSuccess:()=>{ae.invalidateQueries({queryKey:["/api/water-readings"]}),F({unitId:"",reading:""}),f({title:"Success",description:"Water reading saved successfully"})},onError:t=>{f({title:"Error",description:t.message||"Failed to save water reading",variant:"destructive"})}}),ue=Q({mutationFn:async t=>(console.log("ðŸš€ Bulk save mutation starting for unit:",t.unitId),await w("POST","/api/water-readings",t)),onSuccess:(t,s)=>{console.log("âœ… Bulk save SUCCESS for unit:",s.unitId),E(n=>{const a=new Set(n);return a.delete(s.unitId),console.log("ðŸ”„ Removing from savingUnits:",s.unitId,"New set:",a),a}),k(n=>{const a=new Set(n).add(s.unitId);return console.log("âœ… Adding to savedUnits:",s.unitId,"New set:",a),a}),ae.invalidateQueries({queryKey:["/api/water-readings"]}),setTimeout(()=>{k(n=>{const a=new Set(n);return a.delete(s.unitId),console.log("ðŸ”„ Auto-removing from savedUnits:",s.unitId,"New set:",a),a})},3e3)},onError:(t,s)=>{console.log("âŒ Bulk save ERROR for unit:",s.unitId,t),E(n=>{const a=new Set(n);return a.delete(s.unitId),a}),f({title:"Error",description:`Failed to save reading for ${O(s.unitId)}: ${t.message}`,variant:"destructive"})}}),[V,me]=v.useState({}),xe=(t,s)=>{if(console.log("ðŸ“ Input change for unit:",t,"value:",s),de(n=>({...n,[t]:s})),k(n=>{const a=new Set(n);return a.delete(t),console.log("ðŸ§¹ Clearing saved status for:",t),a}),V[t]&&(console.log("â° Clearing existing timeout for:",t),clearTimeout(V[t])),s&&s.trim()!==""&&!isNaN(Number(s))){console.log("âœ… Valid value, setting timeout for:",t);const n=setTimeout(()=>{console.log("â±ï¸ Timeout triggered for unit:",t,"Setting saving state..."),E(i=>{const r=new Set(i).add(t);return console.log("ðŸ’¾ Adding to savingUnits:",t,"New set:",r),r});const a=new Date().toISOString().split("T")[0];ue.mutate({unitId:t,currentReading:s,readingDate:a})},1500);me(a=>({...a,[t]:n}))}},j=y==="all"?N:N.filter(t=>t.propertyId===y),ge=new Set(j.map(t=>t.id)),R=I.filter(t=>ge.has(t.unitId)),G=R.filter(t=>{const s=new Date(t.readingDate),n=new Date;return s.getMonth()===n.getMonth()&&s.getFullYear()===n.getFullYear()}),he=new Set(G.map(t=>t.unitId)).size,b={totalUnits:j.length,unitsWithReadingsThisMonth:he,readingsThisMonth:G.length,totalConsumption:R.reduce((t,s)=>t+parseFloat(s.consumption),0),totalAmountConsumed:R.reduce((t,s)=>t+parseFloat(s.totalAmount),0)},pe=()=>{if(!o.unitId||!o.reading){f({title:"Error",description:"Please select a unit and enter a reading",variant:"destructive"});return}const t=parseFloat(o.reading);if(isNaN(t)||t<0){f({title:"Error",description:"Please enter a valid positive number for the reading",variant:"destructive"});return}const n=I.filter(r=>r.unitId===o.unitId).sort((r,m)=>new Date(m.readingDate).getTime()-new Date(r.readingDate).getTime())[0];if(n&&t<parseFloat(n.currentReading)){f({title:"Error",description:`Current reading (${t}) cannot be less than the previous reading (${n.currentReading})`,variant:"destructive"});return}if(!N.find(r=>r.id===o.unitId))return;M(o.unitId);const i=new Date().toISOString().split("T")[0];P.mutate({unitId:o.unitId,currentReading:t.toString(),readingDate:i})},O=t=>{const s=N.find(n=>n.id===t);return s?s.unitNumber:"Unknown"},L=t=>{const s=N.find(a=>a.id===t);if(!s)return"Unknown";const n=S.find(a=>a.id===s.propertyId);return n?n.name:"Unknown"},M=t=>{const s=ce.find(n=>n.unitId===t);return s?parseFloat(s.waterRatePerUnit):15.5},je=t=>I.filter(n=>n.unitId===t).sort((n,a)=>new Date(a.readingDate).getTime()-new Date(n.readingDate).getTime())[0]||null,Y=t=>{const s=new Date().getMonth(),n=new Date().getFullYear(),a=I.filter(i=>{const r=i.lastModifiedAt||i.createdAt;if(!r)return!1;const m=new Date(r);return i.unitId===t&&m.getMonth()===s&&m.getFullYear()===n}).sort((i,r)=>{const m=i.lastModifiedAt||i.createdAt,z=r.lastModifiedAt||r.createdAt;if(!m||!z)return 0;const fe=new Date(m).getTime();return new Date(z).getTime()-fe})[0];if(a){const i=a.lastModifiedAt||a.createdAt;if(i)return new Date(i).toLocaleString()}return null};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"heading-water-units",children:"Water Units"}),e.jsx("p",{className:"text-muted-foreground",children:"Record water meter readings and track consumption across all properties"})]})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{htmlFor:"property-filter",children:"Filter by Property:"}),e.jsxs(_,{value:y,onValueChange:re,children:[e.jsx(J,{className:"w-64","data-testid":"select-property-filter",children:e.jsx(X,{placeholder:"All Properties"})}),e.jsxs(Z,{children:[e.jsx($,{value:"all-properties",children:"All Properties"}),Array.isArray(S)?S.map(t=>e.jsx($,{value:t.id,children:t.name},t.id)):null]})]})]}),y!=="all-properties"&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing water readings for ",Array.isArray(S)?S.find(t=>t.id===y)?.name:"Unknown"," (",j.length," units)"]}),y==="all-properties"&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing water readings for all properties (",j.length," units)"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsxs(x,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:"Total Units"}),e.jsx(ve,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-total-units",children:b.totalUnits}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Units with water meters"})]})]}),e.jsxs(x,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:"This Month"}),e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(p,{children:[e.jsxs("div",{className:"text-2xl font-bold","data-testid":"text-readings-this-month",children:[b.unitsWithReadingsThisMonth,"/",b.totalUnits]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Recorded units/Total units"})]})]}),e.jsxs(x,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:"Total Consumption"}),e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(p,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-total-consumption",children:b.totalConsumption.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cubic meters (mÂ³)"})]})]}),e.jsxs(x,{children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(h,{className:"text-sm font-medium",children:"Total Amount Consumed"}),e.jsx(ee,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(p,{children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600","data-testid":"text-total-amount-consumed",children:["KSH ",b.totalAmountConsumed.toLocaleString()]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Total monetary value"})]})]})]}),e.jsxs(x,{children:[e.jsxs(g,{children:[e.jsx(h,{children:"All Property Accounts"}),e.jsx(T,{children:"Showing water readings for all properties and units"})]}),e.jsx(p,{children:e.jsx("div",{className:"text-sm text-muted-foreground",children:"Property filtering removed - displaying all accounts by default as requested"})})]}),e.jsxs(Re,{defaultValue:"bulk-entry",className:"space-y-6",children:[e.jsxs(be,{children:[e.jsx(W,{value:"bulk-entry",children:"Bulk Entry"}),e.jsx(W,{value:"readings-history",children:"Readings History"}),e.jsx(W,{value:"consumption-analysis",children:"Consumption Analysis"})]}),e.jsx(D,{value:"add-reading",className:"space-y-6",children:e.jsxs(x,{children:[e.jsxs(g,{children:[e.jsx(h,{children:"Add Water Reading"}),e.jsx(T,{children:"Enter current meter readings for units. Click Save Reading to record the data. The system will automatically calculate consumption and costs."})]}),e.jsxs(p,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"unit-select",children:"Unit"}),e.jsxs(_,{value:o.unitId,onValueChange:t=>F(s=>({...s,unitId:t})),"data-testid":"select-unit",children:[e.jsx(J,{children:e.jsx(X,{placeholder:"Select unit"})}),e.jsx(Z,{children:j.map(t=>e.jsxs($,{value:t.id,children:[t.unitNumber," - ",L(t.id)]},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{htmlFor:"current-reading",children:"Current Reading (mÂ³)"}),e.jsx(q,{id:"current-reading",type:"number",placeholder:"Enter meter reading",value:o.reading,onChange:t=>F(s=>({...s,reading:t.target.value})),"data-testid":"input-current-reading"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{children:"Rate per Unit"}),e.jsx(q,{value:o.unitId?`KSH ${M(o.unitId).toFixed(2)} per mÂ³`:"Select unit to see rate",disabled:!0})]})]}),e.jsx("div",{className:"flex gap-4",children:e.jsxs(Se,{onClick:pe,disabled:P.isPending||!o.unitId||!o.reading,"data-testid":"button-save-reading",children:[e.jsx(Te,{className:"h-4 w-4 mr-2"}),P.isPending?"Saving...":"Save Reading"]})})]})]})}),e.jsx(D,{value:"bulk-entry",className:"space-y-6",children:e.jsxs(x,{children:[e.jsxs(g,{children:[e.jsx(h,{children:"Bulk Water Reading Entry"}),e.jsx(T,{children:"Enter readings for multiple units at once. Changes are automatically saved after you stop typing."})]}),e.jsx(p,{children:le?e.jsx("div",{className:"text-center py-8",children:"Loading units..."}):j.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No units available for bulk entry."}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-4",children:"ðŸ’¡ Tip: Enter readings and they'll save automatically. Green checkmarks show saved readings."}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(te,{children:[e.jsx(se,{children:e.jsxs(A,{children:[e.jsx(d,{className:"w-32",children:"Unit"}),e.jsx(d,{children:"Property"}),e.jsx(d,{className:"w-40",children:"Water Rate"}),e.jsx(d,{className:"w-40",children:"Last Reading"}),e.jsx(d,{className:"w-48",children:"New Reading (mÂ³)"}),e.jsx(d,{className:"w-32 text-right",children:"Amount"}),e.jsx(d,{className:"w-40 text-center",children:"Date Modified"})]})}),e.jsx(ne,{children:j.map(t=>{const s=je(t.id),n=M(t.id),a=ie[t.id]||"",i=B.has(t.id),r=H.has(t.id);return console.log("ðŸŽ¨ RENDER unit:",t.id,"isSaving:",i,"isSaved:",r,"savedUnits:",Array.from(H),"savingUnits:",Array.from(B)),e.jsxs(A,{"data-testid":`row-bulk-unit-${t.id}`,children:[e.jsx(l,{className:"font-medium",children:t.unitNumber}),e.jsx(l,{className:"text-sm text-muted-foreground",children:L(t.id)}),e.jsxs(l,{className:"text-sm",children:["KSH ",n.toFixed(2)," per mÂ³"]}),e.jsx(l,{className:"text-sm",children:s?`${s.currentReading} mÂ³`:"No previous reading"}),e.jsx(l,{children:e.jsxs("div",{className:"relative",children:[e.jsx(q,{type:"number",placeholder:"Enter reading",value:a,onChange:m=>xe(t.id,m.target.value),className:`pr-8 ${r?"border-green-500":""}`,"data-testid":`input-bulk-reading-${t.id}`}),i&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"})})]})}),e.jsxs(l,{className:"text-right",children:[a&&e.jsxs("div",{className:"font-medium text-primary",children:["KSH ",(parseFloat(a)*n).toFixed(2)]}),!a&&e.jsx("div",{className:"text-muted-foreground text-sm",children:"-"})]}),e.jsxs(l,{className:"text-center",children:[i&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(K,{variant:"secondary",children:"Saving..."})}),!i&&Y(t.id)&&e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs(K,{variant:"secondary",className:`text-xs ${r?"bg-green-100 text-green-800 animate-pulse":"bg-gray-100 text-gray-700"}`,children:["âœ“ ",Y(t.id)]})})]})]},t.id)})})]})}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Showing ",j.length," units"]})]})})]})}),e.jsx(D,{value:"readings-history",className:"space-y-6",children:e.jsxs(x,{children:[e.jsxs(g,{children:[e.jsx(h,{children:"Water Readings History"}),e.jsx(T,{children:"View all recorded water meter readings and calculated consumption"})]}),e.jsx(p,{children:oe?e.jsx("div",{className:"text-center py-8",children:"Loading readings..."}):R.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No water readings recorded yet. Use bulk entry to get started."}):e.jsxs(te,{children:[e.jsx(se,{children:e.jsxs(A,{children:[e.jsx(d,{children:"Unit"}),e.jsx(d,{children:"Property"}),e.jsx(d,{children:"Reading Date"}),e.jsx(d,{children:"Current Reading"}),e.jsx(d,{children:"Previous Reading"}),e.jsx(d,{children:"Consumption (mÂ³)"}),e.jsx(d,{children:"Total Amount"})]})}),e.jsx(ne,{children:R.map(t=>e.jsxs(A,{"data-testid":`row-reading-${t.id}`,children:[e.jsx(l,{className:"font-medium",children:O(t.unitId)}),e.jsx(l,{children:L(t.unitId)}),e.jsx(l,{children:new Date(t.readingDate).toLocaleDateString()}),e.jsx(l,{children:t.currentReading}),e.jsx(l,{children:t.previousReading}),e.jsx(l,{children:e.jsx(K,{variant:"outline",children:parseFloat(t.consumption).toFixed(2)})}),e.jsxs(l,{className:"font-medium",children:["KSH ",parseFloat(t.totalAmount).toLocaleString()]})]},t.id))})]})})]})}),e.jsx(D,{value:"consumption-analysis",className:"space-y-6",children:e.jsxs(x,{children:[e.jsxs(g,{children:[e.jsx(h,{children:"Consumption Analysis"}),e.jsx(T,{children:"Analyze water consumption patterns and trends"})]}),e.jsx(p,{children:e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:["Consumption analysis charts and trends will be implemented here.",e.jsx("br",{}),"This feature will show consumption patterns, usage trends, and cost analysis."]})})]})})]})]})}export{Ee as WaterUnits};
