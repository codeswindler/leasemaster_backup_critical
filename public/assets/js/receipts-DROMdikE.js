import{a as de,b as ce,d as x,j as e,C as P,G as $,x as w,ax as _,I as le,S as me,r as ue,s as xe,v as pe,w as C,z as he,A as je,E as fe,aa as ge,ab as ye,ac as O,ad as l,ae as ve,af as m,H as Ne,D as Se,g as we,h as De,i as Le,k as be,K as d,a9 as Ie,y as D,a0 as p}from"./index-D3-Phv8z.js";import{r as E,Y as Re,Z as Pe}from"./vendor-BBpupLJz.js";import{D as W}from"./download-BIGyNlOu.js";function Fe(){const[L,X]=E.useState(""),[N,Z]=E.useState("all"),[i,b]=E.useState(null),{toast:I}=de(),{selectedPropertyId:a,selectedLandlordId:n}=ce(),R=!a,h=x({queryKey:["/api/payments",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/payments${s.toString()?`?${s}`:""}`;return await(await p("GET",t)).json()}}),j=x({queryKey:["/api/tenants",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/tenants${s.toString()?`?${s}`:""}`;return await(await p("GET",t)).json()}}),f=x({queryKey:["/api/units",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/units${s.toString()?`?${s}`:""}`;return await(await p("GET",t)).json()}}),u=x({queryKey:["/api/properties",n,a],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("landlordId",n),a&&s.append("propertyId",a);const t=`/api/properties${s.toString()?`?${s}`:""}`;return await(await p("GET",t)).json()}}),J=x({queryKey:["/api/settings/invoice",n,a],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("landlordId",n),a&&s.append("propertyId",a);const t=`/api/settings/invoice${s.toString()?`?${s}`:""}`;return await(await p("GET",t)).json()}}),g=x({queryKey:["/api/leases",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/leases${s.toString()?`?${s}`:""}`;return await(await p("GET",t)).json()}}),y=x({queryKey:["/api/invoices",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/invoices${s.toString()?`?${s}`:""}`;return await(await p("GET",t)).json()}}),ee=h.data||[],se=j.data||[],te=f.data||[],ae=u.data||[],ne=g.data||[],ie=y.data||[],T=[h.status==="success",j.status==="success",f.status==="success",u.status==="success",g.status==="success",y.status==="success"].every(Boolean),F=[h.isLoading,j.isLoading,f.isLoading,u.isLoading,g.isLoading,y.isLoading].some(Boolean),re=[h.error,j.error,f.error,u.error,g.error,y.error].some(Boolean),A=ee.map(s=>{const t=ne.find(o=>o.id===s.leaseId),r=t&&t.tenantId?se.find(o=>o.id===t.tenantId):null,c=t&&t.unitId?te.find(o=>o.id===t.unitId):null,S=c&&c.propertyId?ae.find(o=>o.id===c.propertyId):null,v=s.invoiceId?ie.find(o=>o.id===s.invoiceId):null;return{id:`RCP-${s.id.slice(-8).toUpperCase()}`,paymentId:s.id,tenant:r?`${r.firstName||""} ${r.lastName||""}`.trim():"Direct Payment",unit:c?.number||"N/A",property:S?.name||"N/A",amount:s.amount||0,paymentDate:s.paymentDate,paymentMethod:s.paymentMethod||"Unknown",reference:s.reference||"N/A",status:s.status||"verified",tenantPhone:r?.phone||"",tenantEmail:r?.email||"",unitDetails:c,propertyDetails:S,leaseDetails:t,invoiceNumber:v?.invoiceNumber||"",description:s.description||"Payment received"}}),q=A.filter(s=>{if(!L.trim())return N==="all"||s.status===N;const t=L.toLowerCase(),r=s.id&&s.id.toLowerCase().includes(t)||s.tenant&&s.tenant.toLowerCase().includes(t)||s.unit&&s.unit.toLowerCase().includes(t)||s.reference&&s.reference.toLowerCase().includes(t),c=N==="all"||s.status===N;return r&&c}),U=s=>{if(R){I({title:"Property Required",description:"Select a property in the header to download receipts.",variant:"destructive"});return}try{const t=new Re,r=s.paymentDate||Date.now(),c=new Date(r).toISOString().slice(0,10),S=s.unit?String(s.unit).replace(/\s+/g,"-"):"unit",v=J.data||{},o=v.company_name||"Company",z=v.company_phone||"",G=v.company_email||"",Q=v.company_address||"",B=(Array.isArray(u.data)?u.data:[]).find(Y=>Y.id===s.propertyId||Y.name===s.property),M=B?.accountPrefix??B?.account_prefix??"",k=M&&s.unit?`${M}${s.unit}`:"";t.setFontSize(14),t.text(o.toUpperCase(),20,20),t.setFontSize(9),Q&&t.text(Q,20,26),z&&t.text(`Tel: ${z}`,20,31),G&&t.text(`Email: ${G}`,20,36),t.setFontSize(11),t.text("RECEIPT",150,20),t.setFontSize(9),t.text(`Date: ${new Date(r).toLocaleDateString()}`,150,26),t.text(`Receipt No: ${s.reference||s.id}`,150,31),t.line(20,42,190,42),t.setFontSize(10),t.text("RECEIVED FROM",20,52),t.text(String(s.tenant||"Tenant"),20,58),s.tenantEmail&&t.text(String(s.tenantEmail),20,63),s.tenantPhone&&t.text(String(s.tenantPhone),20,68),t.text("PROPERTY",120,52),t.text(String(s.property||"—"),120,58),t.text(`House: ${s.unit||"—"}`,120,63),k&&t.text(`Account: ${k}`,120,68),Pe(t,{head:[["Description","Amount"]],body:[[s.description||"Payment",`KES ${Number(s.amount||0).toLocaleString()}`]],startY:78,theme:"grid",headStyles:{fillColor:[56,78,84],textColor:255},styles:{fontSize:9}});const V=t.lastAutoTable?.finalY||110;t.setFontSize(10),t.text(`Amount Received: KES ${Number(s.amount||0).toLocaleString()}`,120,V+12),s.balance!==void 0&&t.text(`Current Balance: KES ${Number(s.balance||0).toLocaleString()}`,120,V+18);const H=`${S}-${c}-receipt.pdf`;t.save(H),I({title:"Receipt Downloaded",description:`${H} has been downloaded successfully`})}catch(t){console.error("Download error:",t),I({title:"Download Failed",description:"Failed to generate receipt PDF",variant:"destructive"})}},oe=s=>{b(s)},K=s=>{switch(s){case"verified":return e.jsx(D,{variant:"default",className:"bg-green-100 text-green-800",children:"Verified"});case"pending":return e.jsx(D,{variant:"secondary",children:"Pending"});case"failed":return e.jsx(D,{variant:"destructive",children:"Failed"});default:return e.jsx(D,{variant:"outline",children:"Unknown"})}};return re?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"receipts-title",children:"Receipts"}),e.jsx("p",{className:"text-muted-foreground",children:"Error loading receipt data"})]})}),e.jsx(P,{children:e.jsx($,{className:"p-6",children:e.jsxs("div",{className:"text-center text-red-500 space-y-2",children:[e.jsx("div",{children:"Failed to load receipts data. Please try again."}),e.jsxs("div",{className:"text-sm",children:[h.error&&"• Payments data failed",j.error&&"• Tenants data failed",f.error&&"• Units data failed",u.error&&"• Properties data failed",g.error&&"• Leases data failed",y.error&&"• Invoices data failed"]})]})})})]}):F||!T?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"receipts-title",children:"Receipts"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading payment receipts and related data..."})]})}),e.jsx(P,{children:e.jsx($,{className:"p-6",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{children:"Loading receipts data..."}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[h.isLoading&&"• Loading payments...",j.isLoading&&"• Loading tenants...",f.isLoading&&"• Loading units...",u.isLoading&&"• Loading properties...",g.isLoading&&"• Loading leases...",y.isLoading&&"• Loading invoices...",!F&&!T&&"• Waiting for all data to be ready..."]})]})})})]}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"receipts-title",children:"Receipts"}),e.jsx("p",{className:"text-muted-foreground",children:"View and manage payment receipts"})]}),e.jsxs(w,{"data-testid":"button-generate-receipt",children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Generate Receipt"]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(le,{placeholder:"Search receipts...",value:L,onChange:s=>X(s.target.value),className:"max-w-sm","data-testid":"input-search-receipts"})}),e.jsxs(me,{value:N,onValueChange:Z,children:[e.jsx(ue,{className:"w-48","data-testid":"select-status-filter",children:e.jsx(xe,{placeholder:"Filter by status"})}),e.jsxs(pe,{children:[e.jsx(C,{value:"all",children:"All Statuses"}),e.jsx(C,{value:"verified",children:"Verified"}),e.jsx(C,{value:"pending",children:"Pending"})]})]})]}),e.jsxs(P,{children:[e.jsxs(he,{children:[e.jsx(je,{children:"Payment Receipts"}),e.jsxs(fe,{children:["Showing ",q.length," of ",A.length," receipts"]})]}),e.jsx($,{children:e.jsxs(ge,{children:[e.jsx(ye,{children:e.jsxs(O,{children:[e.jsx(l,{children:"Receipt ID"}),e.jsx(l,{children:"Tenant"}),e.jsx(l,{children:"Unit"}),e.jsx(l,{children:"Amount"}),e.jsx(l,{children:"Payment Date"}),e.jsx(l,{children:"Method"}),e.jsx(l,{children:"Reference"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Actions"})]})}),e.jsx(ve,{children:q.map(s=>e.jsxs(O,{className:"hover-elevate",children:[e.jsx(m,{className:"font-mono text-sm",children:s.id}),e.jsx(m,{className:"font-medium",children:s.tenant}),e.jsx(m,{children:s.unit}),e.jsxs(m,{className:"font-mono",children:["KSh ",s.amount.toLocaleString()]}),e.jsx(m,{children:new Date(s.paymentDate).toLocaleDateString()}),e.jsx(m,{children:s.paymentMethod}),e.jsx(m,{className:"font-mono text-sm",children:s.reference}),e.jsx(m,{children:K(s.status)}),e.jsx(m,{children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(w,{variant:"ghost",size:"sm","data-testid":`button-view-${s.id}`,onClick:()=>oe(s),children:e.jsx(Ne,{className:"h-4 w-4"})}),e.jsx(w,{variant:"ghost",size:"sm","data-testid":`button-download-${s.id}`,disabled:R,onClick:()=>U(s),children:e.jsx(W,{className:"h-4 w-4"})})]})})]},s.id))})]})})]}),e.jsx(Se,{open:!!i,onOpenChange:s=>!s&&b(null),children:e.jsxs(we,{className:"max-w-md",children:[e.jsxs(De,{children:[e.jsxs(Le,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5"}),"Receipt Details"]}),e.jsx(be,{children:"Payment receipt information"})]}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Receipt ID"}),e.jsx("p",{className:"font-mono text-sm",children:i.id})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Date"}),e.jsx("p",{className:"text-sm",children:new Date(i.paymentDate).toLocaleDateString()})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Tenant"}),e.jsx("p",{className:"font-medium",children:i.tenant}),i.tenantPhone&&e.jsx("p",{className:"text-sm text-muted-foreground",children:i.tenantPhone})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Property"}),e.jsx("p",{className:"text-sm",children:i.property})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Unit"}),e.jsx("p",{className:"text-sm",children:i.unit})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Amount"}),e.jsxs("p",{className:"text-lg font-mono font-bold",children:["KSh ",i.amount.toLocaleString()]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Payment Method"}),e.jsx("p",{className:"text-sm",children:i.paymentMethod})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Reference"}),e.jsx("p",{className:"font-mono text-sm",children:i.reference})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Status"}),e.jsx("div",{children:K(i.status)})]}),i.invoiceNumber&&e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Invoice"}),e.jsx("p",{className:"font-mono text-sm",children:i.invoiceNumber})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Description"}),e.jsx("p",{className:"text-sm",children:i.description})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(w,{onClick:()=>U(i),className:"flex-1","data-testid":"button-download-from-modal",disabled:R,children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Download PDF"]}),e.jsxs(w,{variant:"outline",onClick:()=>b(null),"data-testid":"button-close-modal",children:[e.jsx(Ie,{className:"h-4 w-4 mr-2"}),"Close"]})]})]})]})})]})}export{Fe as Receipts};
