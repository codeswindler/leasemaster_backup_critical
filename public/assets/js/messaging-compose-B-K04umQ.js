import{b as be,a as Se,d as b,f as R,j as s,C as _,z as Q,A as V,x as j,E as H,G as J,U as Te,B as we,K as o,I as w,av as W,aw as Ce,ax as Me,y as Ee,S as Y,r as Z,s as ee,v as se,w as S,a6 as Fe,a2 as Ie,a7 as qe,a4 as ae,D as $e,a3 as Pe,g as ke,h as Re,i as De,aG as Ke,az as Le,a0 as p,q as D}from"./index-BtknkMaH.js";import{r as x}from"./vendor-Dl_IvdXv.js";import{T as ze,a as Ue,b as te}from"./tabs-_ak9GdYN.js";function Ae(){const[v,ne]=x.useState("tenants"),[g,y]=x.useState([]),[T,ie]=x.useState(!1),[C,K]=x.useState(""),[M,L]=x.useState(""),[i,z]=x.useState("email"),[U,$]=x.useState(""),[E,P]=x.useState(""),[le,G]=x.useState(!1),[u,N]=x.useState({id:"",name:"",channel:"sms",subject:"",content:"",isSystem:!1}),{selectedPropertyId:l,selectedLandlordId:r}=be(),{toast:c}=Se(),{data:re=[]}=b({queryKey:["/api/tenants",l,r],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),r&&e.append("landlordId",r);const a=`/api/tenants${e.toString()?`?${e}`:""}`;return await(await p("GET",a)).json()}}),{data:ce=[]}=b({queryKey:["/api/landlords"],queryFn:async()=>await(await p("GET","/api/landlords")).json()}),{data:oe=[]}=b({queryKey:["/api/units",l,r],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),r&&e.append("landlordId",r);const a=`/api/units${e.toString()?`?${e}`:""}`;return await(await p("GET",a)).json()}}),{data:de=[]}=b({queryKey:["/api/leases",l,r],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),r&&e.append("landlordId",r);const a=`/api/leases${e.toString()?`?${e}`:""}`;return await(await p("GET",a)).json()}}),{data:me=[]}=b({queryKey:["/api/properties",r,l],queryFn:async()=>{const e=new URLSearchParams;r&&e.append("landlordId",r),l&&e.append("propertyId",l);const a=`/api/properties${e.toString()?`?${e}`:""}`;return await(await p("GET",a)).json()}}),{data:pe=[]}=b({queryKey:["/api/message-templates"],queryFn:async()=>await(await p("GET","/api/message-templates")).json()}),ue=re.map(e=>{const a=de.find(t=>t.tenantId===e.id&&t.status==="active"),n=oe.find(t=>t.id===a?.unitId);return{id:e.id,name:e.fullName,email:e.email,phone:e.phone,unit:n?.unitNumber||"No unit"}}).filter(e=>e.name&&(e.email||e.phone)),he=ce.map(e=>{const a=me.filter(f=>f.landlord_id===e.id),n=e.phone??(a.length>0?a[0].landlord_phone:null),t=e.fullName||e.full_name||e.username;return{id:e.id,name:t,email:e.username,phone:n,properties:a.length}}).filter(e=>e.name),F=v==="tenants"?ue:he,I=pe,xe=(e,a)=>{y(a?[...g,e]:g.filter(n=>n!==e))},je=()=>{y(F.map(e=>e.id))},ge=()=>{y([])},ve=e=>{const a=e.channel??"sms";(a==="email"||a==="sms"||a==="both")&&z(a),$(e.subject||""),P(e.content||e.message||"")},O=()=>{N({id:"",name:"",channel:"sms",subject:"",content:"",isSystem:!1})},X=R({mutationFn:async e=>e.id?await(await p("PUT",`/api/message-templates/${e.id}`,e)).json():await(await p("POST","/api/message-templates",e)).json(),onSuccess:()=>{D.invalidateQueries({queryKey:["/api/message-templates"]}),c({title:"Template saved"}),O()},onError:e=>{c({title:"Template error",description:e.message||"Failed to save template.",variant:"destructive"})}}),ye=R({mutationFn:async e=>(await p("DELETE",`/api/message-templates/${e}`)).ok,onSuccess:()=>{D.invalidateQueries({queryKey:["/api/message-templates"]}),c({title:"Template deleted"})},onError:e=>{c({title:"Delete failed",description:e.message||"Failed to delete template.",variant:"destructive"})}}),fe=e=>{N({id:e.id,name:e.name||"",channel:e.channel||"sms",subject:e.subject||"",content:e.content||"",isSystem:!!(e.is_system??e.isSystem)}),G(!0)},k=R({mutationFn:async e=>{const a=[];if(T){const n=e.type==="both"?["email","sms"]:[e.type];for(const t of n){const f=t==="email"?C:M;if(!f){a.push({channel:t,recipient:"Manual",success:!1,error:`Missing ${t} recipient`});continue}const d=t==="email"?"/api/send-email":"/api/send-sms",m={recipientType:v==="tenants"?"tenant":"landlord",recipientId:null,recipientName:"Manual",propertyId:l||null};t==="email"?(m.to=f,m.toName="Manual",m.subject=e.subject,m.message=e.message):(m.mobile=f,m.message=e.message);try{const h=await(await p("POST",d,m)).json();a.push({channel:t,recipient:"Manual",success:h.success,error:h.error})}catch(q){a.push({channel:t,recipient:"Manual",success:!1,error:q.message})}}return a}for(const n of e.recipients){const t=F.find(d=>d.id===n);if(!t)continue;const f=e.type==="both"?["email","sms"]:[e.type];for(const d of f){const m=d==="email"?t.email:t.phone;if(!m){a.push({channel:d,recipient:t.name,success:!1,error:`Missing ${d} contact`});continue}const q=d==="email"?"/api/send-email":"/api/send-sms",h={recipientType:v==="tenants"?"tenant":"landlord",recipientId:n,recipientName:t.name,propertyId:l||null};d==="email"?(h.to=m,h.toName=t.name,h.subject=e.subject,h.message=e.message):(h.mobile=m,h.message=e.message);try{const B=await(await p("POST",q,h)).json();a.push({channel:d,recipient:t.name,success:B.success,error:B.error})}catch(A){a.push({channel:d,recipient:t.name,success:!1,error:A.message})}}}return a},onSuccess:e=>{if(e.length===0){c({title:"No Recipients",description:"No valid recipients were selected.",variant:"destructive"});return}const a=e.filter(t=>t.success).length,n=e.filter(t=>!t.success).length;D.invalidateQueries({queryKey:["/api/message-recipients"]}),n===0?c({title:"Messages Sent",description:`Successfully sent ${a} message(s).`}):a>0?c({title:"Partial Success",description:`Sent ${a} message(s), ${n} failed.`,variant:"destructive"}):c({title:"Send Failed",description:"All messages failed to send.",variant:"destructive"}),y([]),$(""),P(""),K(""),L("")},onError:e=>{c({title:"Error",description:e.message||"Failed to send messages.",variant:"destructive"})}}),Ne=()=>{if(E.trim()){if(T){if((i==="email"||i==="both")&&!C.trim()){c({title:"Missing Email",description:"Enter a recipient email.",variant:"destructive"});return}if((i==="sms"||i==="both")&&!M.trim()){c({title:"Missing Phone",description:"Enter a recipient phone number.",variant:"destructive"});return}}else if(g.length===0){c({title:"No Recipients",description:"Select at least one recipient.",variant:"destructive"});return}k.mutate({recipients:g,type:i,subject:U,message:E})}};return s.jsxs("div",{className:"p-6 space-y-6",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold","data-testid":"compose-title",children:"Compose Message"}),s.jsx("p",{className:"text-muted-foreground",children:"Send messages to tenants or landlords via email and SMS"})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[s.jsxs(_,{children:[s.jsxs(Q,{children:[s.jsxs(V,{className:"flex items-center justify-between",children:["Recipients",s.jsxs("div",{className:"flex gap-2",children:[s.jsx(j,{variant:"outline",size:"sm",onClick:je,"data-testid":"button-select-all",children:"All"}),s.jsx(j,{variant:"outline",size:"sm",onClick:ge,"data-testid":"button-select-none",children:"None"})]})]}),s.jsx(H,{children:"Select recipients to send message to"})]}),s.jsxs(J,{className:"space-y-4",children:[s.jsx(ze,{value:v,onValueChange:e=>{ne(e),y([])},children:s.jsxs(Ue,{className:"grid w-full grid-cols-2",children:[s.jsxs(te,{value:"tenants",className:"flex items-center gap-2",children:[s.jsx(Te,{className:"h-4 w-4"}),"Tenants"]}),s.jsxs(te,{value:"landlords",className:"flex items-center gap-2",children:[s.jsx(we,{className:"h-4 w-4"}),"Landlords"]})]})}),s.jsx("div",{className:"space-y-3 max-h-[400px] overflow-y-auto",children:T?s.jsxs("div",{className:"space-y-3",children:[(i==="email"||i==="both")&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"manual-email",children:"Recipient Email"}),s.jsx(w,{id:"manual-email",type:"email",placeholder:"recipient@example.com",value:C,onChange:e=>K(e.target.value),"data-testid":"input-manual-email"})]}),(i==="sms"||i==="both")&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"manual-phone",children:"Recipient Phone"}),s.jsx(w,{id:"manual-phone",placeholder:"+2547XXXXXXXX",value:M,onChange:e=>L(e.target.value),"data-testid":"input-manual-phone"})]})]}):F.length===0?s.jsxs("p",{className:"text-sm text-muted-foreground text-center py-4",children:["No ",v," found"]}):F.map(e=>s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx(W,{id:e.id,checked:g.includes(e.id),onCheckedChange:a=>xe(e.id,!!a),"data-testid":`checkbox-${v}-${e.id}`}),s.jsx(Ce,{className:"h-8 w-8",children:s.jsx(Me,{className:"text-xs",children:e.name.split(" ").map(a=>a[0]).join("").slice(0,2)})}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsx("p",{className:"text-sm font-medium truncate",children:e.name}),s.jsx("p",{className:"text-xs text-muted-foreground truncate",children:v==="tenants"?e.unit:`${e.properties} properties`})]})]},e.id))}),g.length>0&&s.jsx("div",{className:"pt-3 border-t",children:s.jsxs(Ee,{variant:"secondary",children:[g.length," selected"]})}),s.jsx("div",{className:"pt-3 border-t",children:s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(W,{id:"manual-recipient",checked:T,onCheckedChange:e=>{ie(!!e),y([])}}),s.jsx(o,{htmlFor:"manual-recipient",children:"Manual recipient"})]})})]})]}),s.jsxs(_,{className:"lg:col-span-2",children:[s.jsxs(Q,{children:[s.jsx(V,{children:"Message Details"}),s.jsx(H,{children:"Compose your message"})]}),s.jsxs(J,{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{children:"Message Type"}),s.jsxs(Y,{value:i,onValueChange:e=>z(e),children:[s.jsx(Z,{"data-testid":"select-message-type",children:s.jsx(ee,{})}),s.jsxs(se,{children:[s.jsx(S,{value:"email",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Fe,{className:"h-4 w-4"}),"Email Only"]})}),s.jsx(S,{value:"sms",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(Ie,{className:"h-4 w-4"}),"SMS Only"]})}),s.jsx(S,{value:"both",children:s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(qe,{className:"h-4 w-4"}),"Email & SMS"]})})]})]})]}),(i==="email"||i==="both")&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"subject",children:"Subject"}),s.jsx(w,{id:"subject",placeholder:"Enter email subject",value:U,onChange:e=>$(e.target.value),"data-testid":"input-subject"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"message",children:"Message"}),s.jsx(ae,{id:"message",placeholder:"Type your message here...",value:E,onChange:e=>P(e.target.value),rows:8,"data-testid":"textarea-message"}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["Use placeholders: ","{tenant_name}",", ","{unit}",", ","{amount}",", ","{due_date}"]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx(o,{children:"Quick Templates"}),s.jsxs($e,{open:le,onOpenChange:G,children:[s.jsx(Pe,{asChild:!0,children:s.jsx(j,{variant:"outline",size:"sm",children:"Manage Templates"})}),s.jsxs(ke,{className:"max-w-2xl",children:[s.jsx(Re,{children:s.jsx(De,{children:u.id?"Edit Template":"New Template"})}),s.jsxs("div",{className:"grid gap-4",children:[s.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"template-name",children:"Name"}),s.jsx(w,{id:"template-name",value:u.name,onChange:e=>N(a=>({...a,name:e.target.value})),placeholder:"Template name"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"template-channel",children:"Channel"}),s.jsxs(Y,{value:u.channel,onValueChange:e=>N(a=>({...a,channel:e})),children:[s.jsx(Z,{id:"template-channel",children:s.jsx(ee,{})}),s.jsxs(se,{children:[s.jsx(S,{value:"sms",children:"SMS"}),s.jsx(S,{value:"email",children:"Email"}),s.jsx(S,{value:"both",children:"Both"})]})]})]})]}),(u.channel==="email"||u.channel==="both")&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"template-subject",children:"Subject"}),s.jsx(w,{id:"template-subject",value:u.subject,onChange:e=>N(a=>({...a,subject:e.target.value})),placeholder:"Subject (email only)"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(o,{htmlFor:"template-content",children:"Content"}),s.jsx(ae,{id:"template-content",value:u.content,onChange:e=>N(a=>({...a,content:e.target.value})),rows:6})]})]}),s.jsxs(Ke,{className:"flex items-center justify-between",children:[s.jsx(j,{variant:"outline",onClick:O,children:"Clear"}),s.jsx(j,{onClick:()=>X.mutate(u),disabled:!u.name.trim()||!u.content.trim(),children:X.isPending?"Saving...":"Save Template"})]}),s.jsxs("div",{className:"border-t pt-4 space-y-3",children:[s.jsx(o,{children:"Existing Templates"}),I.length===0?s.jsx("p",{className:"text-sm text-muted-foreground",children:"No templates yet."}):s.jsx("div",{className:"space-y-2",children:I.map(e=>s.jsxs("div",{className:"flex items-center justify-between rounded border px-3 py-2",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium",children:e.name}),s.jsx("p",{className:"text-xs text-muted-foreground capitalize",children:e.channel})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(j,{variant:"outline",size:"sm",onClick:()=>fe(e),children:"Edit"}),s.jsx(j,{variant:"destructive",size:"sm",onClick:()=>ye.mutate(e.id),children:"Delete"})]})]},e.id))})]})]})]})]}),s.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:I.length===0?s.jsx("p",{className:"text-sm text-muted-foreground",children:"No templates available."}):I.map(e=>s.jsx(j,{variant:"outline",size:"sm",onClick:()=>ve(e),"data-testid":`button-template-${e.id}`,children:e.name},e.id))})]}),s.jsx("div",{className:"flex justify-end gap-2 pt-4 border-t",children:s.jsxs(j,{onClick:Ne,disabled:!E.trim()||k.isPending||(T?(i==="email"||i==="both")&&!C.trim()||(i==="sms"||i==="both")&&!M.trim():g.length===0),"data-testid":"button-send-message",children:[s.jsx(Le,{className:"h-4 w-4 mr-2"}),k.isPending?"Sending...":"Send Message"]})})]})]})]})]})}export{Ae as MessagingCompose};
