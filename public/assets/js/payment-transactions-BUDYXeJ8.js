import{a as ee,b as se,d as f,f as k,j as e,T as q,x as r,C as M,G as O,I as ae,S as v,r as w,s as S,v as C,w as c,z as te,A as ne,a8 as K,E as le,L as $,ac as ie,ad as re,ae as G,af as d,ag as ce,ah as o,ay as de,M as oe,y as m,H as me,aA as xe,ak as he,D as B,g as H,h as U,i as V,k as z,K as l,a0 as x,q as pe,aC as je,au as ue}from"./index-BtknkMaH.js";import{r as h}from"./vendor-Dl_IvdXv.js";import{D as ye}from"./download-ILkuwfnn.js";import{C as ge}from"./circle-x-Qbe_jolQ.js";function Se(){const[y,Q]=h.useState(""),[g,X]=h.useState("all"),[a,P]=h.useState(null),[J,D]=h.useState(!1),[W,p]=h.useState(!1),{toast:j}=ee(),{selectedPropertyId:t,selectedLandlordId:n}=se(),{data:b=[],isLoading:Y,error:A}=f({queryKey:["/api/payments",t,n],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t),n&&s.append("landlordId",n);const i=`/api/payments${s.toString()?`?${s}`:""}`;return await(await x("GET",i)).json()}}),{data:T=[]}=f({queryKey:["/api/tenants",t,n],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t),n&&s.append("landlordId",n);const i=`/api/tenants${s.toString()?`?${s}`:""}`;return await(await x("GET",i)).json()}}),{data:L=[]}=f({queryKey:["/api/invoices",t,n],queryFn:async()=>{const s=new URLSearchParams;t&&s.append("propertyId",t),n&&s.append("landlordId",n);const i=`/api/invoices${s.toString()?`?${s}`:""}`;return await(await x("GET",i)).json()}}),F=k({mutationFn:s=>x("POST",`/api/payments/${s}/receipt`),onSuccess:()=>{j({title:"Receipt Generated",description:"Payment receipt has been generated successfully."})},onError:s=>{j({title:"Error",description:s.message||"Failed to generate receipt",variant:"destructive"})}}),N=k({mutationFn:s=>x("POST",`/api/payments/${a.id}/allocate`,s),onSuccess:()=>{pe.invalidateQueries({queryKey:["/api/payments"]}),p(!1),j({title:"Payment Allocated",description:"Payment has been allocated successfully."})},onError:s=>{j({title:"Error",description:s.message||"Failed to allocate payment",variant:"destructive"})}}),I=Array.isArray(b)?b.filter(s=>{const i=s.reference?.toLowerCase().includes(y.toLowerCase())||s.notes?.toLowerCase().includes(y.toLowerCase()),u=g==="all"||s.status===g;return i&&u}):[],Z=s=>{F.mutate(s)},_=s=>{N.mutate(s)},E=s=>{switch(s){case"completed":return e.jsx(ue,{className:"h-4 w-4 text-green-500"});case"pending":return e.jsx(je,{className:"h-4 w-4 text-yellow-500"});case"failed":return e.jsx(ge,{className:"h-4 w-4 text-red-500"});default:return e.jsx(q,{className:"h-4 w-4 text-gray-500"})}},R=s=>{switch(s){case"completed":return e.jsx(m,{variant:"default",className:"bg-green-500",children:"Completed"});case"pending":return e.jsx(m,{variant:"secondary",className:"bg-yellow-500 text-white",children:"Pending"});case"failed":return e.jsx(m,{variant:"destructive",children:"Failed"});default:return e.jsx(m,{variant:"outline",children:"Unknown"})}};return A?e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-2 text-destructive",children:[e.jsx(q,{className:"h-4 w-4"}),e.jsxs("span",{children:["Error loading payments: ",A.message]})]})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"payments-title",children:"Payment Transactions"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage incoming payments and generate receipts"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(r,{variant:"outline","data-testid":"button-export-payments",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Export"]})})]}),e.jsx(M,{children:e.jsx(O,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(ae,{placeholder:"Search payments by reference or notes...",value:y,onChange:s=>Q(s.target.value),className:"max-w-sm"})}),e.jsxs(v,{value:g,onValueChange:X,children:[e.jsx(w,{className:"w-48",children:e.jsx(S,{placeholder:"Filter by status"})}),e.jsxs(C,{children:[e.jsx(c,{value:"all",children:"All Status"}),e.jsx(c,{value:"completed",children:"Completed"}),e.jsx(c,{value:"pending",children:"Pending"}),e.jsx(c,{value:"failed",children:"Failed"})]})]})]})})}),e.jsxs(M,{children:[e.jsxs(te,{children:[e.jsxs(ne,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5"}),"Payment Transactions"]}),e.jsxs(le,{children:[I.length," payment(s) found"]})]}),e.jsx(O,{children:Y?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx($,{className:"h-8 w-8 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Loading payments..."})]}):e.jsxs(ie,{children:[e.jsx(re,{children:e.jsxs(G,{children:[e.jsx(d,{children:"Date"}),e.jsx(d,{children:"Amount"}),e.jsx(d,{children:"Method"}),e.jsx(d,{children:"Reference"}),e.jsx(d,{children:"Status"}),e.jsx(d,{children:"Actions"})]})}),e.jsx(ce,{children:I.map(s=>e.jsxs(G,{children:[e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4 text-muted-foreground"}),new Date(s.paymentDate).toLocaleDateString()]})}),e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-green-500"}),e.jsxs("span",{className:"font-mono font-semibold",children:["KSh ",parseFloat(s.amount).toLocaleString()]})]})}),e.jsx(o,{children:e.jsx(m,{variant:"outline",children:s.paymentMethod})}),e.jsx(o,{className:"font-mono text-sm",children:s.reference||"N/A"}),e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[E(s.status),R(s.status)]})}),e.jsx(o,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>{P(s),D(!0)},children:[e.jsx(me,{className:"h-3 w-3 mr-1"}),"View"]}),e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>Z(s.id),disabled:F.isPending,children:[e.jsx(xe,{className:"h-3 w-3 mr-1"}),"Receipt"]}),e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>{P(s),p(!0)},children:[e.jsx(he,{className:"h-3 w-3 mr-1"}),"Allocate"]})]})})]},s.id))})]})})]}),e.jsx(B,{open:J,onOpenChange:D,children:e.jsxs(H,{className:"max-w-2xl",children:[e.jsxs(U,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-5 w-5"}),"Payment Details"]}),e.jsx(z,{children:"Detailed information about the payment transaction"})]}),a&&e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Payment Date"}),e.jsx("p",{className:"text-sm",children:new Date(a.paymentDate).toLocaleDateString()})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Amount"}),e.jsxs("p",{className:"text-sm font-mono font-semibold",children:["KSh ",parseFloat(a.amount).toLocaleString()]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Payment Method"}),e.jsx("p",{className:"text-sm",children:a.paymentMethod})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Reference"}),e.jsx("p",{className:"text-sm font-mono",children:a.reference||"N/A"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Status"}),e.jsxs("div",{className:"flex items-center gap-2",children:[E(a.status),R(a.status)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{className:"text-sm font-medium",children:"Notes"}),e.jsx("p",{className:"text-sm",children:a.notes||"No notes"})]})]})})]})}),e.jsx(B,{open:W,onOpenChange:p,children:e.jsxs(H,{className:"max-w-md",children:[e.jsxs(U,{children:[e.jsx(V,{children:"Allocate Payment"}),e.jsx(z,{children:"Assign this payment to a specific tenant and invoice"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Select Tenant"}),e.jsxs(v,{children:[e.jsx(w,{children:e.jsx(S,{placeholder:"Choose a tenant"})}),e.jsx(C,{children:Array.isArray(T)?T.map(s=>e.jsx(c,{value:s.id,children:s.fullName},s.id)):null})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(l,{children:"Select Invoice (Optional)"}),e.jsxs(v,{children:[e.jsx(w,{children:e.jsx(S,{placeholder:"Choose an invoice"})}),e.jsx(C,{children:Array.isArray(L)?L.map(s=>e.jsxs(c,{value:s.id,children:[s.invoiceNumber," - KSh ",parseFloat(s.amount).toLocaleString()]},s.id)):null})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(r,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsxs(r,{onClick:()=>_({}),disabled:N.isPending,children:[N.isPending&&e.jsx($,{className:"h-4 w-4 mr-2 animate-spin"}),"Allocate Payment"]})]})]})]})})]})}export{Se as PaymentTransactions};
