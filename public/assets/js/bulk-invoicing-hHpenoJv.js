import{a as Y,b as X,d as N,f as Z,j as s,C,z as T,A as $,E as A,G as w,K as p,S as _,r as ee,s as se,v as te,w as ae,av as ne,I as P,x as I,B as ie,y as q,az as re,aA as ce,a0 as m,q as D}from"./index-BtknkMaH.js";import{r as h}from"./vendor-Dl_IvdXv.js";function le(){const[x,L]=h.useState(""),[u,k]=h.useState([]),[v,W]=h.useState(new Date().toISOString().split("T")[0]),[j,g]=h.useState([]),[F,S]=h.useState(!1),[U,E]=h.useState({}),{toast:f}=Y(),{selectedPropertyId:r,selectedLandlordId:c}=X(),{data:B=[]}=N({queryKey:["/api/properties",c,r],queryFn:async()=>{const e=new URLSearchParams;c&&e.append("landlordId",c),r&&e.append("propertyId",r);const a=`/api/properties${e.toString()?`?${e}`:""}`;return await(await m("GET",a)).json()}}),{data:K=[]}=N({queryKey:["/api/tenants",r,c],queryFn:async()=>{const e=new URLSearchParams;r&&e.append("propertyId",r),c&&e.append("landlordId",c);const a=`/api/tenants${e.toString()?`?${e}`:""}`;return await(await m("GET",a)).json()}}),{data:O=[]}=N({queryKey:["/api/units",r,c],queryFn:async()=>{const e=new URLSearchParams;r&&e.append("propertyId",r),c&&e.append("landlordId",c);const a=`/api/units${e.toString()?`?${e}`:""}`;return await(await m("GET",a)).json()}}),{data:R=[]}=N({queryKey:["/api/leases",r,c],queryFn:async()=>{const e=new URLSearchParams;r&&e.append("propertyId",r),c&&e.append("landlordId",c);const a=`/api/leases${e.toString()?`?${e}`:""}`;return await(await m("GET",a)).json()}}),y=[{id:"rent",name:"Rent",type:"fixed"},{id:"water",name:"Water (Unit Based)",type:"variable"},{id:"garbage",name:"Garbage Fee",type:"fixed",amount:500},{id:"security",name:"Security Fee",type:"fixed",amount:1e3},{id:"service",name:"Service Charge",type:"fixed",amount:300},{id:"electricity",name:"Electricity",type:"variable"}],G=()=>{if(!x)return[];const e=O.filter(t=>t.propertyId===x),a=R.filter(t=>t.status==="active");return e.map(t=>{const n=a.find(i=>i.unitId===t.id),d=n?K.find(i=>i.id===n.tenantId):null;if(!n||!d)return null;const o={};return u.forEach(i=>{const l=y.find(b=>b.id===i);if(l)switch(i){case"rent":o[i]=parseFloat(n.rentAmount||"0");break;case"water":o[i]=0;break;case"garbage":o[i]=l.amount||500;break;case"security":o[i]=l.amount||1e3;break;case"service":o[i]=l.amount||300;break;case"electricity":o[i]=0;break;default:o[i]=l.amount||0}}),{id:t.id,unit:t.unitNumber,tenant:d.fullName,lease:n,previousWater:0,currentWater:0,waterUnits:0,charges:{...o,...U[t.id]}}}).filter(Boolean)},M=(e,a)=>{k(a?[...u,e]:u.filter(t=>t!==e))},V=()=>{if(!x||u.length===0){f({title:"Missing Selection",description:"Please select a property and at least one charge code.",variant:"destructive"});return}const e=G();g(e),S(!0),f({title:"Accounts Loaded",description:`Loaded ${e.length} tenant accounts for invoicing.`})},Q=Z({mutationFn:async e=>{const a=[];for(const t of j){if(!t.lease)continue;const n=`INV-${new Date().getFullYear()}-${Date.now()}-${t.id.slice(0,8)}`,d=Object.values(t.charges).reduce((i,l)=>i+l,0),o=await m("/api/invoices",{method:"POST",body:JSON.stringify({leaseId:t.lease.id,invoiceNumber:n,description:`Monthly charges for ${t.unit}`,amount:d.toString(),dueDate:e.dueDate,issueDate:e.issueDate,status:"draft"})});for(const[i,l]of Object.entries(t.charges))l>0&&await m("/api/invoice-items",{method:"POST",body:JSON.stringify({invoiceId:o.id,chargeCode:i,description:y.find(b=>b.id===i)?.name||i,quantity:"1",unitPrice:l.toString()})});a.push(o)}return a},onSuccess:e=>{f({title:"Invoices Created",description:`Successfully created ${e.length} invoices in draft status.`}),g([]),S(!1),E({}),D.invalidateQueries({queryKey:["/api/invoices"]}),D.invalidateQueries({queryKey:["/api/invoice-items"]})},onError:e=>{f({title:"Error Creating Invoices",description:"There was an error creating the bulk invoices. Please try again.",variant:"destructive"}),console.error("Bulk invoice creation error:",e)}}),z=()=>{if(j.length===0){f({title:"No Accounts",description:"Please load tenant accounts first.",variant:"destructive"});return}const e=new Date(v);e.setMonth(e.getMonth()+1),Q.mutate({issueDate:v,dueDate:e.toISOString().split("T")[0]})},J=(e,a)=>{g(t=>t.map(n=>n.id===e?{...n,currentWater:n.previousWater+a,waterUnits:a,charges:{...n.charges,water:a*50}}:n))},H=e=>Object.values(e.charges).reduce((a,t)=>a+(t||0),0);return s.jsxs("div",{className:"p-6 space-y-6",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-3xl font-bold","data-testid":"bulk-invoicing-title",children:"Bulk Invoicing"}),s.jsx("p",{className:"text-muted-foreground",children:"Create invoices for all tenants in a property"})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[s.jsxs(C,{className:"lg:col-span-1",children:[s.jsxs(T,{children:[s.jsx($,{children:"Invoice Configuration"}),s.jsx(A,{children:"Select property, charges, and date"})]}),s.jsxs(w,{className:"space-y-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(p,{htmlFor:"property",children:"Property"}),s.jsxs(_,{value:x,onValueChange:L,children:[s.jsx(ee,{"data-testid":"select-property",children:s.jsx(se,{placeholder:"Select property"})}),s.jsx(te,{children:B.map(e=>s.jsx(ae,{value:e.id,children:e.name},e.id))})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(p,{children:"Charge Codes"}),s.jsx("div",{className:"space-y-2",children:y.map(e=>s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(ne,{id:e.id,checked:u.includes(e.id),onCheckedChange:a=>M(e.id,!!a),"data-testid":`checkbox-${e.id}`}),s.jsx(p,{htmlFor:e.id,className:"flex-1 cursor-pointer",children:s.jsxs("div",{className:"flex justify-between",children:[s.jsx("span",{children:e.name}),e.amount&&s.jsx("span",{className:"text-muted-foreground font-mono text-sm",children:e.amount})]})})]},e.id))})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(p,{htmlFor:"invoice-date",children:"Invoice Date"}),s.jsx(P,{id:"invoice-date",type:"date",value:v,onChange:e=>W(e.target.value),"data-testid":"input-invoice-date"})]}),s.jsxs(I,{onClick:V,className:"w-full",disabled:!x||u.length===0||!v,"data-testid":"button-load-accounts",children:[s.jsx(ie,{className:"h-4 w-4 mr-2"}),"Load Accounts"]})]})]}),s.jsx("div",{className:"lg:col-span-2",children:F?s.jsxs(C,{children:[s.jsxs(T,{children:[s.jsxs($,{className:"flex items-center justify-between",children:["Tenant Accounts",s.jsxs(q,{variant:"secondary",children:[j.length," accounts loaded"]})]}),s.jsx(A,{children:"Update water units and review charges before submitting"})]}),s.jsx(w,{children:s.jsxs("div",{className:"space-y-4",children:[j.map(e=>s.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("div",{children:s.jsxs("h4",{className:"font-medium",children:[e.unit," - ",e.tenant]})}),s.jsxs(q,{variant:"outline",className:"font-mono",children:["Total: KSh ",H(e).toLocaleString()]})]}),u.includes("water")&&s.jsxs("div",{className:"grid grid-cols-4 gap-4 p-3 bg-muted/50 rounded",children:[s.jsxs("div",{children:[s.jsx(p,{className:"text-xs",children:"Previous Units"}),s.jsx("p",{className:"font-mono",children:e.previousWater})]}),s.jsxs("div",{children:[s.jsx(p,{className:"text-xs",children:"Current Units"}),s.jsx(P,{type:"number",value:e.currentWater,onChange:a=>{const t=a.target.value;if(t==="")g(n=>n.map(d=>d.id===e.id?{...d,currentWater:e.previousWater}:d));else{const n=parseInt(t);if(!isNaN(n)&&n>=e.previousWater){const d=n-e.previousWater;J(e.id,d)}}},min:e.previousWater,className:"h-8","data-testid":`input-water-${e.unit}`})]}),s.jsxs("div",{children:[s.jsx(p,{className:"text-xs",children:"Units Used"}),s.jsx("p",{className:"font-mono",children:e.waterUnits})]}),s.jsxs("div",{children:[s.jsx(p,{className:"text-xs",children:"Water Charge"}),s.jsxs("p",{className:"font-mono",children:["KSh ",e.charges.water]})]})]}),s.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2 text-sm",children:u.map(a=>{const t=y.find(n=>n.id===a);return t?s.jsxs("div",{className:"flex justify-between",children:[s.jsxs("span",{children:[t.name,":"]}),s.jsxs("span",{className:"font-mono",children:["KSh ",e.charges[a]?.toLocaleString()||0]})]},a):null})})]},e.id)),s.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[s.jsx(I,{variant:"outline",onClick:()=>S(!1),children:"Cancel"}),s.jsxs(I,{onClick:z,"data-testid":"button-submit-invoices",children:[s.jsx(re,{className:"h-4 w-4 mr-2"}),"Submit Invoices"]})]})]})})]}):s.jsx(C,{className:"h-full flex items-center justify-center",children:s.jsxs(w,{className:"text-center",children:[s.jsx(ce,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),s.jsx("h3",{className:"text-lg font-medium mb-2",children:"Configure Invoice Settings"}),s.jsx("p",{className:"text-muted-foreground",children:"Select property, charge codes, and date to load tenant accounts"})]})})})]})]})}export{le as BulkInvoicing};
