import{a as je,b as ve,d as S,f as Ne,j as t,C as _,z as G,A as Q,E as Y,G as F,K as g,S as Se,r as we,s as be,v as Ce,w as Ie,a4 as Ae,I as E,x as K,B as De,y as W,ar as Re,ax as qe,a0 as y,q as M}from"./index-D3-Phv8z.js";import{r as l}from"./vendor-BBpupLJz.js";function $e(){const[H,R]=l.useState(""),[m,q]=l.useState([]),[h,J]=l.useState(new Date().toISOString().split("T")[0]),[v,L]=l.useState(""),[w,P]=l.useState([]),[X,b]=l.useState(!1),[Z,U]=l.useState({}),{toast:u}=je(),{selectedPropertyId:a,selectedLandlordId:i,setSelectedPropertyId:ee}=ve();l.useEffect(()=>{a?R(a):(R(""),b(!1))},[a]),l.useEffect(()=>{if(!h){L("");return}if(!v){const e=new Date(h);e.setMonth(e.getMonth()+1),L(e.toISOString().split("T")[0])}},[h,v]);const{data:T=[]}=S({queryKey:["/api/properties",i,a],queryFn:async()=>{const e=new URLSearchParams;i&&e.append("landlordId",i),a&&e.append("propertyId",a);const s=`/api/properties${e.toString()?`?${e}`:""}`;return await(await y("GET",s)).json()}}),{data:V=[]}=S({queryKey:["/api/tenants",a,i],queryFn:async()=>{const e=new URLSearchParams;a&&e.append("propertyId",a),i&&e.append("landlordId",i);const s=`/api/tenants${e.toString()?`?${e}`:""}`;return await(await y("GET",s)).json()}}),{data:k=[]}=S({queryKey:["/api/units",a,i],queryFn:async()=>{const e=new URLSearchParams;a&&e.append("propertyId",a),i&&e.append("landlordId",i);const s=`/api/units${e.toString()?`?${e}`:""}`;return await(await y("GET",s)).json()}}),{data:B=[]}=S({queryKey:["/api/leases",a,i],queryFn:async()=>{const e=new URLSearchParams;a&&e.append("propertyId",a),i&&e.append("landlordId",i);const s=`/api/leases${e.toString()?`?${e}`:""}`;return await(await y("GET",s)).json()}}),{data:O=[]}=S({queryKey:["/api/charge-codes",a],queryFn:async()=>{const e=new URLSearchParams;a&&e.append("propertyId",a);const s=`/api/charge-codes${e.toString()?`?${e}`:""}`;return await(await y("GET",s)).json()},enabled:!!a}),{data:z=[]}=S({queryKey:["/api/water-readings",a,i],queryFn:async()=>{const e=new URLSearchParams;a&&e.append("propertyId",a),i&&e.append("landlordId",i);const s=`/api/water-readings${e.toString()?`?${e}`:""}`;return await(await y("GET",s)).json()},enabled:!!a}),f=e=>{const s=Number(e);return Number.isFinite(s)?s:0},te=e=>{const s=e.lastModifiedAt||e.createdAt||e.last_modified_at||e.created_at||e.readingDate||e.reading_date,n=s?new Date(s).getTime():0;return Number.isFinite(n)?n:0},se=e=>{const s=f(e?.current_reading??e?.currentReading),n=f(e?.previous_reading??e?.previousReading);return Number.isFinite(s)&&Number.isFinite(n)?Math.max(0,s-n):f(e?.consumption)},ne=e=>{if(!e||e==="null")return{};if(typeof e=="string")try{const s=JSON.parse(e);return s&&typeof s=="object"?s:{}}catch{return{}}return typeof e=="object"?e:{}},ae=Array.isArray(T)?T.map(e=>({id:e.id,name:e.name,landlordId:e.landlordId??e.landlord_id})):[],re=Array.isArray(k)?k.map(e=>({id:e.id,propertyId:e.propertyId??e.property_id,unitNumber:e.unitNumber??e.unit_number,status:e.status,chargeAmounts:ne(e.chargeAmounts??e.charge_amounts)})):[],ie=Array.isArray(B)?B.map(e=>({id:e.id,unitId:e.unitId??e.unit_id,tenantId:e.tenantId??e.tenant_id,rentAmount:e.rentAmount??e.rent_amount,waterRatePerUnit:e.waterRatePerUnit??e.water_rate_per_unit,status:e.status})):[],oe=Array.isArray(V)?V.map(e=>({id:e.id,fullName:e.fullName??e.full_name})):[],de=Array.isArray(O)?O.map(e=>({id:e.id,name:e.name,description:e.description})):[],N=[{id:"rent",name:"Rent"},{id:"water",name:"Water (Metered)"},...de];l.useEffect(()=>{a&&m.length===0&&N.length>0&&q(N.map(e=>e.id))},[a,N.length]);const I=new Set(ae.map(e=>e.landlordId).filter(Boolean)).size>1&&(!i||i==="all"),C=!a||I,ce=e=>{if(!e)return"";const s=new Date(e);if(Number.isNaN(s.getTime()))return"";const n=new Date(s.getFullYear(),s.getMonth()-1,1);return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`},$=l.useMemo(()=>ce(h),[h]),le=l.useMemo(()=>{const e=new Map;return z.forEach(s=>{const n=s.unitId??s.unit_id;if(!n)return;const o=s.readingDate??s.reading_date??s.createdAt??s.created_at,r=new Date(o);if(!$||Number.isNaN(r.getTime())||`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`!==$)return;const d=te(s),c=e.get(n);(!c||d>c.dateValue)&&e.set(n,{...s,dateValue:d})}),e},[z,$]),ue=()=>{if(!a)return[];const e=re.filter(n=>n.propertyId===a),s=ie.filter(n=>n.status==="active");return e.map(n=>{const o=s.find(p=>p.unitId===n.id),r=o?oe.find(p=>p.id===o.tenantId):null,x=!o||!r,d=le.get(n.id),c=d?se(d):0,j=Number.isFinite(c)&&c>0?c:0,A=o?f(o.waterRatePerUnit):0,ye=j*A,D={};return m.forEach(p=>{if(p==="rent"){D[p]=o?f(o.rentAmount):0;return}if(p==="water"){D[p]=o?ye:0;return}D[p]=o?f(n.chargeAmounts?.[p]??0):0}),{id:n.id,unit:n.unitNumber,tenant:r?.fullName||"Vacant",lease:o,isVacant:x,waterUnits:j,waterRate:A,lastReadingDate:d?.readingDate??d?.reading_date??d?.createdAt??d?.created_at,charges:{...D,...Z[n.id]}}})},pe=(e,s)=>{q(s?[...m,e]:m.filter(n=>n!==e))},me=()=>{if(I){u({title:"Landlord Required",description:"Select a landlord in the header before loading accounts.",variant:"destructive"});return}if(C){u({title:"Property Required",description:"Select a property in the header before loading accounts.",variant:"destructive"});return}if(!a||m.length===0){u({title:"Missing Selection",description:"Please select a property and at least one charge code.",variant:"destructive"});return}const e=ue();P(e),b(!0),u({title:"Accounts Loaded",description:`Loaded ${e.length} tenant accounts for invoicing.`})},he=(e,s,n)=>{w.find(r=>r.id===e)?.isVacant||(U(r=>({...r,[e]:{...r[e],[s]:n}})),P(r=>r.map(x=>x.id===e?{...x,charges:{...x.charges,[s]:n}}:x)))},fe=Ne({mutationFn:async e=>{const s=[];for(const n of w){if(!n.lease)continue;const o=`INV-${new Date().getFullYear()}-${Date.now()}-${n.id.slice(0,8)}`,r=Object.values(n.charges).reduce((c,j)=>c+j,0),d=await(await y("POST","/api/invoices",{leaseId:n.lease.id,invoiceNumber:o,description:`Monthly charges for ${n.unit}`,amount:r.toString(),dueDate:e.dueDate,issueDate:e.issueDate,status:"draft"})).json();for(const[c,j]of Object.entries(n.charges))j>0&&await y("POST","/api/invoice-items",{invoiceId:d.id,chargeCode:c,description:N.find(A=>A.id===c)?.name||c,quantity:"1",unitPrice:j.toString()});s.push(d)}return s},onSuccess:e=>{u({title:"Invoices Created",description:`Successfully created ${e.length} invoices in draft status.`}),P([]),b(!1),U({}),M.invalidateQueries({queryKey:["/api/invoices"]}),M.invalidateQueries({queryKey:["/api/invoice-items"]}),M.invalidateQueries({queryKey:["/api/stats"]})},onError:e=>{u({title:"Error Creating Invoices",description:"There was an error creating the bulk invoices. Please try again.",variant:"destructive"}),console.error("Bulk invoice creation error:",e)}}),ge=()=>{if(I){u({title:"Landlord Required",description:"Select a landlord in the header before submitting invoices.",variant:"destructive"});return}if(C){u({title:"Property Required",description:"Select a property in the header before submitting invoices.",variant:"destructive"});return}if(w.length===0){u({title:"No Accounts",description:"Please load tenant accounts first.",variant:"destructive"});return}if(!h||!v){u({title:"Missing Dates",description:"Select both invoice and due dates.",variant:"destructive"});return}fe.mutate({issueDate:h,dueDate:v})},xe=e=>Object.values(e.charges).reduce((s,n)=>s+f(n),0);return t.jsxs("div",{className:"p-6 space-y-6",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold","data-testid":"bulk-invoicing-title",children:"Bulk Invoicing"}),t.jsx("p",{className:"text-muted-foreground",children:"Create invoices for all tenants in a property"})]}),t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[t.jsxs(_,{className:"lg:col-span-1",children:[t.jsxs(G,{children:[t.jsx(Q,{children:"Invoice Configuration"}),t.jsx(Y,{children:"Select property, charges, and date"})]}),t.jsxs(F,{className:"space-y-4",children:[I&&t.jsx("div",{className:"text-sm text-muted-foreground",children:"Select a landlord in the header to continue."}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{htmlFor:"property",children:"Property"}),t.jsxs(Se,{value:H,onValueChange:e=>{R(e),ee(e||null),b(!1)},disabled:C,children:[t.jsx(we,{"data-testid":"select-property",children:t.jsx(be,{placeholder:"Select property"})}),t.jsx(Ce,{children:T.map(e=>t.jsx(Ie,{value:e.id,children:e.name},e.id))})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{children:"Charge Codes"}),t.jsx("div",{className:"space-y-2",children:N.map(e=>t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx(Ae,{id:e.id,checked:m.includes(e.id),onCheckedChange:s=>pe(e.id,!!s),"data-testid":`checkbox-${e.id}`}),t.jsx(g,{htmlFor:e.id,className:"flex-1 cursor-pointer",children:t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{children:e.name}),e.id!=="rent"&&e.id!=="water"&&t.jsx("span",{className:"text-muted-foreground font-mono text-sm",children:"Property charge"})]})})]},e.id))})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{htmlFor:"invoice-date",children:"Invoice Date"}),t.jsx(E,{id:"invoice-date",type:"date",value:h,onChange:e=>J(e.target.value),"data-testid":"input-invoice-date"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(g,{htmlFor:"due-date",children:"Due Date"}),t.jsx(E,{id:"due-date",type:"date",value:v,onChange:e=>L(e.target.value),"data-testid":"input-due-date"})]}),t.jsxs(K,{onClick:me,className:"w-full",disabled:C||!a||m.length===0||!h||!v,"data-testid":"button-load-accounts",children:[t.jsx(De,{className:"h-4 w-4 mr-2"}),"Load Accounts"]})]})]}),t.jsx("div",{className:"lg:col-span-2",children:X?t.jsxs(_,{children:[t.jsxs(G,{children:[t.jsxs(Q,{className:"flex items-center justify-between",children:["Tenant Accounts",t.jsxs(W,{variant:"secondary",children:[w.length," accounts loaded"]})]}),t.jsx(Y,{children:"Update water units and review charges before submitting"})]}),t.jsx(F,{children:t.jsxs("div",{className:"space-y-4",children:[w.map(e=>t.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsxs("h4",{className:"font-medium",children:[e.unit," - ",e.tenant]}),e.isVacant&&t.jsx("div",{className:"text-xs text-muted-foreground",children:"Vacant unit (no invoice will be created)"})]}),t.jsxs(W,{variant:"outline",className:"font-mono",children:["Total: KSh ",xe(e).toLocaleString()]})]}),m.includes("water")&&t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 p-3 bg-muted/50 rounded",children:[t.jsxs("div",{children:[t.jsx(g,{className:"text-xs",children:"Units Used"}),t.jsx("p",{className:"font-mono",children:e.waterUnits})]}),t.jsxs("div",{children:[t.jsx(g,{className:"text-xs",children:"Rate (KSH)"}),t.jsx("p",{className:"font-mono",children:f(e.waterRate).toLocaleString()})]}),t.jsxs("div",{children:[t.jsx(g,{className:"text-xs",children:"Last Reading"}),t.jsx("p",{className:"font-mono",children:e.lastReadingDate?new Date(e.lastReadingDate).toLocaleDateString():"â€”"})]}),t.jsxs("div",{children:[t.jsx(g,{className:"text-xs",children:"Water Charge"}),t.jsxs("p",{className:"font-mono",children:["KSh ",e.charges.water]})]})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 text-sm",children:m.map(s=>{const n=N.find(r=>r.id===s);if(!n)return null;const o=e.charges[s]??0;return t.jsxs("div",{className:"flex items-center justify-between gap-3",children:[t.jsx("span",{children:n.name}),t.jsx(E,{type:"number",value:o,onChange:r=>he(e.id,s,f(r.target.value)),className:"h-8 w-28 font-mono",disabled:e.isVacant})]},s)})})]},e.id)),t.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[t.jsx(K,{variant:"outline",onClick:()=>b(!1),children:"Cancel"}),t.jsxs(K,{onClick:ge,disabled:C,"data-testid":"button-submit-invoices",children:[t.jsx(Re,{className:"h-4 w-4 mr-2"}),"Submit Invoices"]})]})]})})]}):t.jsx(_,{className:"h-full flex items-center justify-center",children:t.jsxs(F,{className:"text-center",children:[t.jsx(qe,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium mb-2",children:"Configure Invoice Settings"}),t.jsx("p",{className:"text-muted-foreground",children:"Select property, charge codes, and date to load tenant accounts"})]})})})]})]})}export{$e as BulkInvoicing};
