import{an as ye,j as e,ao as oe,ap as we,u as be,a as De,b as Se,d as Z,x as M,a1 as Pe,aq as ee,ar as Ee,as as te,at as se,C as F,z as R,A as T,B as Ue,E as z,G as I,K as ae,S as Fe,r as Re,s as Te,v as Ie,w as Ce,aj as Le,T as qe,I as Ae,L as ne,au as $e,U as Me,a0 as b,q as C}from"./index-BtknkMaH.js";import{r as p,J as D,K as ke,L as _e}from"./vendor-Dl_IvdXv.js";import{U as re}from"./upload-CHr4UBr1.js";import{D as Ye}from"./download-ILkuwfnn.js";var J="Progress",Q=100,[Be,et]=ye(J),[Oe,Ke]=Be(J),de=p.forwardRef((s,a)=>{const{__scopeProgress:f,value:l=null,max:u,getValueLabel:v=ze,...L}=s;(u||u===0)&&!ie(u)&&console.error(Je(`${u}`,"Progress"));const o=ie(u)?u:Q;l!==null&&!le(l,o)&&console.error(Qe(`${l}`,"Progress"));const c=le(l,o)?l:null,d=k(c)?v(c,o):void 0;return e.jsx(Oe,{scope:f,value:c,max:o,children:e.jsx(oe.div,{"aria-valuemax":o,"aria-valuemin":0,"aria-valuenow":k(c)?c:void 0,"aria-valuetext":d,role:"progressbar","data-state":me(c,o),"data-value":c??void 0,"data-max":o,...L,ref:a})})});de.displayName=J;var ce="ProgressIndicator",ue=p.forwardRef((s,a)=>{const{__scopeProgress:f,...l}=s,u=Ke(ce,f);return e.jsx(oe.div,{"data-state":me(u.value,u.max),"data-value":u.value??void 0,"data-max":u.max,...l,ref:a})});ue.displayName=ce;function ze(s,a){return`${Math.round(s/a*100)}%`}function me(s,a){return s==null?"indeterminate":s===a?"complete":"loading"}function k(s){return typeof s=="number"}function ie(s){return k(s)&&!isNaN(s)&&s>0}function le(s,a){return k(s)&&!isNaN(s)&&s<=a&&s>=0}function Je(s,a){return`Invalid prop \`max\` of value \`${s}\` supplied to \`${a}\`. Only numbers greater than 0 are valid max values. Defaulting to \`${Q}\`.`}function Qe(s,a){return`Invalid prop \`value\` of value \`${s}\` supplied to \`${a}\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or ${Q} if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`}var pe=de,Ge=ue;const he=p.forwardRef(({className:s,value:a,...f},l)=>e.jsx(pe,{ref:l,className:we("relative h-4 w-full overflow-hidden rounded-full bg-secondary",s),...f,children:e.jsx(Ge,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(a||0)}%)`}})}));he.displayName=pe.displayName;function tt(){const[,s]=be(),[a,f]=p.useState(""),[l,u]=p.useState(null),[v,L]=p.useState(!1),[o,c]=p.useState(null),[d,G]=p.useState(null),{toast:h}=De(),xe=p.useRef(null),{selectedPropertyId:N,selectedLandlordId:y}=Se(),{data:W=[],isLoading:fe}=Z({queryKey:["/api/properties",y,N],queryFn:async()=>{const t=new URLSearchParams;y&&t.append("landlordId",y),N&&t.append("propertyId",N);const i=`/api/properties${t.toString()?`?${t}`:""}`;return await(await b("GET",i)).json()}}),{data:ge=[]}=Z({queryKey:["/api/units",N,y],queryFn:async()=>{const t=new URLSearchParams;N&&t.append("propertyId",N),y&&t.append("landlordId",y);const i=`/api/units${t.toString()?`?${t}`:""}`;return await(await b("GET",i)).json()}}),H=a?ge.filter(t=>t.propertyId===a):[],q=W.find(t=>t.id===a),je=()=>{const t=[{"Full Name":"John Doe",Email:"john.doe@email.com",Phone:"+254700000000","ID Number":"12345678","Emergency Contact":"Jane Doe","Emergency Phone":"+254700000001","Unit Number":"A001","Lease Start Date":"2024-01-01","Lease End Date":"2024-12-31","Monthly Rent":"50000","Deposit Amount":"100000","Water Rate Per Unit":"15.50","Opening Balance":"-5000","Balance Type":"arrears",Notes:"2 months arrears from previous property"},{"Full Name":"Mary Smith",Email:"mary.smith@email.com",Phone:"+254700000002","ID Number":"87654321","Emergency Contact":"John Smith","Emergency Phone":"+254700000003","Unit Number":"A002","Lease Start Date":"2024-02-01","Lease End Date":"2025-01-31","Monthly Rent":"45000","Deposit Amount":"90000","Water Rate Per Unit":"15.50","Opening Balance":"2000","Balance Type":"credit",Notes:"Advance payment for next month"}],i=D.json_to_sheet(t);i["!cols"]=[{wch:20},{wch:25},{wch:15},{wch:12},{wch:20},{wch:15},{wch:12},{wch:15},{wch:15},{wch:12},{wch:15},{wch:15},{wch:15},{wch:12},{wch:30}];const x=D.book_new();D.book_append_sheet(x,i,"Tenant Upload Template");const _=[{Field:"Full Name",Required:"Yes",Description:"Complete name of the tenant",Example:"John Doe"},{Field:"Email",Required:"Yes",Description:"Valid email address",Example:"john.doe@email.com"},{Field:"Phone",Required:"Yes",Description:"Phone number with country code",Example:"+254700000000"},{Field:"ID Number",Required:"Yes",Description:"National ID or Passport number",Example:"12345678"},{Field:"Emergency Contact",Required:"No",Description:"Emergency contact person name",Example:"Jane Doe"},{Field:"Emergency Phone",Required:"No",Description:"Emergency contact phone number",Example:"+254700000001"},{Field:"Unit Number",Required:"Yes",Description:"Unit number that exists in the selected property",Example:"A001"},{Field:"Lease Start Date",Required:"Yes",Description:"Lease start date (YYYY-MM-DD)",Example:"2024-01-01"},{Field:"Lease End Date",Required:"Yes",Description:"Lease end date (YYYY-MM-DD)",Example:"2024-12-31"},{Field:"Monthly Rent",Required:"Yes",Description:"Monthly rent amount in KSH (numbers only)",Example:"50000"},{Field:"Deposit Amount",Required:"Yes",Description:"Security deposit amount in KSH",Example:"100000"},{Field:"Water Rate Per Unit",Required:"No",Description:"Water rate per unit (defaults to 15.50)",Example:"15.50"},{Field:"Opening Balance",Required:"No",Description:"Opening balance amount (positive for credit, negative for arrears)",Example:"-5000"},{Field:"Balance Type",Required:"No",Description:"Either 'arrears' for debt or 'credit' for advance payment",Example:"arrears"},{Field:"Notes",Required:"No",Description:"Additional notes about the tenant or lease",Example:"2 months arrears from previous property"}],g=D.json_to_sheet(_);g["!cols"]=[{wch:20},{wch:10},{wch:40},{wch:25}],D.book_append_sheet(x,g,"Instructions");const m=`tenant_bulk_upload_template_${q?.name||"template"}.xlsx`;ke(x,m),h({title:"Template Downloaded",description:`Template downloaded as ${m}. Fill in your tenant data following the instructions.`})},ve=t=>{const i=t.target.files?.[0];if(!i)return;if(!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv"].includes(i.type)){h({title:"Invalid File Type",description:"Please upload an Excel file (.xlsx, .xls) or CSV file.",variant:"destructive"});return}if(i.size>10*1024*1024){h({title:"File Too Large",description:"File size must be less than 10MB.",variant:"destructive"});return}u(i),G(null)},Ne=async()=>{if(!l||!a){h({title:"Missing Requirements",description:"Please select both a property and an Excel file.",variant:"destructive"});return}L(!0),c({total:0,processed:0,successful:0,failed:0});try{const t=await l.arrayBuffer(),i=_e(t,{type:"array"}),x=i.SheetNames[0],_=i.Sheets[x],g=D.sheet_to_json(_);if(g.length===0)throw new Error("The uploaded file contains no data.");c({total:g.length,processed:0,successful:0,failed:0});const m={successful:[],failed:[],duplicates:[],invalidUnits:[]};for(let S=0;S<g.length;S++){const r=g[S],A=S+2;c(w=>({...w,processed:S+1,current:r["Full Name"]||`Row ${A}`}));try{const P=["Full Name","Email","Phone","ID Number","Unit Number","Lease Start Date","Lease End Date","Monthly Rent","Deposit Amount"].filter(n=>!r[n]?.toString().trim());if(P.length>0)throw new Error(`Missing required fields: ${P.join(", ")}`);const Y=r["Unit Number"].toString().trim(),B=H.find(n=>n.unitNumber===Y);if(!B){m.invalidUnits.push({row:A,unitNumber:Y,tenant:r["Full Name"]}),c(n=>({...n,failed:n.failed+1}));continue}const O={fullName:r["Full Name"].toString().trim(),email:r.Email.toString().trim().toLowerCase(),phone:r.Phone.toString().trim(),idNumber:r["ID Number"].toString().trim(),emergencyContact:r["Emergency Contact"]?.toString().trim()||"",emergencyPhone:r["Emergency Phone"]?.toString().trim()||""};if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(O.email))throw new Error("Invalid email format");const E=await(await b("POST","/api/tenants",O)).json(),$=n=>{if(!n)return"";if(n instanceof Date)return n.toISOString().split("T")[0];if(typeof n=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(n))return n;if(typeof n=="string"){const j=new Date(n);if(!isNaN(j.getTime()))return j.toISOString().split("T")[0]}return typeof n=="number"?new Date((n-25569)*86400*1e3).toISOString().split("T")[0]:n.toString()},X={unitId:B.id,tenantId:E.id,startDate:$(r["Lease Start Date"]),endDate:$(r["Lease End Date"]),rentAmount:r["Monthly Rent"].toString(),depositAmount:r["Deposit Amount"].toString(),waterRatePerUnit:r["Water Rate Per Unit"]?.toString()||"15.50",status:"active"};await b("POST","/api/leases",X);const K=r["Opening Balance"],U=r["Balance Type"]?.toString().toLowerCase(),V=r.Notes?.toString()||"";if(K&&(U==="arrears"||U==="credit")){const n=Math.abs(parseFloat(K.toString()));if(U==="arrears"&&n>0){const j={tenantId:E.id,propertyId:a,unitId:B.id,dueDate:$(r["Lease Start Date"]),totalAmount:n.toString(),status:"overdue",description:`Opening arrears balance - ${V}`.trim(),invoiceNumber:`ARR-${Date.now()}-${E.id.slice(-4)}`};await b("POST","/api/invoices",j)}else if(U==="credit"&&n>0){const j={tenantId:E.id,propertyId:a,amount:n.toString(),paymentDate:$(r["Lease Start Date"]),paymentMethod:"Bank Transfer",description:`Opening credit balance - ${V}`.trim(),receiptNumber:`CR-${Date.now()}-${E.id.slice(-4)}`};await b("POST","/api/payments",j)}}m.successful.push({row:A,tenant:O.fullName,unit:Y,rent:X.rentAmount,balance:K||0,balanceType:U||"none"}),c(n=>({...n,successful:n.successful+1}))}catch(w){m.failed.push({row:A,tenant:r["Full Name"]||"Unknown",error:w.message}),c(P=>({...P,failed:P.failed+1}))}await new Promise(w=>setTimeout(w,100))}C.invalidateQueries({queryKey:["/api/tenants"]}),C.invalidateQueries({queryKey:["/api/leases"]}),C.invalidateQueries({queryKey:["/api/units"]}),C.invalidateQueries({queryKey:["/api/invoices"]}),C.invalidateQueries({queryKey:["/api/payments"]}),G(m),m.successful.length>0&&m.failed.length===0?(h({title:"Upload Successful",description:`Successfully processed ${m.successful.length} tenants with leases and balances.`}),setTimeout(()=>{s("/tenants")},3e3)):m.successful.length>0?h({title:"Partial Upload",description:`${m.successful.length} successful, ${m.failed.length} failed. Check results below.`,variant:"destructive"}):h({title:"Upload Failed",description:"No tenants were processed successfully. Check the file format and data.",variant:"destructive"})}catch(t){h({title:"Upload Failed",description:t.message||"Failed to process the uploaded file.",variant:"destructive"})}finally{L(!1)}};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(M,{variant:"outline",size:"sm",onClick:()=>s("/tenants"),"data-testid":"button-back-to-tenants",children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Back to Tenants"]}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2","data-testid":"upload-data-title",children:[e.jsx(re,{className:"h-8 w-8"}),"Bulk Data Upload"]}),e.jsx("p",{className:"text-muted-foreground",children:"Upload tenant data with lease agreements and opening balances"})]})]}),e.jsxs(ee,{children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx(te,{children:"Important Instructions"}),e.jsx(se,{children:e.jsxs("ol",{className:"list-decimal list-inside space-y-1 mt-2",children:[e.jsx("li",{children:"Select the property where tenants will be assigned"}),e.jsx("li",{children:"Download the template and fill in tenant information"}),e.jsx("li",{children:"Ensure all unit numbers exist in the selected property"}),e.jsx("li",{children:"Include opening balances for tenants with arrears or credits"}),e.jsx("li",{children:"Upload the completed file to automatically create tenants, leases, and balances"})]})})]}),e.jsxs(F,{children:[e.jsxs(R,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"h-5 w-5"}),"Step 1: Select Property"]}),e.jsx(z,{children:"Choose the property where the tenants will be assigned"})]}),e.jsx(I,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ae,{htmlFor:"property-select",children:"Property"}),e.jsxs(Fe,{value:a,onValueChange:f,disabled:fe,children:[e.jsx(Re,{className:"w-full","data-testid":"select-property",children:e.jsx(Te,{placeholder:"Select a property"})}),e.jsx(Ie,{children:W.map(t=>e.jsxs(Ce,{value:t.id,children:[t.name," - ",t.address," (",t.totalUnits," units)"]},t.id))})]})]}),a&&e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Selected Property Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",q?.name]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Address:"})," ",q?.address]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Units:"})," ",q?.totalUnits]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Available Units:"})," ",H.filter(t=>t.status==="vacant").length]})]})]})]})})]}),e.jsxs(F,{children:[e.jsxs(R,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-5 w-5"}),"Step 2: Download Template"]}),e.jsx(z,{children:"Download the Excel template and fill in your tenant data"})]}),e.jsx(I,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs(ee,{children:[e.jsx(qe,{className:"h-4 w-4"}),e.jsx(te,{children:"Template Requirements"}),e.jsx(se,{className:"mt-2",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Required Fields:"})," Full Name, Email, Phone, ID Number, Unit Number, Lease Start Date, Lease End Date, Monthly Rent, Deposit Amount"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Balance Types:"}),' Use "arrears" for outstanding debt or "credit" for advance payments']}),e.jsxs("p",{children:[e.jsx("strong",{children:"Unit Numbers:"})," Must match existing units in the selected property"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Date Format:"})," Use YYYY-MM-DD format (e.g., 2024-01-01)"]})]})})]}),e.jsxs(M,{onClick:je,disabled:!a,"data-testid":"button-download-template",className:"w-full",children:[e.jsx(Ye,{className:"h-4 w-4 mr-2"}),"Download Excel Template"]}),!a&&e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Select a property first to download the template"})]})})]}),e.jsxs(F,{children:[e.jsxs(R,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(re,{className:"h-5 w-5"}),"Step 3: Upload Completed File"]}),e.jsx(z,{children:"Upload your completed Excel file to create tenants and leases"})]}),e.jsx(I,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ae,{htmlFor:"file-upload",children:"Excel File"}),e.jsx(Ae,{type:"file",accept:".xlsx,.xls,.csv",onChange:ve,disabled:!a||v,ref:xe,"data-testid":"input-upload-file",className:"cursor-pointer"})]}),l&&e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Selected File"}),e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",l.name]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Size:"})," ",(l.size/1024/1024).toFixed(2)," MB"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Type:"})," ",l.type]})]})]}),e.jsxs(M,{onClick:Ne,disabled:!a||!l||v,className:"w-full","data-testid":"button-process-upload",children:[v&&e.jsx(ne,{className:"h-4 w-4 mr-2 animate-spin"}),v?"Processing Upload...":"Process Upload"]})]})})]}),o&&e.jsxs(F,{children:[e.jsx(R,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5 animate-spin"}),"Upload Progress"]})}),e.jsx(I,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(he,{value:o.processed/o.total*100,className:"w-full"}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:o.total}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:o.processed}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Processed"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:o.successful}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Successful"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:o.failed}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Failed"})]})]}),o.current&&e.jsxs("p",{className:"text-center text-sm text-muted-foreground",children:["Currently processing: ",o.current]})]})})]}),d&&e.jsxs(F,{children:[e.jsx(R,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5"}),"Upload Results"]})}),e.jsx(I,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:d.successful.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Successful"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:d.failed.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Failed"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:d.invalidUnits.length}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Invalid Units"})]})]}),d.successful.length>0&&e.jsx("div",{children:e.jsxs(M,{onClick:()=>s("/tenants"),className:"w-full","data-testid":"button-view-tenants",children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),"View Created Tenants"]})}),d.successful.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-green-600 mb-2",children:["✓ Successfully Created (",d.successful.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:d.successful.map((t,i)=>e.jsxs("div",{className:"text-sm p-2 bg-green-50 rounded",children:[e.jsxs("strong",{children:["Row ",t.row,":"]})," ",t.tenant," → Unit ",t.unit,"(Rent: KSh ",parseFloat(t.rent).toLocaleString(),")",t.balance!==0&&e.jsxs("span",{className:"ml-2 text-xs",children:["[",t.balanceType,": KSh ",Math.abs(t.balance).toLocaleString(),"]"]})]},i))})]}),d.failed.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-red-600 mb-2",children:["✗ Failed Records (",d.failed.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:d.failed.map((t,i)=>e.jsxs("div",{className:"text-sm p-2 bg-red-50 rounded",children:[e.jsxs("strong",{children:["Row ",t.row,":"]})," ",t.tenant," - ",t.error]},i))})]}),d.invalidUnits.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-orange-600 mb-2",children:["⚠ Invalid Unit Numbers (",d.invalidUnits.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-40 overflow-y-auto",children:d.invalidUnits.map((t,i)=>e.jsxs("div",{className:"text-sm p-2 bg-orange-50 rounded",children:[e.jsxs("strong",{children:["Row ",t.row,":"]})," ",t.tenant,' - Unit "',t.unitNumber,'" does not exist in selected property']},i))})]})]})})]})]})}export{tt as UploadData};
