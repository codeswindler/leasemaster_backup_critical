import{a as rt,u as it,b as ot,d as b,e as _e,f as B,j as t,x as v,ar as lt,O as ct,Q as dt,R as mt,V as ut,W as pt,X as ht,Y as xt,Z as yt,_ as jt,$ as gt,D as ft,aj as wt,P as Pe,g as Nt,h as vt,i as St,k as At,F as Ee,l as p,m as d,n as m,o as u,I as x,p as y,a4 as oe,L as G,S as Le,r as Fe,s as ke,v as Re,w as Ue,T as bt,C as Ct,G as Dt,aa as Tt,ab as It,ac as $e,ad as I,ae as _t,af as _,as as Pt,at as Et,a5 as Lt,y as Ft,ai as kt,a0 as f,q as P,t as qe,au as Rt}from"./index-D3-Phv8z.js";import{r as C,L as Ut,J as F,K as Ke}from"./vendor-BBpupLJz.js";import{c as $t,b as qt}from"./schema-ChL10cc-.js";import{D as Ve}from"./download-BIGyNlOu.js";import{U as Kt}from"./upload-f6bMxHtX.js";import{U as Vt}from"./undo-2-BRAlXuVT.js";function Qt(){const[k,Me]=C.useState(""),[Oe,Q]=C.useState(!1),[J,W]=C.useState(1),[le,ce]=C.useState(null),[E,de]=C.useState(""),[me,X]=C.useState({}),[w,U]=C.useState([]),{toast:o}=rt(),[,Y]=it(),Z=C.useRef(null),$=C.useRef({}),{selectedPropertyId:l,selectedLandlordId:c}=ot(),V=!l,{data:ue}=b({queryKey:["/api/auth/check"],queryFn:async()=>await(await f("GET","/api/auth/check")).json()}),D=ue?.authenticated?ue.user:null,He=D&&(D.role==="admin"||D.role==="super_admin"),pe=(()=>{if(!D?.permissions)return[];if(Array.isArray(D.permissions))return D.permissions;if(typeof D.permissions=="string")try{const e=JSON.parse(D.permissions);return Array.isArray(e)?e:[]}catch{return[]}return[]})(),ze=He||pe.includes("tenants.send_login")||pe.includes("tenants.bulk_send_login"),Be=async e=>{if(V){o({title:"Property Required",description:"Select a property in the header before importing tenants.",variant:"destructive"});return}const s=e.target.files?.[0];if(!s)return;if(!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","text/csv"].includes(s.type)){o({title:"Invalid File Type",description:"Please upload an Excel file (.xlsx, .xls) or CSV file.",variant:"destructive"});return}if(s.size>10*1024*1024){o({title:"File Too Large",description:"File size must be less than 10MB.",variant:"destructive"});return}try{const r=await s.arrayBuffer(),h=Ut(r,{type:"array"}),n=h.SheetNames[0],ie=h.Sheets[n],N=F.sheet_to_json(ie);if(N.length===0){o({title:"Empty File",description:"The uploaded file contains no data.",variant:"destructive"});return}let K=0,R=0;const H=[];for(let z=0;z<N.length;z++){const S=N[z],Ie=z+2;try{const i={fullName:S["Full Name"]||S.fullName||"",email:S.Email||S.email||"",phone:S.Phone||S.phone||"",idNumber:S["ID Number"]||S.idNumber||"",emergencyContact:S["Emergency Contact"]||"",emergencyPhone:S["Emergency Phone"]||""},T=[];if(i.fullName?.trim()||T.push("Full Name is required"),i.email?.trim()||T.push("Email is required"),i.phone?.trim()||T.push("Phone is required"),i.idNumber?.trim()||T.push("ID Number is required"),i.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i.email)&&T.push("Invalid email format"),i.phone&&!/^[\+]?[0-9\s\-\(\)]{10,}$/.test(i.phone)&&T.push("Invalid phone format"),T.length>0){H.push(`Row ${Ie}: ${T.join(", ")}`),R++;continue}i.fullName=i.fullName.trim(),i.email=i.email.trim().toLowerCase(),i.phone=i.phone.trim(),i.idNumber=i.idNumber.trim(),i.emergencyContact=i.emergencyContact?.trim()||"",i.emergencyPhone=i.emergencyPhone?.trim()||"",await f("POST","/api/tenants",i),K++}catch(i){H.push(`Row ${Ie}: ${i.message||"Unknown error"}`),R++}}P.invalidateQueries({queryKey:["/api/tenants"]}),K>0&&R===0?o({title:"Import Successful",description:`Successfully imported ${K} tenants.`}):K>0&&R>0?(o({title:"Partial Import",description:`Imported ${K} tenants. ${R} entries failed. Check console for details.`,variant:"destructive"}),console.error("Import validation errors:",H)):(o({title:"Import Failed",description:`No tenants imported. ${R} entries failed validation.`,variant:"destructive"}),console.error("Import validation errors:",H))}catch{o({title:"Import Failed",description:"Failed to read Excel file. Please check format and try again.",variant:"destructive"})}Z.current&&(Z.current.value="")},{data:he=[],isLoading:ee,error:te}=b({queryKey:["/api/tenants",l,c],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),c&&e.append("landlordId",c);const s=`/api/tenants${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()}}),{data:se=[]}=b({queryKey:["/api/properties",c,l],queryFn:async()=>{const e=new URLSearchParams;c&&e.append("landlordId",c),l&&e.append("propertyId",l);const s=`/api/properties${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()}}),{data:xe=[]}=b({queryKey:["/api/units",l,c],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),c&&e.append("landlordId",c);const s=`/api/units${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()}}),{data:ye=[]}=b({queryKey:["/api/house-types",l,c],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),c&&e.append("landlordId",c);const s=`/api/house-types${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()}}),{data:je=[]}=b({queryKey:["/api/leases",l,c],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),c&&e.append("landlordId",c);const s=`/api/leases${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()}}),{data:ge=[]}=b({queryKey:["/api/invoices",l,c],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),c&&e.append("landlordId",c);const s=`/api/invoices${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()}}),{data:fe=[]}=b({queryKey:["/api/payments",l,c],queryFn:async()=>{const e=new URLSearchParams;l&&e.append("propertyId",l),c&&e.append("landlordId",c);const s=`/api/payments${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()}}),{data:we=[]}=b({queryKey:["/api/charge-codes",E],queryFn:async()=>{const e=new URLSearchParams;E&&e.append("propertyId",E);const s=`/api/charge-codes${e.toString()?`?${e}`:""}`;return await(await f("GET",s)).json()},enabled:!!E}),j=_e({resolver:qe($t),defaultValues:{fullName:"",email:"",phone:"",idNumber:"",emergencyContact:"",emergencyPhone:"",secondaryContactName:"",secondaryContactPhone:"",secondaryContactEmail:"",notifySecondary:"false"}}),g=_e({resolver:qe(qt),defaultValues:{unitId:"",tenantId:"",startDate:"",endDate:"",rentAmount:"",depositAmount:"",waterRatePerUnit:"15.50"}}),q=B({mutationFn:async e=>{if(V)throw new Error("Select a property in the header to create tenants.");return f("POST","/api/tenants",e)},onSuccess:async e=>{P.invalidateQueries({queryKey:["/api/tenants"]}),o({title:"Success",description:"Tenant created successfully"});const s=await e.json();ce(s.id)},onError:e=>{o({title:"Error",description:e.message||"Failed to create tenant",variant:"destructive"})}}),ae=B({mutationFn:async e=>{if(V)throw new Error("Select a property in the header to create leases.");return f("POST","/api/leases",e)},onSuccess:()=>{P.invalidateQueries({queryKey:["/api/leases"]}),P.invalidateQueries({queryKey:["/api/tenants"]}),P.invalidateQueries({queryKey:["/api/units"]}),o({title:"Success",description:"Lease created successfully"}),Q(!1),W(1),ce(null),de(""),j.reset(),g.reset()},onError:e=>{o({title:"Error",description:e.message||"Failed to create lease",variant:"destructive"})}}),Ne=B({mutationFn:async e=>{if(V)throw new Error("Select a property in the header to delete tenants.");return f("DELETE",`/api/tenants/${e}`)},onSuccess:()=>{P.invalidateQueries({queryKey:["/api/tenants"]}),P.invalidateQueries({queryKey:["/api/leases"]}),P.invalidateQueries({queryKey:["/api/units"]}),o({title:"Success",description:"Tenant deleted successfully"})},onError:e=>{o({title:"Error",description:e.message||"Failed to delete tenant",variant:"destructive"})}}),M=e=>{const s=Number(e);return Number.isFinite(s)?s:0},ve=e=>{if(!e||e==="null")return{};if(typeof e=="string")try{const s=JSON.parse(e);return s&&typeof s=="object"?s:{}}catch{return{}}return typeof e=="object"?e:{}},ne=Array.isArray(xe)?xe.map(e=>({id:e.id,propertyId:e.propertyId??e.property_id,houseTypeId:e.houseTypeId??e.house_type_id,unitNumber:e.unitNumber??e.unit_number,rentAmount:e.rentAmount??e.rent_amount,rentDepositAmount:e.rentDepositAmount??e.rent_deposit_amount,waterRateAmount:e.waterRateAmount??e.water_rate_amount??e.water_rate_per_unit,chargeAmounts:ve(e.chargeAmounts??e.charge_amounts),status:e.status})):[],Ge=Array.isArray(ye)?ye.map(e=>({id:e.id,propertyId:e.propertyId??e.property_id,name:e.name,baseRentAmount:e.baseRentAmount??e.base_rent_amount,rentDepositAmount:e.rentDepositAmount??e.rent_deposit_amount,waterRateType:e.waterRateType??e.water_rate_type,waterRatePerUnit:e.waterRatePerUnit??e.water_rate_per_unit,waterFlatRate:e.waterFlatRate??e.water_flat_rate,chargeAmounts:ve(e.chargeAmounts??e.charge_amounts)})):[],O=Array.isArray(je)?je.map(e=>({id:e.id,unitId:e.unitId??e.unit_id,tenantId:e.tenantId??e.tenant_id,startDate:e.startDate??e.start_date,endDate:e.endDate??e.end_date,rentAmount:e.rentAmount??e.rent_amount,depositAmount:e.depositAmount??e.deposit_amount,waterRatePerUnit:e.waterRatePerUnit??e.water_rate_per_unit,status:e.status})):[],Se=Array.isArray(se)?se.map(e=>({id:e.id,name:e.name,address:e.address,status:e.status,landlordId:e.landlordId??e.landlord_id})):[],Qe=Array.isArray(ge)?ge.map(e=>({id:e.id,leaseId:e.leaseId??e.lease_id,amount:e.amount,issueDate:e.issueDate??e.issue_date,dueDate:e.dueDate??e.due_date,status:e.status,description:e.description,invoiceNumber:e.invoiceNumber??e.invoice_number})):[],Je=Array.isArray(fe)?fe.map(e=>({id:e.id,leaseId:e.leaseId??e.lease_id,invoiceId:e.invoiceId??e.invoice_id,amount:e.amount,paymentDate:e.paymentDate??e.payment_date,paymentMethod:e.paymentMethod??e.payment_method,reference:e.reference})):[],We=Array.isArray(we)?we.reduce((e,s)=>(e[s.id]=s,e),{}):{},Ae=Array.isArray(he)?he.map(e=>({id:e.id,fullName:e.fullName??e.full_name,email:e.email,phone:e.phone,idNumber:e.idNumber??e.id_number,emergencyContact:e.emergencyContact??e.emergency_contact,emergencyPhone:e.emergencyPhone??e.emergency_phone,secondaryContactName:e.secondaryContactName??e.secondary_contact_name,secondaryContactPhone:e.secondaryContactPhone??e.secondary_contact_phone,secondaryContactEmail:e.secondaryContactEmail??e.secondary_contact_email,notifySecondary:e.notifySecondary??e.notify_secondary,createdAt:e.createdAt??e.created_at})):[],re=Array.isArray(Ae)?Ae.map(e=>{const a=(Array.isArray(O)?O.filter(r=>r.tenantId===e.id):[]).find(r=>r.status==="active");if(a){const r=Array.isArray(ne)?ne.find(n=>n.id===a.unitId):null,h=Array.isArray(Se)?Se.find(n=>n.id===r?.propertyId):null;return{...e,lease:a,unit:r,property:h,status:a.status,rentAmount:a.rentAmount}}return{...e,lease:null,unit:null,property:null,status:"inactive",rentAmount:"0"}}):[],be=O.reduce((e,s)=>(e[s.id]=s,e),{}),L=re.reduce((e,s)=>(e[s.id]={invoices:0,payments:0},e),{});Qe.forEach(e=>{const s=be[e.leaseId];if(!s)return;const a=s.tenantId;L[a]||(L[a]={invoices:0,payments:0}),L[a].invoices+=M(e.amount)}),Je.forEach(e=>{const s=be[e.leaseId];if(!s)return;const a=s.tenantId;L[a]||(L[a]={invoices:0,payments:0}),L[a].payments+=M(e.amount)});const Xe=()=>{const e=[{"Full Name":"John Doe",Email:"john.doe@email.com",Phone:"+254700000000","ID Number":"12345678","Emergency Contact":"Jane Doe","Emergency Phone":"+254700000001"},{"Full Name":"Mary Smith",Email:"mary.smith@email.com",Phone:"+254700000002","ID Number":"87654321","Emergency Contact":"John Smith","Emergency Phone":"+254700000003"}],s=F.json_to_sheet(e);s["!cols"]=[{wch:20},{wch:25},{wch:15},{wch:12},{wch:20},{wch:15}];const a=F.book_new();F.book_append_sheet(a,s,"Tenant Template");const r="tenant_import_template.xlsx";Ke(a,r),o({title:"Template Downloaded",description:`Template downloaded as ${r}. Fill in your tenant data and import it back.`})},Ye=()=>{const e=re.map(n=>({"Full Name":n.fullName,Email:n.email,Phone:n.phone,"ID Number":n.idNumber,"Emergency Contact":n.emergencyContact||"","Emergency Phone":n.emergencyPhone||"","Created Date":n.createdAt?new Date(n.createdAt).toLocaleDateString():"","Lease Status":n.status||"Inactive",Property:n.property?.name||"Not Assigned","Unit Number":n.unit?.unitNumber||"Not Assigned","Unit Type":n.unit?.type||"","Rent Amount (KSH)":n.lease?.rentAmount||"0","Deposit Amount (KSH)":n.lease?.depositAmount||"0","Water Rate per Unit (KSH)":n.lease?.waterRatePerUnit||"15.50","Lease Start Date":n.lease?.startDate||"","Lease End Date":n.lease?.endDate||"","Property Address":n.property?.address||"","Property Status":n.property?.status||""})),s=F.json_to_sheet(e);s["!cols"]=Array(18).fill({wch:15});const a=F.book_new();F.book_append_sheet(a,s,"Tenants Data");const h=`tenants_export_${new Date().toISOString().split("T")[0]}.xlsx`;Ke(a,h),o({title:"Export Successful",description:`Tenants data exported to ${h}`})},A=re.filter(e=>e.fullName?.toLowerCase().includes(k.toLowerCase())||e.email?.toLowerCase().includes(k.toLowerCase())||e.unit?.unitNumber?.toLowerCase().includes(k.toLowerCase())||e.property?.name?.toLowerCase().includes(k.toLowerCase())),Ze=async()=>{if(await j.trigger()){const s=j.getValues();q.mutate(s),W(2)}},et=async()=>{if(await g.trigger()&&le){const s={...g.getValues(),tenantId:le};ae.mutate(s)}},tt=e=>{U(s=>s.includes(e)?s.filter(a=>a!==e):[...s,e])},Ce=()=>{w.length===A.length?U([]):U(A.map(e=>e.id))},st=()=>{if(w.filter(s=>{const a=A.find(r=>r.id===s);return a?.lease&&a.lease.status==="active"}).length>0){o({title:"Cannot Delete",description:"Some selected tenants have active leases and cannot be deleted.",variant:"destructive"});return}w.forEach(s=>{const a=A.find(r=>r.id===s);a&&nt(a)}),U([])},De=B({mutationFn:async e=>await(await f("POST","/api/tenants/bulk-send-login-details",{tenantIds:e,generateNewAccessCode:!0,sendSms:!0,sendEmail:!0})).json(),onSuccess:e=>{o({title:"Tenant login details sent",description:`Sent: ${e.sent||0}, Failed: ${e.failed||0}`}),U([])},onError:e=>{o({title:"Failed to send tenant login details",description:e?.message||"Please try again.",variant:"destructive"})}}),at=()=>{if(!w.length){o({title:"No tenants selected",description:"Select at least one tenant to send login details.",variant:"destructive"});return}De.mutate(w)},nt=e=>{$.current[e.id]&&clearTimeout($.current[e.id]);const s=setTimeout(()=>{Ne.mutate(e.id),delete $.current[e.id]},5e3);$.current[e.id]=s,o({title:"Delete scheduled",description:`${e.fullName} will be deleted in 5 seconds.`,action:t.jsxs(Rt,{altText:"Undo delete",onClick:()=>{clearTimeout(s),delete $.current[e.id],o({title:"Delete canceled",description:`${e.fullName} was not deleted.`})},children:[t.jsx(Vt,{className:"h-4 w-4 mr-1"}),"Undo"]})})},Te=ne.filter(e=>{const s=E?e.propertyId===E:!0,a=e.status==="vacant";return s&&a}).map(e=>{const s=Ge.find(a=>a.id===e.houseTypeId);return{...e,type:s?.name||"Unknown Type",houseType:s}});return t.jsxs("div",{className:"p-6 space-y-6",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-3xl font-bold","data-testid":"tenants-title",children:"Tenants"}),t.jsx("p",{className:"text-muted-foreground",children:"Manage tenant information and lease agreements"})]}),t.jsxs("div",{className:"flex gap-2",children:[w.length>0&&ze&&t.jsxs(v,{variant:"outline",onClick:at,disabled:De.isPending,children:[t.jsx(lt,{className:"h-4 w-4 mr-2"}),"Send Logins (",w.length,")"]}),w.length>0&&t.jsxs(ct,{children:[t.jsx(dt,{asChild:!0,children:t.jsxs(v,{variant:"destructive",disabled:Ne.isPending,children:[t.jsx(mt,{className:"h-4 w-4 mr-2"}),"Delete (",w.length,")"]})}),t.jsxs(ut,{children:[t.jsxs(pt,{children:[t.jsx(ht,{children:"Delete Selected Tenants"}),t.jsxs(xt,{children:["Are you sure you want to delete ",w.length," tenant(s)? Tenants with active leases cannot be deleted."]})]}),t.jsxs(yt,{children:[t.jsx(jt,{children:"Cancel"}),t.jsx(gt,{onClick:st,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete"})]})]})]}),t.jsxs(v,{variant:"outline",onClick:Xe,"data-testid":"button-download-template",children:[t.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Download Template"]}),t.jsxs(v,{variant:"outline",onClick:Ye,"data-testid":"button-export-tenants",children:[t.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Export Excel"]}),t.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:Be,style:{display:"none"},ref:Z,"data-testid":"input-file-import"}),t.jsxs(v,{variant:"outline",onClick:()=>Y("/upload-data"),"data-testid":"button-upload-data",children:[t.jsx(Kt,{className:"h-4 w-4 mr-2"}),"Upload Data"]}),t.jsxs(ft,{open:Oe,onOpenChange:Q,children:[t.jsx(wt,{asChild:!0,children:t.jsxs(v,{"data-testid":"button-add-tenant",children:[t.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Add Tenant"]})}),t.jsxs(Nt,{className:"sm:max-w-[900px] max-h-[85vh] overflow-y-auto",children:[t.jsxs(vt,{children:[t.jsx(St,{children:J===1?"Add New Tenant":"Allocate Unit"}),t.jsx(At,{children:J===1?"Enter tenant contact information and details.":"Assign a unit and create lease agreement."})]}),J===1?t.jsx(Ee,{...j,children:t.jsxs("form",{className:"grid gap-4 py-4 md:grid-cols-2",children:[t.jsx(p,{control:j.control,name:"fullName",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Full Name"}),t.jsx(u,{children:t.jsx(x,{placeholder:"e.g., John Doe","data-testid":"input-tenant-name",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"email",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Email Address"}),t.jsx(u,{children:t.jsx(x,{type:"email",placeholder:"john.doe@email.com","data-testid":"input-tenant-email",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"phone",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Phone Number"}),t.jsx(u,{children:t.jsx(x,{placeholder:"+254 712 345 678","data-testid":"input-tenant-phone",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"idNumber",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"ID/Passport Number"}),t.jsx(u,{children:t.jsx(x,{placeholder:"12345678","data-testid":"input-tenant-id",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"emergencyContact",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Emergency Contact Name"}),t.jsx(u,{children:t.jsx(x,{placeholder:"e.g., Jane Doe","data-testid":"input-emergency-contact",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"emergencyPhone",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Emergency Contact Phone"}),t.jsx(u,{children:t.jsx(x,{placeholder:"+254 700 000 001","data-testid":"input-emergency-phone",...e})}),t.jsx(y,{})]})}),t.jsx("div",{className:"border-t pt-3 text-sm text-muted-foreground md:col-span-2",children:"Secondary Contact"}),t.jsx(p,{control:j.control,name:"secondaryContactName",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Secondary Contact Name"}),t.jsx(u,{children:t.jsx(x,{placeholder:"e.g., John Smith","data-testid":"input-secondary-contact-name",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"secondaryContactPhone",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Secondary Contact Phone"}),t.jsx(u,{children:t.jsx(x,{placeholder:"+254 700 000 002","data-testid":"input-secondary-contact-phone",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"secondaryContactEmail",render:({field:e})=>t.jsxs(d,{className:"md:col-span-2",children:[t.jsx(m,{children:"Secondary Contact Email"}),t.jsx(u,{children:t.jsx(x,{type:"email",placeholder:"secondary@email.com","data-testid":"input-secondary-contact-email",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:j.control,name:"notifySecondary",render:({field:e})=>t.jsxs(d,{className:"flex items-center justify-between border rounded-md p-3 md:col-span-2",children:[t.jsxs("div",{children:[t.jsx(m,{children:"Send Notifications to Secondary Contact"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Enable updates for the secondary contact"})]}),t.jsx(u,{children:t.jsx(oe,{checked:e.value==="true",onCheckedChange:s=>e.onChange(s?"true":"false")})})]})}),t.jsxs("div",{className:"flex justify-end gap-2 md:col-span-2",children:[t.jsxs(v,{variant:"outline",type:"submit",disabled:q.isPending,children:[q.isPending&&t.jsx(G,{className:"h-4 w-4 mr-2 animate-spin"}),"Save & Close"]}),t.jsxs(v,{type:"button",onClick:Ze,"data-testid":"button-save-add-lease",disabled:q.isPending,children:[q.isPending&&t.jsx(G,{className:"h-4 w-4 mr-2 animate-spin"}),"Save & Add Lease"]})]})]})}):t.jsx(Ee,{...g,children:t.jsxs("form",{className:"grid gap-4 py-4",children:[t.jsxs(d,{children:[t.jsx(m,{children:"Property"}),t.jsx(u,{children:t.jsxs(Le,{value:E,onValueChange:e=>{de(e),g.setValue("unitId",""),X({})},"data-testid":"select-property",children:[t.jsx(Fe,{children:t.jsx(ke,{placeholder:"Select property"})}),t.jsx(Re,{children:se.map(e=>t.jsx(Ue,{value:e.id,children:e.name},e.id))})]})})]}),t.jsx(p,{control:g.control,name:"unitId",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Available Unit"}),t.jsx(u,{children:t.jsxs(Le,{...e,onValueChange:s=>{e.onChange(s);const a=Te.find(r=>r.id===s);if(a){const r=a.rentAmount??a.houseType?.baseRentAmount??"",h=a.rentDepositAmount??a.houseType?.rentDepositAmount??"",n=a.waterRateAmount??(a.houseType?.waterRateType==="unit_based"?a.houseType?.waterRatePerUnit:a.houseType?.waterFlatRate)??"15.50";g.setValue("rentAmount",r),g.setValue("depositAmount",h),g.setValue("waterRatePerUnit",n),X(a.chargeAmounts||{})}else X({})},"data-testid":"select-unit",children:[t.jsx(Fe,{children:t.jsx(ke,{placeholder:"Select unit"})}),t.jsx(Re,{children:Te.map(s=>t.jsxs(Ue,{value:s.id,children:[s.unitNumber," - ",s.type," (KSH ",M(s.rentAmount).toLocaleString(),")"]},s.id))})]})}),t.jsx(y,{})]})}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsx(p,{control:g.control,name:"startDate",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Lease Start Date"}),t.jsx(u,{children:t.jsx(x,{type:"date","data-testid":"input-lease-start",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:g.control,name:"endDate",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Lease End Date"}),t.jsx(u,{children:t.jsx(x,{type:"date","data-testid":"input-lease-end",...e})}),t.jsx(y,{})]})})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsx(p,{control:g.control,name:"rentAmount",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Monthly Rent (KSH)"}),t.jsx(u,{children:t.jsx(x,{type:"number",placeholder:"e.g., 20000","data-testid":"input-rent-amount",...e})}),t.jsx(y,{})]})}),t.jsx(p,{control:g.control,name:"depositAmount",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Security Deposit (KSH)"}),t.jsx(u,{children:t.jsx(x,{type:"number",placeholder:"e.g., 40000","data-testid":"input-deposit-amount",...e})}),t.jsx(y,{})]})})]}),t.jsx(p,{control:g.control,name:"waterRatePerUnit",render:({field:e})=>t.jsxs(d,{children:[t.jsx(m,{children:"Water Rate per Unit (KSH per m³)"}),t.jsx(u,{children:t.jsx(x,{type:"number",step:"0.01",placeholder:"e.g., 15.50","data-testid":"input-water-rate",...e})}),t.jsx(y,{})]})}),Object.keys(me).length>0&&t.jsxs("div",{className:"space-y-2 border rounded-lg p-3",children:[t.jsx("div",{className:"text-sm font-medium",children:"Unit Charge Codes"}),t.jsx("div",{className:"space-y-1 text-sm",children:Object.entries(me).map(([e,s])=>{const a=We[e];return t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-muted-foreground",children:a?.name||"Charge"}),t.jsxs("span",{className:"font-mono",children:["KSh ",M(s).toLocaleString()]})]},e)})})]}),t.jsxs("div",{className:"flex justify-end gap-2",children:[t.jsx(v,{variant:"outline",onClick:()=>W(1),children:"Back"}),t.jsxs(v,{type:"button",onClick:et,"data-testid":"button-create-lease",disabled:ae.isPending,children:[ae.isPending&&t.jsx(G,{className:"h-4 w-4 mr-2 animate-spin"}),"Create Lease"]})]})]})})]})]})]})]}),t.jsxs("div",{className:"flex gap-4 items-center",children:[t.jsx(x,{placeholder:"Search tenants...",value:k,onChange:e=>Me(e.target.value),className:"max-w-sm","data-testid":"input-search-tenants"}),A.length>0&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(oe,{checked:w.length===A.length&&A.length>0,onCheckedChange:Ce}),t.jsx("label",{className:"text-sm text-muted-foreground cursor-pointer",onClick:Ce,children:"Select All"})]})]}),ee&&t.jsxs("div",{className:"flex items-center justify-center py-12",children:[t.jsx(G,{className:"h-8 w-8 animate-spin"}),t.jsx("span",{className:"ml-2",children:"Loading tenants..."})]}),te&&t.jsxs("div",{className:"flex items-center justify-center py-12",children:[t.jsx(bt,{className:"h-8 w-8 text-destructive"}),t.jsx("span",{className:"ml-2 text-destructive",children:"Failed to load tenants"})]}),!ee&&!te&&t.jsx(Ct,{children:t.jsx(Dt,{className:"p-0",children:t.jsxs(Tt,{className:"table-fixed w-full",children:[t.jsx(It,{children:t.jsxs($e,{children:[t.jsx(I,{className:"w-12"}),t.jsx(I,{className:"w-64",children:"Tenant"}),t.jsx(I,{className:"w-36",children:"Phone"}),t.jsx(I,{className:"w-48",children:"Property"}),t.jsx(I,{className:"w-32",children:"Active Leases"}),t.jsx(I,{className:"w-48 text-right pr-6",children:"Balance"}),t.jsx(I,{className:"w-40 pl-6",children:"Status"}),t.jsx(I,{className:"w-28 text-right",children:"Actions"})]})}),t.jsx(_t,{children:A.map(e=>{const s=w.includes(e.id),a=L[e.id]||{invoices:0,payments:0},r=O.filter(N=>N.tenantId===e.id&&N.status==="active").length,h=a.invoices-a.payments,n=h<0?"text-green-600":h>0?"text-red-500":"text-muted-foreground",ie=h<0?`-KSh ${Math.abs(h).toLocaleString()}`:`KSh ${h.toLocaleString()}`;return t.jsxs($e,{className:`hover-elevate cursor-pointer ${s?"bg-muted/30":""}`,onClick:()=>Y(`/tenants/${e.id}`),children:[t.jsx(_,{onClick:N=>N.stopPropagation(),children:t.jsx(oe,{checked:s,onCheckedChange:()=>tt(e.id)})}),t.jsx(_,{children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(Pt,{children:t.jsx(Et,{children:e.fullName?.split(" ").map(N=>N[0]).join("")||"T"})}),t.jsxs("div",{children:[t.jsx("div",{className:"font-medium",children:e.fullName}),t.jsx("div",{className:"text-xs text-muted-foreground",children:e.email})]})]})}),t.jsx(_,{className:"text-sm",children:t.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[t.jsx(Lt,{className:"h-3 w-3"}),e.phone||"—"]})}),t.jsx(_,{className:"text-sm",children:e.property?.name||"No property"}),t.jsx(_,{className:"text-sm",children:r}),t.jsx(_,{className:`text-right font-mono pr-6 ${n}`,children:ie}),t.jsx(_,{className:"pl-6",children:t.jsx(Ft,{variant:e.status==="active"?"default":e.status==="overdue"?"destructive":"secondary",children:e.status})}),t.jsx(_,{className:"text-right",onClick:N=>N.stopPropagation(),children:t.jsx(v,{variant:"outline",size:"sm",onClick:()=>Y(`/tenants/${e.id}`),children:"Open"})})]},e.id)})})]})})}),!ee&&!te&&A.length===0&&t.jsxs("div",{className:"text-center py-12",children:[t.jsx(kt,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium mb-2",children:"No tenants found"}),t.jsx("p",{className:"text-muted-foreground mb-4",children:k?"Try adjusting your search terms":"Get started by adding your first tenant"}),t.jsxs(v,{onClick:()=>Q(!0),children:[t.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Add Tenant"]})]})]})}export{Qt as Tenants};
