import{a as X,b as J,d as g,j as e,C as I,G as R,x as v,aA as q,I as Z,S as ee,r as se,s as te,v as ae,w as $,z as ne,A as ie,E as re,ac as de,ad as oe,ae as M,af as l,ag as le,ah as c,H as ce,D as me,g as xe,h as ue,i as he,k as pe,K as d,ab as je,y as w,a0 as N}from"./index-BtknkMaH.js";import{r as P,Y as fe}from"./vendor-Dl_IvdXv.js";import{D as K}from"./download-ILkuwfnn.js";function ve(){const[D,G]=P.useState(""),[y,k]=P.useState("all"),[i,S]=P.useState(null),{toast:b}=X(),{selectedPropertyId:a,selectedLandlordId:n}=J(),x=g({queryKey:["/api/payments",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/payments${s.toString()?`?${s}`:""}`;return await(await N("GET",t)).json()}}),u=g({queryKey:["/api/tenants",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/tenants${s.toString()?`?${s}`:""}`;return await(await N("GET",t)).json()}}),h=g({queryKey:["/api/units",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/units${s.toString()?`?${s}`:""}`;return await(await N("GET",t)).json()}}),p=g({queryKey:["/api/properties",n,a],queryFn:async()=>{const s=new URLSearchParams;n&&s.append("landlordId",n),a&&s.append("propertyId",a);const t=`/api/properties${s.toString()?`?${s}`:""}`;return await(await N("GET",t)).json()}}),j=g({queryKey:["/api/leases",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/leases${s.toString()?`?${s}`:""}`;return await(await N("GET",t)).json()}}),f=g({queryKey:["/api/invoices",a,n],queryFn:async()=>{const s=new URLSearchParams;a&&s.append("propertyId",a),n&&s.append("landlordId",n);const t=`/api/invoices${s.toString()?`?${s}`:""}`;return await(await N("GET",t)).json()}}),Q=x.data||[],B=u.data||[],O=h.data||[],V=p.data||[],z=j.data||[],H=f.data||[],T=[x.status==="success",u.status==="success",h.status==="success",p.status==="success",j.status==="success",f.status==="success"].every(Boolean),C=[x.isLoading,u.isLoading,h.isLoading,p.isLoading,j.isLoading,f.isLoading].some(Boolean),Y=[x.error,u.error,h.error,p.error,j.error,f.error].some(Boolean),E=Q.map(s=>{const t=z.find(o=>o.id===s.leaseId),r=t&&t.tenantId?B.find(o=>o.id===t.tenantId):null,m=t&&t.unitId?O.find(o=>o.id===t.unitId):null,L=m&&m.propertyId?V.find(o=>o.id===m.propertyId):null,W=s.invoiceId?H.find(o=>o.id===s.invoiceId):null;return{id:`RCP-${s.id.slice(-8).toUpperCase()}`,paymentId:s.id,tenant:r?`${r.firstName||""} ${r.lastName||""}`.trim():"Direct Payment",unit:m?.number||"N/A",property:L?.name||"N/A",amount:s.amount||0,paymentDate:s.paymentDate,paymentMethod:s.paymentMethod||"Unknown",reference:s.reference||"N/A",status:s.status||"verified",tenantPhone:r?.phone||"",tenantEmail:r?.email||"",unitDetails:m,propertyDetails:L,leaseDetails:t,invoiceNumber:W?.invoiceNumber||"",description:s.description||"Payment received"}}),F=E.filter(s=>{if(!D.trim())return y==="all"||s.status===y;const t=D.toLowerCase(),r=s.id&&s.id.toLowerCase().includes(t)||s.tenant&&s.tenant.toLowerCase().includes(t)||s.unit&&s.unit.toLowerCase().includes(t)||s.reference&&s.reference.toLowerCase().includes(t),m=y==="all"||s.status===y;return r&&m}),A=s=>{try{const t=new fe;t.setFontSize(20),t.text("PAYMENT RECEIPT",20,30),t.setFontSize(12),t.text(`Receipt ID: ${s.id}`,20,50),t.text(`Date: ${new Date(s.paymentDate).toLocaleDateString()}`,20,60),t.text(`Reference: ${s.reference}`,20,70),t.text("TENANT INFORMATION:",20,90),t.text(`Name: ${s.tenant}`,30,100),t.text(`Phone: ${s.tenantPhone}`,30,110),t.text(`Email: ${s.tenantEmail}`,30,120),t.text("PROPERTY INFORMATION:",20,140),t.text(`Property: ${s.property}`,30,150),t.text(`Unit: ${s.unit}`,30,160),t.text("PAYMENT DETAILS:",20,180),t.text(`Amount: KSh ${s.amount.toLocaleString()}`,30,190),t.text(`Method: ${s.paymentMethod}`,30,200),t.text(`Status: ${s.status.toUpperCase()}`,30,210),t.text(`Description: ${s.description}`,30,220),s.invoiceNumber&&t.text(`Invoice: ${s.invoiceNumber}`,30,230),t.text("Thank you for your payment!",20,260),t.text(`Generated: ${new Date().toLocaleDateString()}`,20,270);const r=`Receipt_${s.id}_${s.tenant.replace(/\s+/g,"_")}.pdf`;t.save(r),b({title:"Receipt Downloaded",description:`${r} has been downloaded successfully`})}catch(t){console.error("Download error:",t),b({title:"Download Failed",description:"Failed to generate receipt PDF",variant:"destructive"})}},_=s=>{S(s)},U=s=>{switch(s){case"verified":return e.jsx(w,{variant:"default",className:"bg-green-100 text-green-800",children:"Verified"});case"pending":return e.jsx(w,{variant:"secondary",children:"Pending"});case"failed":return e.jsx(w,{variant:"destructive",children:"Failed"});default:return e.jsx(w,{variant:"outline",children:"Unknown"})}};return Y?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"receipts-title",children:"Receipts"}),e.jsx("p",{className:"text-muted-foreground",children:"Error loading receipt data"})]})}),e.jsx(I,{children:e.jsx(R,{className:"p-6",children:e.jsxs("div",{className:"text-center text-red-500 space-y-2",children:[e.jsx("div",{children:"Failed to load receipts data. Please try again."}),e.jsxs("div",{className:"text-sm",children:[x.error&&"• Payments data failed",u.error&&"• Tenants data failed",h.error&&"• Units data failed",p.error&&"• Properties data failed",j.error&&"• Leases data failed",f.error&&"• Invoices data failed"]})]})})})]}):C||!T?e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"receipts-title",children:"Receipts"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading payment receipts and related data..."})]})}),e.jsx(I,{children:e.jsx(R,{className:"p-6",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{children:"Loading receipts data..."}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[x.isLoading&&"• Loading payments...",u.isLoading&&"• Loading tenants...",h.isLoading&&"• Loading units...",p.isLoading&&"• Loading properties...",j.isLoading&&"• Loading leases...",f.isLoading&&"• Loading invoices...",!C&&!T&&"• Waiting for all data to be ready..."]})]})})})]}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold","data-testid":"receipts-title",children:"Receipts"}),e.jsx("p",{className:"text-muted-foreground",children:"View and manage payment receipts"})]}),e.jsxs(v,{"data-testid":"button-generate-receipt",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Generate Receipt"]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(Z,{placeholder:"Search receipts...",value:D,onChange:s=>G(s.target.value),className:"max-w-sm","data-testid":"input-search-receipts"})}),e.jsxs(ee,{value:y,onValueChange:k,children:[e.jsx(se,{className:"w-48","data-testid":"select-status-filter",children:e.jsx(te,{placeholder:"Filter by status"})}),e.jsxs(ae,{children:[e.jsx($,{value:"all",children:"All Statuses"}),e.jsx($,{value:"verified",children:"Verified"}),e.jsx($,{value:"pending",children:"Pending"})]})]})]}),e.jsxs(I,{children:[e.jsxs(ne,{children:[e.jsx(ie,{children:"Payment Receipts"}),e.jsxs(re,{children:["Showing ",F.length," of ",E.length," receipts"]})]}),e.jsx(R,{children:e.jsxs(de,{children:[e.jsx(oe,{children:e.jsxs(M,{children:[e.jsx(l,{children:"Receipt ID"}),e.jsx(l,{children:"Tenant"}),e.jsx(l,{children:"Unit"}),e.jsx(l,{children:"Amount"}),e.jsx(l,{children:"Payment Date"}),e.jsx(l,{children:"Method"}),e.jsx(l,{children:"Reference"}),e.jsx(l,{children:"Status"}),e.jsx(l,{children:"Actions"})]})}),e.jsx(le,{children:F.map(s=>e.jsxs(M,{className:"hover-elevate",children:[e.jsx(c,{className:"font-mono text-sm",children:s.id}),e.jsx(c,{className:"font-medium",children:s.tenant}),e.jsx(c,{children:s.unit}),e.jsxs(c,{className:"font-mono",children:["KSh ",s.amount.toLocaleString()]}),e.jsx(c,{children:new Date(s.paymentDate).toLocaleDateString()}),e.jsx(c,{children:s.paymentMethod}),e.jsx(c,{className:"font-mono text-sm",children:s.reference}),e.jsx(c,{children:U(s.status)}),e.jsx(c,{children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(v,{variant:"ghost",size:"sm","data-testid":`button-view-${s.id}`,onClick:()=>_(s),children:e.jsx(ce,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"sm","data-testid":`button-download-${s.id}`,onClick:()=>A(s),children:e.jsx(K,{className:"h-4 w-4"})})]})})]},s.id))})]})})]}),e.jsx(me,{open:!!i,onOpenChange:s=>!s&&S(null),children:e.jsxs(xe,{className:"max-w-md",children:[e.jsxs(ue,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"}),"Receipt Details"]}),e.jsx(pe,{children:"Payment receipt information"})]}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Receipt ID"}),e.jsx("p",{className:"font-mono text-sm",children:i.id})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Date"}),e.jsx("p",{className:"text-sm",children:new Date(i.paymentDate).toLocaleDateString()})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Tenant"}),e.jsx("p",{className:"font-medium",children:i.tenant}),i.tenantPhone&&e.jsx("p",{className:"text-sm text-muted-foreground",children:i.tenantPhone})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Property"}),e.jsx("p",{className:"text-sm",children:i.property})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Unit"}),e.jsx("p",{className:"text-sm",children:i.unit})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Amount"}),e.jsxs("p",{className:"text-lg font-mono font-bold",children:["KSh ",i.amount.toLocaleString()]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Payment Method"}),e.jsx("p",{className:"text-sm",children:i.paymentMethod})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Reference"}),e.jsx("p",{className:"font-mono text-sm",children:i.reference})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Status"}),e.jsx("div",{children:U(i.status)})]}),i.invoiceNumber&&e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Invoice"}),e.jsx("p",{className:"font-mono text-sm",children:i.invoiceNumber})]})]}),e.jsxs("div",{children:[e.jsx(d,{className:"text-sm font-medium text-muted-foreground",children:"Description"}),e.jsx("p",{className:"text-sm",children:i.description})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsxs(v,{onClick:()=>A(i),className:"flex-1","data-testid":"button-download-from-modal",children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Download PDF"]}),e.jsxs(v,{variant:"outline",onClick:()=>S(null),"data-testid":"button-close-modal",children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),"Close"]})]})]})]})})]})}export{ve as Receipts};
